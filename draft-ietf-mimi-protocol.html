<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>More Instant Messaging Interoperability (MIMI) using HTTPS and MLS</title>
<meta content="Richard L. Barnes" name="author">
<meta content="Matthew Hodgson" name="author">
<meta content="Konrad Kohbrok" name="author">
<meta content="Rohan Mahy" name="author">
<meta content="Travis Ralston" name="author">
<meta content="Raphael Robert" name="author">
<meta content="
       This document specifies the More Instant Messaging Interoperability (MIMI)
transport protocol, which allows users of different messaging providers to
interoperate in group chats (rooms), including to send and receive messages,
share room policy, and add participants to and remove participants from rooms.
MIMI describes messages between providers, leaving most aspects of the
provider-internal client-server communication up to the provider.  MIMI
integrates the Messaging Layer Security (MLS) protocol to provide end-to-end security
assurances, including authentication of protocol participants, confidentiality
of messages exchanged within a room, and agreement on the state of the room. 
    " name="description">
<meta content="xml2rfc 3.28.0" name="generator">
<meta content="mimi" name="keyword">
<meta content="interoperable messaging" name="keyword">
<meta content="chat" name="keyword">
<meta content="secure messaging" name="keyword">
<meta content="draft-ietf-mimi-protocol-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.28.0
    Python 3.12.9
    ConfigArgParse 1.7
    google-i18n-address 3.1.1
    intervaltree 3.1.0
    Jinja2 3.1.5
    lxml 5.3.0
    platformdirs 4.3.6
    pycountry 24.6.1
    PyYAML 6.0.2
    requests 2.32.3
    setuptools 70.3.0
    wcwidth 0.2.13
-->
<link href="draft-ietf-mimi-protocol.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-cyrillic.woff2') format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-greek.woff2') format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-greek.woff2') format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  --font-title: "Sofia Sans Semi Condensed", sans-serif;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
section {
  clear: both;
}
.section-number {
  padding-right: 0.5em;
}
h1, h2, h3, h4, h5, h6 {
  font-family: var(--font-title);
  font-weight: 680;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
  vertical-align: top;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
  & :is(ol, ul) {
    margin-left: 1em;
  }
}
li {
  margin: 0 0 0.25em 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
  & li {
    margin-top: 0.5em;
  }
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  margin: 0 0 0 2em;
  & li {
    margin: 0;
    & :first-child { margin-top: 0; }
    & :last-child { margin-bottom: 0; }
  }
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
  &.olPercent {
    --indent: 5ch;
    & > dt {
      min-width: calc(var(--indent) - 2ch);
    }
  }
  &.olPercent > dt {
    float: none;
  }

  dl > dd > & {
    margin-top: 0.5em;
    margin-bottom: 0;
  }
}
dl:not(.dlNewline) > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
  & > :is(:first-child, .break:first-child + *) {
    margin-top: 0;
  }
  & > :is(:last-child) {
    margin-bottom: 0;
  }
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
  caption-side: bottom;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    /* In the horizontal direction, sometimes people make over-sized figures.
       Scrollbars for those is therefore necessary: auto adds them as necessary..
       In the vertical direction, the line-height can combine with the font
       asender/descender height to produce scrollbars: hidden avoids that. */
    overflow: auto hidden;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: auto;
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
  &[href] {
    color: var(--pilcrow-weak);
    &:hover { text-decoration: none; }
  }
}
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
  & dt {
    width: var(--identifier-width);
    min-width: var(--identifier-width);
    clear: left;
    float: left;
    text-align: right;
    margin-right: 1ch;
  }
  & dd {
    margin: 0;
    margin-left: calc(1em + var(--identifier-width)) !important;
    min-width: 5em;
  }
  & .authors {
    & .author {
      display: inline-block;
      margin-right: 1.5em;
    }
    & .org {
      font-style: italic;
    }
  }
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;

  & nav {
    & ul {
      margin: 0 0.5em 0 0;
      padding: 0;
      list-style: none;
    }
    & li {
      line-height: 1.3em;
      margin: 2px 0;
      padding-left: 1.2em;
      text-indent: -1.2em;
    }
  }
  & a.xref {
    white-space: normal;
  }
}

.references {
  & > dt {
    text-align: right;
    font-weight: bold;
    min-width: 10ch;
    margin-right: 1.5ch;
    &:target::before {
      content: "⇒";
      margin: 0 10px 0 -25px;
    }
  }
  & > dd {
    margin-left: 12ch !important;
    overflow: visible;
    & .refInstance {
      margin-bottom: 0.8em;
    }
    & .ascii {
      margin-bottom: 0.25em;
    }
  }
}

#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  max-width: 20em;
  margin: 1em auto 1em 0;

  & .nameRole {
    font-weight: 700;
    margin-left: 0;
  }
  & .label {
    margin: 0.5em 0;
  }
  & .type {
    display: none;
  }
  & .alternative-contact {
    margin: 0.5em 0 0.25em 0;
  }
  & .non-ascii {
    margin: 0 0 0 2em;
  }
  & div.left {
    text-align: left;
  }
  & div.right {
    text-align: right;
  }
}

hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

/* Comments */
.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}

@media screen {
  #toc nav {
    font-family: var(--font-title);
    font-weight: 360;
    & > ul { margin-bottom: 2em; }
    & ul {
      margin: 0 0 0 4px;
      & :is(p, li) {
        margin: 2px 0;
      }
    }
  }
  #toc a.toplink {
    float: right;
  }
}
@media not screen {
  #toc a.toplink {
    display: none;
  }
}


/* TOC layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
    &::before { /* css hamburger */
      float: right;
      position: relative;
      width: 1em;
      height: 1px;
      left: -164px;
      margin: 8px 0 0 0;
      background: white none repeat scroll 0 0;
      box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
      content: "";
    }
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active {
    opacity: 1;
    & nav { display: block; }
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:is(:link, :focus, :hover),
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin: 2px 0.5em 0;
  }
}

/* TOC layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
  #toc a.toplink {
    margin: 8px 0.5em 0;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MIMI+MLS Protocol</td>
<td class="right">March 2025</td>
</tr></thead>
<tfoot><tr>
<td class="left">Barnes, et al.</td>
<td class="center">Expires 4 September 2025</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">More Instant Messaging Interoperability</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-mimi-protocol-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2025-03-03" class="published">3 March 2025</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2025-09-04">4 September 2025</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">R. L. Barnes</div>
<div class="org">Cisco</div>
</div>
<div class="author">
      <div class="author-name">M. Hodgson</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
<div class="author">
      <div class="author-name">K. Kohbrok</div>
<div class="org">Phoenix R&amp;D</div>
</div>
<div class="author">
      <div class="author-name">R. Mahy</div>
<div class="org">Rohan Mahy Consulting Services</div>
</div>
<div class="author">
      <div class="author-name">T. Ralston</div>
<div class="org">The Matrix.org Foundation C.I.C.</div>
</div>
<div class="author">
      <div class="author-name">R. Robert</div>
<div class="org">Phoenix R&amp;D</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">More Instant Messaging Interoperability (MIMI) using HTTPS and MLS</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document specifies the More Instant Messaging Interoperability (MIMI)
transport protocol, which allows users of different messaging providers to
interoperate in group chats (rooms), including to send and receive messages,
share room policy, and add participants to and remove participants from rooms.
MIMI describes messages between providers, leaving most aspects of the
provider-internal client-server communication up to the provider.  MIMI
integrates the Messaging Layer Security (MLS) protocol to provide end-to-end security
assurances, including authentication of protocol participants, confidentiality
of messages exchanged within a room, and agreement on the state of the room.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://bifurcation.github.io/ietf-mimi-protocol/draft-ralston-mimi-protocol.html">https://bifurcation.github.io/ietf-mimi-protocol/draft-ralston-mimi-protocol.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-ietf-mimi-protocol/">https://datatracker.ietf.org/doc/draft-ietf-mimi-protocol/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        More Instant Messaging Interoperability Working Group mailing list (<span><a href="mailto:mimi@ietf.org">mailto:mimi@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/mimi/">https://mailarchive.ietf.org/arch/browse/mimi/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/mimi/">https://www.ietf.org/mailman/listinfo/mimi/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/bifurcation/ietf-mimi-protocol">https://github.com/bifurcation/ietf-mimi-protocol</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 4 September 2025.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2025 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="auto internal xref">1.1</a>.  <a href="#name-known-gaps" class="internal xref">Known Gaps</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-example-protocol-flow" class="internal xref">Example protocol flow</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-alice-creates-a-room" class="internal xref">Alice Creates a Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-alice-adds-bob-to-the-room" class="internal xref">Alice adds Bob to the Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-bob-adds-cathy-to-the-room" class="internal xref">Bob adds Cathy to the Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-cathy-sends-a-message" class="internal xref">Cathy Sends a Message</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-bob-leaves-the-room" class="internal xref">Bob Leaves the Room</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.6">
                <p id="section-toc.1-1.3.2.6.1"><a href="#section-3.6" class="auto internal xref">3.6</a>.  <a href="#name-cathy-adds-a-new-device" class="internal xref">Cathy adds a new device</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-services-required-at-each-l" class="internal xref">Services required at each layer</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-transport-layer" class="internal xref">Transport layer</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-end-to-end-security-layer" class="internal xref">End-to-End Security Layer</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="auto internal xref">4.3</a>.  <a href="#name-application-layer" class="internal xref">Application Layer</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3.2.1">
                    <p id="section-toc.1-1.4.2.3.2.1.1"><a href="#section-4.3.1" class="auto internal xref">4.3.1</a>.  <a href="#name-server-state" class="internal xref">Server State</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3.2.2">
                    <p id="section-toc.1-1.4.2.3.2.2.1"><a href="#section-4.3.2" class="auto internal xref">4.3.2</a>.  <a href="#name-participant-list-changes" class="internal xref">Participant List Changes</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-mimi-endpoints-and-framing" class="internal xref">MIMI Endpoints and Framing</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-directory" class="internal xref">Directory</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="auto internal xref">5.2</a>.  <a href="#name-fetch-key-material" class="internal xref">Fetch Key Material</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="auto internal xref">5.3</a>.  <a href="#name-update-room-state" class="internal xref">Update Room State</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.4">
                <p id="section-toc.1-1.5.2.4.1"><a href="#section-5.4" class="auto internal xref">5.4</a>.  <a href="#name-submit-a-message" class="internal xref">Submit a Message</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.4.2.1">
                    <p id="section-toc.1-1.5.2.4.2.1.1"><a href="#section-5.4.1" class="auto internal xref">5.4.1</a>.  <a href="#name-message-franking" class="internal xref">Message Franking</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.5">
                <p id="section-toc.1-1.5.2.5.1"><a href="#section-5.5" class="auto internal xref">5.5</a>.  <a href="#name-fanout-messages-and-room-ev" class="internal xref">Fanout Messages and Room Events</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.6">
                <p id="section-toc.1-1.5.2.6.1"><a href="#section-5.6" class="auto internal xref">5.6</a>.  <a href="#name-claim-group-key-information" class="internal xref">Claim group key information</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.7">
                <p id="section-toc.1-1.5.2.7.1"><a href="#section-5.7" class="auto internal xref">5.7</a>.  <a href="#name-convey-explicit-consent" class="internal xref">Convey explicit consent</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.8">
                <p id="section-toc.1-1.5.2.8.1"><a href="#section-5.8" class="auto internal xref">5.8</a>.  <a href="#name-find-internal-address" class="internal xref">Find internal address</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.9">
                <p id="section-toc.1-1.5.2.9.1"><a href="#section-5.9" class="auto internal xref">5.9</a>.  <a href="#name-report-abuse" class="internal xref">Report abuse</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-minimal-metadata-rooms" class="internal xref">Minimal metadata rooms</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-credential-encryption" class="internal xref">Credential encryption</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-relation-between-mimi-state" class="internal xref">Relation between MIMI state and cryptographic state</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="auto internal xref">7.1</a>.  <a href="#name-room-state" class="internal xref">Room state</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="auto internal xref">7.2</a>.  <a href="#name-cryptographic-room-represen" class="internal xref">Cryptographic room representation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3" class="auto internal xref">7.3</a>.  <a href="#name-proposal-commit-paradigm" class="internal xref">Proposal-commit paradigm</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.4">
                <p id="section-toc.1-1.7.2.4.1"><a href="#section-7.4" class="auto internal xref">7.4</a>.  <a href="#name-authenticating-proposals" class="internal xref">Authenticating proposals</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.5">
                <p id="section-toc.1-1.7.2.5.1"><a href="#section-7.5" class="auto internal xref">7.5</a>.  <a href="#name-participant-list" class="internal xref">Participant List</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7.2.6">
                <p id="section-toc.1-1.7.2.6.1"><a href="#section-7.6" class="auto internal xref">7.6</a>.  <a href="#name-room-metadata" class="internal xref">Room Metadata</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-consent" class="internal xref">Consent</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="auto internal xref">9.1</a>.  <a href="#name-franking" class="internal xref">Franking</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1" class="auto internal xref">11.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-11.2" class="auto internal xref">11.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The More Instant Messaging Interoperability (MIMI) transport protocol enables providers of
end-to-end encrypted instant messaging to interoperate. As described in the MIMI
architecture <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>, group chats and direct messages are
described in terms of "rooms".  Each MIMI protocol room is hosted at a single
provider (the "hub" provider"), but allows users from different providers to
become participants in the room. The hub provider is responsible for ordering
and distributing messages, enforcing policy, and authorizing messages. It also
keeps a copy of the room state, which includes the room policy and participant
list, which it can provide to new joiners. Each provider also
stores initial keying material for its own users (who may be offline).<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">This document describes the communication among different providers necessary to
support messaging application functionality, for example:<a href="#section-1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1-3.1">
          <p id="section-1-3.1.1">Sharing room policy<a href="#section-1-3.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-1-3.2">
          <p id="section-1-3.2.1">Adding and removing participants in a room<a href="#section-1-3.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-1-3.3">
          <p id="section-1-3.3.1">Exchanging secure messages<a href="#section-1-3.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-1-4">In support of these functions, the protocol also has primitives to fetch initial
keying material and fetch the current state of the underlying end-to-end encryption
protocol for the room.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">Messages sent inside each room are end-to-end encrypted using the Messaging
Layer Security (MLS) protocol <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>, and each room is associated with an
MLS group. MLS also ensures that clients in a room agree on the room policy and
participation.  MLS is integrated into MIMI in such a way as to ensure that a
client is joined to a room's MLS group only if the client's user is a
participant in the room, and that all clients in the group agree on the state
of the room (including, for example, the room's participant list).<a href="#section-1-5" class="pilcrow">¶</a></p>
<div id="known-gaps">
<section id="section-1.1">
        <h3 id="name-known-gaps">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-known-gaps" class="section-name selfRef">Known Gaps</a>
        </h3>
<p id="section-1.1-1">In this version of the document, we have tried to capture enough concrete
functionality to enable basic application functionality, while defining enough
of a protocol framework to indicate how to add other necessary functionality.
The following functions are likely to be needed by the complete protocol, but
are not covered here:<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-1.1-2">
          <dt id="section-1.1-2.1">Authorization policy:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.2">
            <p id="section-1.1-2.2.1">In this document, we introduce a notional concept of roles for
participants, and permissions for roles. Concrete authorization policies
are defined in <span>[<a href="#I-D.ietf-mimi-room-policy" class="cite xref">I-D.ietf-mimi-room-policy</a>]</span>.<a href="#section-1.1-2.2.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.3">Knock and invite flows:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.4">
            <p id="section-1.1-2.4.1">This document describes how user can be added, or how authorized users can
add themselves to a group based on the policy of the room. It does not include
flows where a user can "knock" to ask to enter a room, nor does it
include "invitations", where a user offers information to another user about
how to be added to a room.<a href="#section-1.1-2.4.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.5">Identifiers:</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.6">
            <p id="section-1.1-2.6.1">Certain entities in the MIMI system need to be identified in the protocol.  In
this document, we define a notional syntax for identifiers, but a more
concrete one should be defined.<a href="#section-1.1-2.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-1.1-2.7">Authentication</dt>
          <dd style="margin-left: 1.5em" id="section-1.1-2.8">
            <p id="section-1.1-2.8.1">While MLS provides basic message authentication, users should also be able
to (cryptographically) tie the identity of other users to their respective
providers. Further authentication such as tying clients to their users (or the
user's other clients) may also be desirable.<a href="#section-1.1-2.8.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">Terms and definitions are inherited from <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>.  We also
make use of terms from the MLS protocol <span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span>.<a href="#section-2-2" class="pilcrow">¶</a></p>
<p id="section-2-3">Throughout this document, the examples use the TLS Presentation Language
<span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> and the semantics of HTTP <span>[<a href="#RFC7231" class="cite xref">RFC7231</a>]</span> respectively as
placeholder a set of binary encoding mechanism and transport semantics.<a href="#section-2-3" class="pilcrow">¶</a></p>
<p id="section-2-4">The protocol layering of the MIMI transport protocol is as follows:<a href="#section-2-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-2-5">
<li id="section-2-5.1">
          <p id="section-2-5.1.1">An application layer that enables messaging functionality<a href="#section-2-5.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-2-5.2">
          <p id="section-2-5.2.1">A security layer that provides end-to-end security guarantees:<a href="#section-2-5.2.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-5.2.2.1">
              <p id="section-2-5.2.2.1.1">Confidentiality for messages<a href="#section-2-5.2.2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-2-5.2.2.2">
              <p id="section-2-5.2.2.2.1">Authentication of actors making changes to rooms<a href="#section-2-5.2.2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-2-5.2.2.3">
              <p id="section-2-5.2.2.3.1">Agreement on room state across the clients involved in a room<a href="#section-2-5.2.2.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</li>
        <li id="section-2-5.3">
          <p id="section-2-5.3.1">A transport layer that provides secure delivery of protocol objects between
servers.<a href="#section-2-5.3.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<span id="name-mimi-protocol-layering"></span><div id="fig-layers">
<figure id="figure-1">
        <div id="section-2-6.1">
          <div class="alignLeft art-svg artwork" id="section-2-6.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="144" width="216" viewBox="0 0 216 144" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
              <path d="M 8,32 L 8,128" fill="none" stroke="black"></path>
              <path d="M 72,64 L 72,96" fill="none" stroke="black"></path>
              <path d="M 208,32 L 208,128" fill="none" stroke="black"></path>
              <path d="M 8,32 L 208,32" fill="none" stroke="black"></path>
              <path d="M 72,64 L 208,64" fill="none" stroke="black"></path>
              <path d="M 8,96 L 208,96" fill="none" stroke="black"></path>
              <path d="M 8,128 L 208,128" fill="none" stroke="black"></path>
              <g class="text">
                <text x="112" y="52">Application</text>
                <text x="104" y="84">E2E</text>
                <text x="156" y="84">Security</text>
                <text x="112" y="116">Transport</text>
              </g>
            </svg><a href="#section-2-6.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-mimi-protocol-layering" class="selfRef">MIMI protocol layering</a>
        </figcaption></figure>
</div>
<p id="section-2-7">MIMI uses MLS for end-to-end security, using the MLS AppSync proposal type to
efficiently synchronize room state across the clients involved in a room
<span>[<a href="#RFC9420" class="cite xref">RFC9420</a>]</span> <span>[<a href="#I-D.barnes-mls-appsync" class="cite xref">I-D.barnes-mls-appsync</a>]</span>. The MIMI transport is based on HTTPS
over mutually-authenticated TLS.<a href="#section-2-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="example-protocol-flow">
<section id="section-3">
      <h2 id="name-example-protocol-flow">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-example-protocol-flow" class="section-name selfRef">Example protocol flow</a>
      </h2>
<p id="section-3-1">This section walks through a basic scenario that illustrates how a room works
in the MIMI protocol.  The scenario involves the following actors:<a href="#section-3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.1">
          <p id="section-3-2.1.1">Service providers <code>a.example</code>, <code>b.example</code>, and <code>c.example</code> represented by
servers <code>ServerA</code>, <code>ServerB</code>, and <code>ServerC</code> respectively<a href="#section-3-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.2">
          <p id="section-3-2.2.1">Users Alice (<code>alice</code>), Bob (<code>bob</code>) and Cathy (<code>cathy</code>) of the service providers <code>a.example</code>, <code>b.example</code>, and <code>c.example</code> respectively.<a href="#section-3-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.3">
          <p id="section-3-2.3.1">Clients <code>ClientA1</code>, <code>ClientA2</code>, <code>ClientB1</code>, etc. belonging to these users<a href="#section-3-2.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-2.4">
          <p id="section-3-2.4.1">A room <code>clubhouse</code> hosted by hub provider <code>a.example</code> where the three users interact.<a href="#section-3-2.4.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-3-3">Inside the protocol, each provider is represented by a domain name in the
<code>host</code> production of the <code>authority</code> of a MIMI URI <span>[<a href="#RFC3986" class="cite xref">RFC3986</a>]</span>. Specific
hosts or servers are represented by domain names, but not by MIMI URIs.
Examples of different types of identifiers represented in a MIMI URI are
shown in the table below:<a href="#section-3-3" class="pilcrow">¶</a></p>
<span id="name-mimi-uri-examples"></span><div id="mimi-uri-examples">
<table class="center" id="table-1">
        <caption>
<a href="#table-1" class="selfRef">Table 1</a>:
<a href="#name-mimi-uri-examples" class="selfRef">MIMI URI examples</a>
        </caption>
<thead>
          <tr>
            <th class="text-left" rowspan="1" colspan="1">Identifier type</th>
            <th class="text-left" rowspan="1" colspan="1">Example URI</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">Provider</td>
            <td class="text-left" rowspan="1" colspan="1">
              <code>mimi://a.example</code>
</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">User</td>
            <td class="text-left" rowspan="1" colspan="1">
              <code>mimi://a.example/u/alice</code>
</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">Client</td>
            <td class="text-left" rowspan="1" colspan="1">
              <code>mimi://a.example/d/ClientA1</code>
</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">Room</td>
            <td class="text-left" rowspan="1" colspan="1">
              <code>mimi://a.example/r/clubhouse</code>
</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">MLS group</td>
            <td class="text-left" rowspan="1" colspan="1">
              <code>mimi://a.example/g/clubhouse</code>
</td>
          </tr>
        </tbody>
      </table>
</div>
<p id="section-3-5">As noted in <span>[<a href="#I-D.barnes-mimi-arch" class="cite xref">I-D.barnes-mimi-arch</a>]</span>, the MIMI protocol only defines interactions
between service providers' servers.  Interactions between clients and servers
within a service provider domain are shown here for completeness, but
surrounded by <code>[[ double brackets ]]</code>.<a href="#section-3-5" class="pilcrow">¶</a></p>
<div id="alice-creates-a-room">
<section id="section-3.1">
        <h3 id="name-alice-creates-a-room">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-alice-creates-a-room" class="section-name selfRef">Alice Creates a Room</a>
        </h3>
<p id="section-3.1-1">The first step in the lifetime of a MIMI room is its creation on the hub server.
This operation is local to the service provider, and does not entail any MIMI
protocol operations.  However, it must establish the initial state of the room,
which is then the basis for protocol operations related to the room.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">For authorization purposes, MIMI uses permissions based on room-defined roles.
For example, a room might have a role named "admin", which has <code>canAddUser</code>,
<code>canRemoveUser</code>, and <code>canSetUserRole</code> permisions.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<p id="section-3.1-3">Here, we assume that Alice uses ClientA1 to create a room with the following
base policy properties:<a href="#section-3.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-4.1">
            <p id="section-3.1-4.1.1">Room Identifier: <code>mimi://a.example/r/clubhouse</code><a href="#section-3.1-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.1-4.2">
            <p id="section-3.1-4.2.1">Roles: <code>admin = [canAddUser, canRemoveUser, canSetUserRole]</code><a href="#section-3.1-4.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.1-5">And the following participant list:<a href="#section-3.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1-6.1">
            <p id="section-3.1-6.1.1">Participants: <code>[[mimi://a.example/u/alice, "admin"]]</code><a href="#section-3.1-6.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.1-7">ClientA1 also creates an MLS group with group ID <code>mimi://a.example/g/clubhouse</code> and
ensures via provider-local operations that Alice's other clients are members of
this MLS group.<a href="#section-3.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="alice-adds-bob-to-the-room">
<section id="section-3.2">
        <h3 id="name-alice-adds-bob-to-the-room">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-alice-adds-bob-to-the-room" class="section-name selfRef">Alice adds Bob to the Room</a>
        </h3>
<p id="section-3.2-1">Adding Bob to the room entails operations at two levels.  First, Bob's user
identity must be added to the room's participant list.  Second, Bob's clients
must be added to the room's MLS group.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">The process of adding Bob to the room thus begins by Alice fetching key material
for Bob's clients.  Alice then updates the room by sending an MLS Commit over
the following proposals:<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2-3.1">
            <p id="section-3.2-3.1.1">An AppSync proposal updating the room state by adding Bob to the
participant list<a href="#section-3.2-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.2-3.2">
            <p id="section-3.2-3.2.1">Add proposals for Bob's clients<a href="#section-3.2-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.2-4">The MIMI protocol interactions are between Alice's server ServerA and Bob's
server ServerB.  ServerB stores KeyPackages on behalf of Bob's devices.  ServerA
performs the key material fetch on Alice's behalf, and delivers the resulting
KeyPackages to Alice's clients.  Both ServerA and ServerB remember the sources
of the KeyPackages they handle, so that they can route a Welcome message for
those KeyPackages to the proper recipients -- ServerA to ServerB, and ServerB to
Bob's clients.<a href="#section-3.2-4" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-3.2-5.1">
            <p id="section-3.2-5.1.1"><strong>NOTE:</strong> In the protocol, it is necessary to have consent (see <a href="#consent" class="auto internal xref">Section 8</a>)
and access control on these operations.  We have elided that step here in
the interest of simplicity.<a href="#section-3.2-5.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<span id="name-alice-fetches-keypackages-f"></span><div id="fig-ab-kp-fetch">
<figure id="figure-2">
          <div id="section-3.2-6.1">
            <div class="alignLeft art-svg artwork" id="section-3.2-6.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="368" width="496" viewBox="0 0 496 368" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,208" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,208" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,208" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,208" fill="none" stroke="black"></path>
                <path d="M 288,80 Q 290,76.8 292,80 Q 294,83.2 296,80 Q 298,76.8 300,80 Q 302,83.2 304,80 Q 306,76.8 308,80 Q 310,83.2 312,80 Q 314,76.8 316,80 Q 318,83.2 320,80 Q 322,76.8 324,80 Q 326,83.2 328,80 Q 330,76.8 332,80 Q 334,83.2 336,80 Q 338,76.8 340,80 Q 342,83.2 344,80 Q 346,76.8 348,80 Q 350,83.2 352,80 Q 354,76.8 356,80 Q 358,83.2 360,80 Q 362,76.8 364,80 Q 366,83.2 368,80 Q 370,76.8 372,80 Q 374,83.2 376,80 Q 378,76.8 380,80 Q 382,83.2 384,80 Q 386,76.8 388,80 Q 390,83.2 392,80 Q 394,76.8 396,80 Q 398,83.2 400,80 Q 402,76.8 404,80 Q 406,83.2 408,80" fill="none" stroke="black"></path>
                <path d="M 288,96 Q 290,92.8 292,96 Q 294,99.2 296,96 Q 298,92.8 300,96 Q 302,99.2 304,96 Q 306,92.8 308,96 Q 310,99.2 312,96 Q 314,92.8 316,96 Q 318,99.2 320,96 Q 322,92.8 324,96 Q 326,99.2 328,96 Q 330,92.8 332,96 Q 334,99.2 336,96 Q 338,92.8 340,96 Q 342,99.2 344,96 Q 346,92.8 348,96 Q 350,99.2 352,96 Q 354,92.8 356,96 Q 358,99.2 360,96 Q 362,92.8 364,96 Q 366,99.2 368,96 Q 370,92.8 372,96 Q 374,99.2 376,96 Q 378,92.8 380,96 Q 382,99.2 384,96 Q 386,92.8 388,96 Q 390,99.2 392,96 Q 394,92.8 396,96 Q 398,99.2 400,96 Q 402,92.8 404,96 Q 406,99.2 408,96" fill="none" stroke="black"></path>
                <path d="M 24,128 Q 26,124.8 28,128 Q 30,131.2 32,128 Q 34,124.8 36,128 Q 38,131.2 40,128 Q 42,124.8 44,128 Q 46,131.2 48,128 Q 50,124.8 52,128 Q 54,131.2 56,128 Q 58,124.8 60,128 Q 62,131.2 64,128 Q 66,124.8 68,128 Q 70,131.2 72,128 Q 74,124.8 76,128 Q 78,131.2 80,128 Q 82,124.8 84,128 Q 86,131.2 88,128 Q 90,124.8 92,128 Q 94,131.2 96,128 Q 98,124.8 100,128 Q 102,131.2 104,128 Q 106,124.8 108,128 Q 110,131.2 112,128 Q 114,124.8 116,128 Q 118,131.2 120,128 Q 122,124.8 124,128 Q 126,131.2 128,128 Q 130,124.8 132,128 Q 134,131.2 136,128 Q 138,124.8 140,128 Q 142,131.2 144,128" fill="none" stroke="black"></path>
                <path d="M 152,144 L 272,144" fill="none" stroke="black"></path>
                <path d="M 160,176 L 280,176" fill="none" stroke="black"></path>
                <path d="M 32,192 Q 34,188.8 36,192 Q 38,195.2 40,192 Q 42,188.8 44,192 Q 46,195.2 48,192 Q 50,188.8 52,192 Q 54,195.2 56,192 Q 58,188.8 60,192 Q 62,195.2 64,192 Q 66,188.8 68,192 Q 70,195.2 72,192 Q 74,188.8 76,192 Q 78,195.2 80,192 Q 82,188.8 84,192 Q 86,195.2 88,192 Q 90,188.8 92,192 Q 94,195.2 96,192 Q 98,188.8 100,192 Q 102,195.2 104,192 Q 106,188.8 108,192 Q 110,195.2 112,192 Q 114,188.8 116,192 Q 118,195.2 120,192 Q 122,188.8 124,192 Q 126,195.2 128,192 Q 130,188.8 132,192 Q 134,195.2 136,192 Q 138,188.8 140,192 Q 142,195.2 144,192 Q 146,188.8 148,192 Q 150,195.2 152,192" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="296,96 284,90.4 284,101.6" fill="black" transform="rotate(180,288,96)"></polygon>
                <polygon class="arrowhead" points="296,80 284,74.4 284,85.6" fill="black" transform="rotate(180,288,80)"></polygon>
                <polygon class="arrowhead" points="280,144 268,138.4 268,149.6" fill="black" transform="rotate(0,272,144)"></polygon>
                <polygon class="arrowhead" points="168,176 156,170.4 156,181.6" fill="black" transform="rotate(180,160,176)"></polygon>
                <polygon class="arrowhead" points="152,128 140,122.4 140,133.6" fill="black" transform="rotate(0,144,128)"></polygon>
                <polygon class="arrowhead" points="40,192 28,186.4 28,197.6" fill="black" transform="rotate(180,32,192)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientA1</text>
                  <text x="152" y="36">ServerA</text>
                  <text x="280" y="36">ServerB</text>
                  <text x="412" y="36">ClientB*</text>
                  <text x="344" y="68">Store</text>
                  <text x="384" y="68">KPs</text>
                  <text x="64" y="116">Request</text>
                  <text x="112" y="116">KPs</text>
                  <text x="212" y="132">/keyMaterial</text>
                  <text x="232" y="164">200</text>
                  <text x="260" y="164">OK</text>
                  <text x="128" y="180">KPs</text>
                  <text x="76" y="244">ClientB*-&gt;ServerB:</text>
                  <text x="164" y="244">[[</text>
                  <text x="200" y="244">Store</text>
                  <text x="272" y="244">KeyPackages</text>
                  <text x="332" y="244">]]</text>
                  <text x="76" y="260">ClientA1-&gt;ServerA:</text>
                  <text x="164" y="260">[[</text>
                  <text x="208" y="260">request</text>
                  <text x="256" y="260">KPs</text>
                  <text x="288" y="260">for</text>
                  <text x="320" y="260">Bob</text>
                  <text x="348" y="260">]]</text>
                  <text x="72" y="276">ServerA-&gt;ServerB:</text>
                  <text x="164" y="276">POST</text>
                  <text x="236" y="276">/keyMaterial</text>
                  <text x="364" y="276">KeyMaterialRequest</text>
                  <text x="36" y="292">ServerB:</text>
                  <text x="100" y="292">Verify</text>
                  <text x="148" y="292">that</text>
                  <text x="192" y="292">Alice</text>
                  <text x="228" y="292">is</text>
                  <text x="284" y="292">authorized</text>
                  <text x="340" y="292">to</text>
                  <text x="376" y="292">fetch</text>
                  <text x="448" y="292">KeyPackages</text>
                  <text x="36" y="308">ServerB:</text>
                  <text x="92" y="308">Mark</text>
                  <text x="148" y="308">returned</text>
                  <text x="200" y="308">KPs</text>
                  <text x="228" y="308">as</text>
                  <text x="276" y="308">reserved</text>
                  <text x="328" y="308">for</text>
                  <text x="376" y="308">Alice's</text>
                  <text x="424" y="308">use</text>
                  <text x="72" y="324">ServerB-&gt;ServerA:</text>
                  <text x="160" y="324">200</text>
                  <text x="188" y="324">OK</text>
                  <text x="280" y="324">KeyMaterialResponse</text>
                  <text x="36" y="340">ServerA:</text>
                  <text x="108" y="340">Remember</text>
                  <text x="164" y="340">that</text>
                  <text x="208" y="340">these</text>
                  <text x="248" y="340">KPs</text>
                  <text x="276" y="340">go</text>
                  <text x="300" y="340">to</text>
                  <text x="352" y="340">b.example</text>
                  <text x="76" y="356">ServerA-&gt;ClientA1:</text>
                  <text x="164" y="356">[[</text>
                  <text x="192" y="356">KPs</text>
                  <text x="220" y="356">]]</text>
                </g>
              </svg><a href="#section-3.2-6.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-alice-fetches-keypackages-f" class="selfRef">Alice Fetches KeyPackages for Bob's Clients</a>
          </figcaption></figure>
</div>
<span id="name-alice-adds-bob-to-the-room-"></span><div id="fig-ab-add">
<figure id="figure-3">
          <div id="section-3.2-7.1">
            <div class="alignLeft art-svg artwork" id="section-3.2-7.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="336" width="672" viewBox="0 0 672 336" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,176" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,176" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,176" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,176" fill="none" stroke="black"></path>
                <path d="M 24,80 Q 26,76.8 28,80 Q 30,83.2 32,80 Q 34,76.8 36,80 Q 38,83.2 40,80 Q 42,76.8 44,80 Q 46,83.2 48,80 Q 50,76.8 52,80 Q 54,83.2 56,80 Q 58,76.8 60,80 Q 62,83.2 64,80 Q 66,76.8 68,80 Q 70,83.2 72,80 Q 74,76.8 76,80 Q 78,83.2 80,80 Q 82,76.8 84,80 Q 86,83.2 88,80 Q 90,76.8 92,80 Q 94,83.2 96,80 Q 98,76.8 100,80 Q 102,83.2 104,80 Q 106,76.8 108,80 Q 110,83.2 112,80 Q 114,76.8 116,80 Q 118,83.2 120,80 Q 122,76.8 124,80 Q 126,83.2 128,80 Q 130,76.8 132,80 Q 134,83.2 136,80 Q 138,76.8 140,80 Q 142,83.2 144,80" fill="none" stroke="black"></path>
                <path d="M 32,112 Q 34,108.8 36,112 Q 38,115.2 40,112 Q 42,108.8 44,112 Q 46,115.2 48,112 Q 50,108.8 52,112 Q 54,115.2 56,112 Q 58,108.8 60,112 Q 62,115.2 64,112 Q 66,108.8 68,112 Q 70,115.2 72,112 Q 74,108.8 76,112 Q 78,115.2 80,112 Q 82,108.8 84,112 Q 86,115.2 88,112 Q 90,108.8 92,112 Q 94,115.2 96,112 Q 98,108.8 100,112 Q 102,115.2 104,112 Q 106,108.8 108,112 Q 110,115.2 112,112 Q 114,108.8 116,112 Q 118,115.2 120,112 Q 122,108.8 124,112 Q 126,115.2 128,112 Q 130,108.8 132,112 Q 134,115.2 136,112 Q 138,108.8 140,112 Q 142,115.2 144,112 Q 146,108.8 148,112 Q 150,115.2 152,112" fill="none" stroke="black"></path>
                <path d="M 152,112 L 272,112" fill="none" stroke="black"></path>
                <path d="M 160,144 L 280,144" fill="none" stroke="black"></path>
                <path d="M 280,144 Q 282,140.8 284,144 Q 286,147.2 288,144 Q 290,140.8 292,144 Q 294,147.2 296,144 Q 298,140.8 300,144 Q 302,147.2 304,144 Q 306,140.8 308,144 Q 310,147.2 312,144 Q 314,140.8 316,144 Q 318,147.2 320,144 Q 322,140.8 324,144 Q 326,147.2 328,144 Q 330,140.8 332,144 Q 334,147.2 336,144 Q 338,140.8 340,144 Q 342,147.2 344,144 Q 346,140.8 348,144 Q 350,147.2 352,144 Q 354,140.8 356,144 Q 358,147.2 360,144 Q 362,140.8 364,144 Q 366,147.2 368,144 Q 370,140.8 372,144 Q 374,147.2 376,144 Q 378,140.8 380,144 Q 382,147.2 384,144 Q 386,140.8 388,144 Q 390,147.2 392,144 Q 394,140.8 396,144 Q 398,147.2 400,144" fill="none" stroke="black"></path>
                <path d="M 280,160 Q 282,156.8 284,160 Q 286,163.2 288,160 Q 290,156.8 292,160 Q 294,163.2 296,160 Q 298,156.8 300,160 Q 302,163.2 304,160 Q 306,156.8 308,160 Q 310,163.2 312,160 Q 314,156.8 316,160 Q 318,163.2 320,160 Q 322,156.8 324,160 Q 326,163.2 328,160 Q 330,156.8 332,160 Q 334,163.2 336,160 Q 338,156.8 340,160 Q 342,163.2 344,160 Q 346,156.8 348,160 Q 350,163.2 352,160 Q 354,156.8 356,160 Q 358,163.2 360,160 Q 362,156.8 364,160 Q 366,163.2 368,160 Q 370,156.8 372,160 Q 374,163.2 376,160 Q 378,156.8 380,160 Q 382,163.2 384,160 Q 386,156.8 388,160 Q 390,163.2 392,160 Q 394,156.8 396,160 Q 398,163.2 400,160" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="408,160 396,154.4 396,165.6" fill="black" transform="rotate(0,400,160)"></polygon>
                <polygon class="arrowhead" points="408,144 396,138.4 396,149.6" fill="black" transform="rotate(0,400,144)"></polygon>
                <polygon class="arrowhead" points="280,112 268,106.4 268,117.6" fill="black" transform="rotate(0,272,112)"></polygon>
                <polygon class="arrowhead" points="168,144 156,138.4 156,149.6" fill="black" transform="rotate(180,160,144)"></polygon>
                <polygon class="arrowhead" points="152,80 140,74.4 140,85.6" fill="black" transform="rotate(0,144,80)"></polygon>
                <polygon class="arrowhead" points="40,112 28,106.4 28,117.6" fill="black" transform="rotate(180,32,112)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientA1</text>
                  <text x="152" y="36">ServerA</text>
                  <text x="280" y="36">ServerB</text>
                  <text x="412" y="36">ClientB*</text>
                  <text x="64" y="68">Commit,</text>
                  <text x="116" y="68">etc.</text>
                  <text x="108" y="100">Accepted</text>
                  <text x="192" y="100">/notify</text>
                  <text x="232" y="132">200</text>
                  <text x="260" y="132">OK</text>
                  <text x="324" y="132">Welcome,</text>
                  <text x="380" y="132">Tree</text>
                  <text x="40" y="228">ClientA1:</text>
                  <text x="112" y="228">Prepare</text>
                  <text x="172" y="228">Commit</text>
                  <text x="220" y="228">over</text>
                  <text x="300" y="228">AppSync(+Bob),</text>
                  <text x="380" y="228">Add*</text>
                  <text x="76" y="244">ClientA1-&gt;ServerA:</text>
                  <text x="164" y="244">[[</text>
                  <text x="208" y="244">Commit,</text>
                  <text x="276" y="244">Welcome,</text>
                  <text x="360" y="244">GroupInfo?,</text>
                  <text x="460" y="244">RatchetTree?</text>
                  <text x="524" y="244">]]</text>
                  <text x="36" y="260">ServerA:</text>
                  <text x="100" y="260">Verify</text>
                  <text x="148" y="260">that</text>
                  <text x="204" y="260">AppSync,</text>
                  <text x="260" y="260">Adds</text>
                  <text x="296" y="260">are</text>
                  <text x="344" y="260">allowed</text>
                  <text x="388" y="260">by</text>
                  <text x="428" y="260">policy</text>
                  <text x="36" y="276">ServerA:</text>
                  <text x="116" y="276">Identifies</text>
                  <text x="192" y="276">Welcome</text>
                  <text x="256" y="276">domains</text>
                  <text x="312" y="276">based</text>
                  <text x="348" y="276">on</text>
                  <text x="372" y="276">KP</text>
                  <text x="404" y="276">hash</text>
                  <text x="436" y="276">in</text>
                  <text x="480" y="276">Welcome</text>
                  <text x="72" y="292">ServerA-&gt;ServerB:</text>
                  <text x="164" y="292">POST</text>
                  <text x="304" y="292">/notify/a.example/r/clubhouse</text>
                  <text x="452" y="292">Intro{</text>
                  <text x="516" y="292">Welcome,</text>
                  <text x="604" y="292">RatchetTree?</text>
                  <text x="664" y="292">}</text>
                  <text x="36" y="308">ServerB:</text>
                  <text x="116" y="308">Recognizes</text>
                  <text x="180" y="308">that</text>
                  <text x="232" y="308">Welcome</text>
                  <text x="276" y="308">is</text>
                  <text x="316" y="308">adding</text>
                  <text x="360" y="308">Bob</text>
                  <text x="388" y="308">to</text>
                  <text x="420" y="308">room</text>
                  <text x="480" y="308">clubhouse</text>
                  <text x="76" y="324">ServerB-&gt;ClientB*:</text>
                  <text x="164" y="324">[[</text>
                  <text x="212" y="324">Welcome,</text>
                  <text x="300" y="324">RatchetTree?</text>
                  <text x="364" y="324">]]</text>
                </g>
              </svg><a href="#section-3.2-7.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-alice-adds-bob-to-the-room-" class="selfRef">Alice Adds Bob to the Room and Bob's Clients to the MLS Group</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="bob-adds-cathy-to-the-room">
<section id="section-3.3">
        <h3 id="name-bob-adds-cathy-to-the-room">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-bob-adds-cathy-to-the-room" class="section-name selfRef">Bob adds Cathy to the Room</a>
        </h3>
<p id="section-3.3-1">The process of adding Bob was a bit abbreviated because Alice is a user of the
hub service provider.  When Bob adds Cathy, we see the full process, involving
the same two steps (KeyPackage fetch followed by Add), but this time indirected via the
hub server ServerA.  Also, now that there are users on ServerB involved in the
room, the hub ServerA will have to distribute the Commit adding Cathy and
Cathy's clients to ServerB as well as forwarding the Welcome to ServerC.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<span id="name-bob-fetches-keypackages-for"></span><div id="fig-bc-kp-fetch">
<figure id="figure-4">
          <div id="section-3.3-2.1">
            <div class="alignLeft art-svg artwork" id="section-3.3-2.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="400" width="576" viewBox="0 0 576 400" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,208" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,208" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,208" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,208" fill="none" stroke="black"></path>
                <path d="M 536,48 L 536,208" fill="none" stroke="black"></path>
                <path d="M 416,80 Q 418,76.8 420,80 Q 422,83.2 424,80 Q 426,76.8 428,80 Q 430,83.2 432,80 Q 434,76.8 436,80 Q 438,83.2 440,80 Q 442,76.8 444,80 Q 446,83.2 448,80 Q 450,76.8 452,80 Q 454,83.2 456,80 Q 458,76.8 460,80 Q 462,83.2 464,80 Q 466,76.8 468,80 Q 470,83.2 472,80 Q 474,76.8 476,80 Q 478,83.2 480,80 Q 482,76.8 484,80 Q 486,83.2 488,80 Q 490,76.8 492,80 Q 494,83.2 496,80 Q 498,76.8 500,80 Q 502,83.2 504,80 Q 506,76.8 508,80 Q 510,83.2 512,80 Q 514,76.8 516,80 Q 518,83.2 520,80 Q 522,76.8 524,80 Q 526,83.2 528,80 Q 530,76.8 532,80 Q 534,83.2 536,80" fill="none" stroke="black"></path>
                <path d="M 416,96 Q 418,92.8 420,96 Q 422,99.2 424,96 Q 426,92.8 428,96 Q 430,99.2 432,96 Q 434,92.8 436,96 Q 438,99.2 440,96 Q 442,92.8 444,96 Q 446,99.2 448,96 Q 450,92.8 452,96 Q 454,99.2 456,96 Q 458,92.8 460,96 Q 462,99.2 464,96 Q 466,92.8 468,96 Q 470,99.2 472,96 Q 474,92.8 476,96 Q 478,99.2 480,96 Q 482,92.8 484,96 Q 486,99.2 488,96 Q 490,92.8 492,96 Q 494,99.2 496,96 Q 498,92.8 500,96 Q 502,99.2 504,96 Q 506,92.8 508,96 Q 510,99.2 512,96 Q 514,92.8 516,96 Q 518,99.2 520,96 Q 522,92.8 524,96 Q 526,99.2 528,96 Q 530,92.8 532,96 Q 534,99.2 536,96" fill="none" stroke="black"></path>
                <path d="M 24,128 Q 26,124.8 28,128 Q 30,131.2 32,128 Q 34,124.8 36,128 Q 38,131.2 40,128 Q 42,124.8 44,128 Q 46,131.2 48,128 Q 50,124.8 52,128 Q 54,131.2 56,128 Q 58,124.8 60,128 Q 62,131.2 64,128 Q 66,124.8 68,128 Q 70,131.2 72,128 Q 74,124.8 76,128 Q 78,131.2 80,128 Q 82,124.8 84,128 Q 86,131.2 88,128 Q 90,124.8 92,128 Q 94,131.2 96,128 Q 98,124.8 100,128 Q 102,131.2 104,128 Q 106,124.8 108,128 Q 110,131.2 112,128 Q 114,124.8 116,128 Q 118,131.2 120,128 Q 122,124.8 124,128 Q 126,131.2 128,128 Q 130,124.8 132,128 Q 134,131.2 136,128 Q 138,124.8 140,128 Q 142,131.2 144,128" fill="none" stroke="black"></path>
                <path d="M 152,144 L 400,144" fill="none" stroke="black"></path>
                <path d="M 160,176 L 408,176" fill="none" stroke="black"></path>
                <path d="M 32,192 Q 34,188.8 36,192 Q 38,195.2 40,192 Q 42,188.8 44,192 Q 46,195.2 48,192 Q 50,188.8 52,192 Q 54,195.2 56,192 Q 58,188.8 60,192 Q 62,195.2 64,192 Q 66,188.8 68,192 Q 70,195.2 72,192 Q 74,188.8 76,192 Q 78,195.2 80,192 Q 82,188.8 84,192 Q 86,195.2 88,192 Q 90,188.8 92,192 Q 94,195.2 96,192 Q 98,188.8 100,192 Q 102,195.2 104,192 Q 106,188.8 108,192 Q 110,195.2 112,192 Q 114,188.8 116,192 Q 118,195.2 120,192 Q 122,188.8 124,192 Q 126,195.2 128,192 Q 130,188.8 132,192 Q 134,195.2 136,192 Q 138,188.8 140,192 Q 142,195.2 144,192 Q 146,188.8 148,192 Q 150,195.2 152,192" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="424,96 412,90.4 412,101.6" fill="black" transform="rotate(180,416,96)"></polygon>
                <polygon class="arrowhead" points="424,80 412,74.4 412,85.6" fill="black" transform="rotate(180,416,80)"></polygon>
                <polygon class="arrowhead" points="408,144 396,138.4 396,149.6" fill="black" transform="rotate(0,400,144)"></polygon>
                <polygon class="arrowhead" points="296,176 284,170.4 284,181.6" fill="black" transform="rotate(180,288,176)"></polygon>
                <polygon class="arrowhead" points="280,144 268,138.4 268,149.6" fill="black" transform="rotate(0,272,144)"></polygon>
                <polygon class="arrowhead" points="168,176 156,170.4 156,181.6" fill="black" transform="rotate(180,160,176)"></polygon>
                <polygon class="arrowhead" points="152,128 140,122.4 140,133.6" fill="black" transform="rotate(0,144,128)"></polygon>
                <polygon class="arrowhead" points="40,192 28,186.4 28,197.6" fill="black" transform="rotate(180,32,192)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientB1</text>
                  <text x="152" y="36">ServerB</text>
                  <text x="280" y="36">ServerA</text>
                  <text x="408" y="36">ServerC</text>
                  <text x="540" y="36">ClientC*</text>
                  <text x="472" y="68">Store</text>
                  <text x="512" y="68">KPs</text>
                  <text x="64" y="116">Request</text>
                  <text x="112" y="116">KPs</text>
                  <text x="212" y="132">/keyMaterial</text>
                  <text x="340" y="132">/keyMaterial</text>
                  <text x="232" y="164">200</text>
                  <text x="260" y="164">OK</text>
                  <text x="360" y="164">200</text>
                  <text x="388" y="164">OK</text>
                  <text x="128" y="180">KPs</text>
                  <text x="76" y="244">ClientC*-&gt;ServerC:</text>
                  <text x="164" y="244">[[</text>
                  <text x="200" y="244">Store</text>
                  <text x="272" y="244">KeyPackages</text>
                  <text x="332" y="244">]]</text>
                  <text x="76" y="260">ClientB1-&gt;ServerB:</text>
                  <text x="164" y="260">[[</text>
                  <text x="208" y="260">request</text>
                  <text x="256" y="260">KPs</text>
                  <text x="288" y="260">for</text>
                  <text x="320" y="260">Bob</text>
                  <text x="348" y="260">]]</text>
                  <text x="72" y="276">ServerB-&gt;ServerA:</text>
                  <text x="164" y="276">POST</text>
                  <text x="236" y="276">/keyMaterial</text>
                  <text x="364" y="276">KeyMaterialRequest</text>
                  <text x="72" y="292">ServerA-&gt;ServerC:</text>
                  <text x="164" y="292">POST</text>
                  <text x="236" y="292">/keyMaterial</text>
                  <text x="364" y="292">KeyMaterialRequest</text>
                  <text x="36" y="308">ServerB:</text>
                  <text x="100" y="308">Verify</text>
                  <text x="148" y="308">that</text>
                  <text x="184" y="308">Bob</text>
                  <text x="212" y="308">is</text>
                  <text x="268" y="308">authorized</text>
                  <text x="324" y="308">to</text>
                  <text x="360" y="308">fetch</text>
                  <text x="432" y="308">KeyPackages</text>
                  <text x="36" y="324">ServerB:</text>
                  <text x="92" y="324">Mark</text>
                  <text x="148" y="324">returned</text>
                  <text x="200" y="324">KPs</text>
                  <text x="228" y="324">as</text>
                  <text x="276" y="324">reserved</text>
                  <text x="328" y="324">for</text>
                  <text x="368" y="324">Bob's</text>
                  <text x="408" y="324">use</text>
                  <text x="72" y="340">ServerC-&gt;ServerA:</text>
                  <text x="160" y="340">200</text>
                  <text x="188" y="340">OK</text>
                  <text x="280" y="340">KeyMaterialResponse</text>
                  <text x="36" y="356">ServerA:</text>
                  <text x="108" y="356">Remember</text>
                  <text x="164" y="356">that</text>
                  <text x="208" y="356">these</text>
                  <text x="248" y="356">KPs</text>
                  <text x="276" y="356">go</text>
                  <text x="300" y="356">to</text>
                  <text x="352" y="356">b.example</text>
                  <text x="72" y="372">ServerA-&gt;ServerB:</text>
                  <text x="160" y="372">200</text>
                  <text x="188" y="372">OK</text>
                  <text x="280" y="372">KeyMaterialResponse</text>
                  <text x="76" y="388">ServerB-&gt;ClientB1:</text>
                  <text x="164" y="388">[[</text>
                  <text x="192" y="388">KPs</text>
                  <text x="220" y="388">]]</text>
                </g>
              </svg><a href="#section-3.3-2.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-bob-fetches-keypackages-for" class="selfRef">Bob Fetches KeyPackages for Cathy's Clients</a>
          </figcaption></figure>
</div>
<span id="name-bob-adds-cathy-to-the-room-"></span><div id="fig-bc-add">
<figure id="figure-5">
          <div id="section-3.3-3.1">
            <div class="alignLeft art-svg artwork" id="section-3.3-3.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="496" width="576" viewBox="0 0 576 496" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,64 L 8,272" fill="none" stroke="black"></path>
                <path d="M 120,64 L 120,272" fill="none" stroke="black"></path>
                <path d="M 216,64 L 216,240" fill="none" stroke="black"></path>
                <path d="M 312,64 L 312,208" fill="none" stroke="black"></path>
                <path d="M 408,64 L 408,208" fill="none" stroke="black"></path>
                <path d="M 488,64 L 488,208" fill="none" stroke="black"></path>
                <path d="M 488,240 L 488,272" fill="none" stroke="black"></path>
                <path d="M 568,64 L 568,272" fill="none" stroke="black"></path>
                <path d="M 8,96 Q 10,92.8 12,96 Q 14,99.2 16,96 Q 18,92.8 20,96 Q 22,99.2 24,96 Q 26,92.8 28,96 Q 30,99.2 32,96 Q 34,92.8 36,96 Q 38,99.2 40,96 Q 42,92.8 44,96 Q 46,99.2 48,96 Q 50,92.8 52,96 Q 54,99.2 56,96 Q 58,92.8 60,96 Q 62,99.2 64,96 Q 66,92.8 68,96 Q 70,99.2 72,96 Q 74,92.8 76,96 Q 78,99.2 80,96 Q 82,92.8 84,96 Q 86,99.2 88,96 Q 90,92.8 92,96 Q 94,99.2 96,96 Q 98,92.8 100,96 Q 102,99.2 104,96 Q 106,92.8 108,96 Q 110,99.2 112,96" fill="none" stroke="black"></path>
                <path d="M 120,112 L 208,112" fill="none" stroke="black"></path>
                <path d="M 128,144 L 216,144" fill="none" stroke="black"></path>
                <path d="M 16,176 Q 18,172.8 20,176 Q 22,179.2 24,176 Q 26,172.8 28,176 Q 30,179.2 32,176 Q 34,172.8 36,176 Q 38,179.2 40,176 Q 42,172.8 44,176 Q 46,179.2 48,176 Q 50,172.8 52,176 Q 54,179.2 56,176 Q 58,172.8 60,176 Q 62,179.2 64,176 Q 66,172.8 68,176 Q 70,179.2 72,176 Q 74,172.8 76,176 Q 78,179.2 80,176 Q 82,172.8 84,176 Q 86,179.2 88,176 Q 90,172.8 92,176 Q 94,179.2 96,176 Q 98,172.8 100,176 Q 102,179.2 104,176 Q 106,172.8 108,176 Q 110,179.2 112,176 Q 114,172.8 116,176 Q 118,179.2 120,176" fill="none" stroke="black"></path>
                <path d="M 216,176 L 304,176" fill="none" stroke="black"></path>
                <path d="M 312,192 Q 314,188.8 316,192 Q 318,195.2 320,192 Q 322,188.8 324,192 Q 326,195.2 328,192 Q 330,188.8 332,192 Q 334,195.2 336,192 Q 338,188.8 340,192 Q 342,195.2 344,192 Q 346,188.8 348,192 Q 350,195.2 352,192 Q 354,188.8 356,192 Q 358,195.2 360,192 Q 362,188.8 364,192 Q 366,195.2 368,192 Q 370,188.8 372,192 Q 374,195.2 376,192 Q 378,188.8 380,192 Q 382,195.2 384,192 Q 386,188.8 388,192 Q 390,195.2 392,192 Q 394,188.8 396,192 Q 398,195.2 400,192" fill="none" stroke="black"></path>
                <path d="M 312,208 Q 314,204.8 316,208 Q 318,211.2 320,208 Q 322,204.8 324,208 Q 326,211.2 328,208 Q 330,204.8 332,208 Q 334,211.2 336,208 Q 338,204.8 340,208 Q 342,211.2 344,208 Q 346,204.8 348,208 Q 350,211.2 352,208 Q 354,204.8 356,208 Q 358,211.2 360,208 Q 362,204.8 364,208 Q 366,211.2 368,208 Q 370,204.8 372,208 Q 374,211.2 376,208 Q 378,204.8 380,208 Q 382,211.2 384,208 Q 386,204.8 388,208 Q 390,211.2 392,208 Q 394,204.8 396,208 Q 398,211.2 400,208" fill="none" stroke="black"></path>
                <path d="M 128,224 L 216,224" fill="none" stroke="black"></path>
                <path d="M 216,224 Q 218,220.8 220,224 Q 222,227.2 224,224 Q 226,220.8 228,224 Q 230,227.2 232,224 Q 234,220.8 236,224 Q 238,227.2 240,224 Q 242,220.8 244,224 Q 246,227.2 248,224 Q 250,220.8 252,224 Q 254,227.2 256,224 Q 258,220.8 260,224 Q 262,227.2 264,224 Q 266,220.8 268,224 Q 270,227.2 272,224 Q 274,220.8 276,224 Q 278,227.2 280,224 Q 282,220.8 284,224 Q 286,227.2 288,224 Q 290,220.8 292,224 Q 294,227.2 296,224 Q 298,220.8 300,224 Q 302,227.2 304,224 Q 306,220.8 308,224 Q 310,227.2 312,224 Q 314,220.8 316,224 Q 318,227.2 320,224 Q 322,220.8 324,224 Q 326,227.2 328,224 Q 330,220.8 332,224 Q 334,227.2 336,224 Q 338,220.8 340,224 Q 342,227.2 344,224 Q 346,220.8 348,224 Q 350,227.2 352,224 Q 354,220.8 356,224 Q 358,227.2 360,224 Q 362,220.8 364,224 Q 366,227.2 368,224 Q 370,220.8 372,224 Q 374,227.2 376,224 Q 378,220.8 380,224 Q 382,227.2 384,224 Q 386,220.8 388,224 Q 390,227.2 392,224 Q 394,220.8 396,224 Q 398,227.2 400,224 Q 402,220.8 404,224 Q 406,227.2 408,224 Q 410,220.8 412,224 Q 414,227.2 416,224 Q 418,220.8 420,224 Q 422,227.2 424,224 Q 426,220.8 428,224 Q 430,227.2 432,224 Q 434,220.8 436,224 Q 438,227.2 440,224 Q 442,220.8 444,224 Q 446,227.2 448,224 Q 450,220.8 452,224 Q 454,227.2 456,224 Q 458,220.8 460,224 Q 462,227.2 464,224 Q 466,220.8 468,224 Q 470,227.2 472,224 Q 474,220.8 476,224 Q 478,227.2 480,224 Q 482,220.8 484,224 Q 486,227.2 488,224 Q 490,220.8 492,224 Q 494,227.2 496,224 Q 498,220.8 500,224 Q 502,227.2 504,224 Q 506,220.8 508,224 Q 510,227.2 512,224 Q 514,220.8 516,224 Q 518,227.2 520,224 Q 522,220.8 524,224 Q 526,227.2 528,224 Q 530,220.8 532,224 Q 534,227.2 536,224 Q 538,220.8 540,224 Q 542,227.2 544,224 Q 546,220.8 548,224 Q 550,227.2 552,224 Q 554,220.8 556,224 Q 558,227.2 560,224" fill="none" stroke="black"></path>
                <path d="M 120,256 Q 122,252.8 124,256 Q 126,259.2 128,256 Q 130,252.8 132,256 Q 134,259.2 136,256 Q 138,252.8 140,256 Q 142,259.2 144,256 Q 146,252.8 148,256 Q 150,259.2 152,256 Q 154,252.8 156,256 Q 158,259.2 160,256 Q 162,252.8 164,256 Q 166,259.2 168,256 Q 170,252.8 172,256 Q 174,259.2 176,256 Q 178,252.8 180,256 Q 182,259.2 184,256 Q 186,252.8 188,256 Q 190,259.2 192,256 Q 194,252.8 196,256 Q 198,259.2 200,256 Q 202,252.8 204,256 Q 206,259.2 208,256 Q 210,252.8 212,256 Q 214,259.2 216,256 Q 218,252.8 220,256 Q 222,259.2 224,256 Q 226,252.8 228,256 Q 230,259.2 232,256 Q 234,252.8 236,256 Q 238,259.2 240,256 Q 242,252.8 244,256 Q 246,259.2 248,256 Q 250,252.8 252,256 Q 254,259.2 256,256 Q 258,252.8 260,256 Q 262,259.2 264,256 Q 266,252.8 268,256 Q 270,259.2 272,256 Q 274,252.8 276,256 Q 278,259.2 280,256 Q 282,252.8 284,256 Q 286,259.2 288,256 Q 290,252.8 292,256 Q 294,259.2 296,256 Q 298,252.8 300,256 Q 302,259.2 304,256 Q 306,252.8 308,256 Q 310,259.2 312,256 Q 314,252.8 316,256 Q 318,259.2 320,256 Q 322,252.8 324,256 Q 326,259.2 328,256 Q 330,252.8 332,256 Q 334,259.2 336,256 Q 338,252.8 340,256 Q 342,259.2 344,256 Q 346,252.8 348,256 Q 350,259.2 352,256 Q 354,252.8 356,256 Q 358,259.2 360,256 Q 362,252.8 364,256 Q 366,259.2 368,256 Q 370,252.8 372,256 Q 374,259.2 376,256 Q 378,252.8 380,256 Q 382,259.2 384,256 Q 386,252.8 388,256 Q 390,259.2 392,256 Q 394,252.8 396,256 Q 398,259.2 400,256 Q 402,252.8 404,256 Q 406,259.2 408,256 Q 410,252.8 412,256 Q 414,259.2 416,256 Q 418,252.8 420,256 Q 422,259.2 424,256 Q 426,252.8 428,256 Q 430,259.2 432,256 Q 434,252.8 436,256 Q 438,259.2 440,256 Q 442,252.8 444,256 Q 446,259.2 448,256 Q 450,252.8 452,256 Q 454,259.2 456,256 Q 458,252.8 460,256 Q 462,259.2 464,256 Q 466,252.8 468,256 Q 470,259.2 472,256 Q 474,252.8 476,256 Q 478,259.2 480,256" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="568,224 556,218.4 556,229.6" fill="black" transform="rotate(0,560,224)"></polygon>
                <polygon class="arrowhead" points="488,256 476,250.4 476,261.6" fill="black" transform="rotate(0,480,256)"></polygon>
                <polygon class="arrowhead" points="408,208 396,202.4 396,213.6" fill="black" transform="rotate(0,400,208)"></polygon>
                <polygon class="arrowhead" points="408,192 396,186.4 396,197.6" fill="black" transform="rotate(0,400,192)"></polygon>
                <polygon class="arrowhead" points="312,176 300,170.4 300,181.6" fill="black" transform="rotate(0,304,176)"></polygon>
                <polygon class="arrowhead" points="216,112 204,106.4 204,117.6" fill="black" transform="rotate(0,208,112)"></polygon>
                <polygon class="arrowhead" points="136,224 124,218.4 124,229.6" fill="black" transform="rotate(180,128,224)"></polygon>
                <polygon class="arrowhead" points="136,144 124,138.4 124,149.6" fill="black" transform="rotate(180,128,144)"></polygon>
                <polygon class="arrowhead" points="120,96 108,90.4 108,101.6" fill="black" transform="rotate(0,112,96)"></polygon>
                <polygon class="arrowhead" points="24,176 12,170.4 12,181.6" fill="black" transform="rotate(180,16,176)"></polygon>
                <g class="text">
                  <text x="28" y="36">Client</text>
                  <text x="404" y="36">Client</text>
                  <text x="484" y="36">Client</text>
                  <text x="548" y="36">Client</text>
                  <text x="12" y="52">B1</text>
                  <text x="120" y="52">ServerB</text>
                  <text x="216" y="52">ServerA</text>
                  <text x="312" y="52">ServerC</text>
                  <text x="396" y="52">C*</text>
                  <text x="476" y="52">B*</text>
                  <text x="556" y="52">A*</text>
                  <text x="48" y="84">Commit,</text>
                  <text x="96" y="84">etc</text>
                  <text x="160" y="100">/update</text>
                  <text x="168" y="132">200</text>
                  <text x="196" y="132">OK</text>
                  <text x="76" y="164">Accepted</text>
                  <text x="256" y="164">/notify</text>
                  <text x="356" y="164">Welcome,</text>
                  <text x="340" y="180">Tree</text>
                  <text x="176" y="212">/notify</text>
                  <text x="252" y="212">Commit</text>
                  <text x="156" y="244">Commit</text>
                  <text x="312" y="244">|</text>
                  <text x="408" y="244">|</text>
                  <text x="216" y="276">|</text>
                  <text x="312" y="276">|</text>
                  <text x="408" y="276">|</text>
                  <text x="40" y="308">ClientB1:</text>
                  <text x="112" y="308">Prepare</text>
                  <text x="172" y="308">Commit</text>
                  <text x="220" y="308">over</text>
                  <text x="308" y="308">AppSync(+Cathy),</text>
                  <text x="396" y="308">Add*</text>
                  <text x="76" y="324">ClientB1-&gt;ServerB:</text>
                  <text x="164" y="324">[[</text>
                  <text x="208" y="324">Commit,</text>
                  <text x="276" y="324">Welcome,</text>
                  <text x="360" y="324">GroupInfo?,</text>
                  <text x="460" y="324">RatchetTree?</text>
                  <text x="524" y="324">]]</text>
                  <text x="72" y="340">ServerB-&gt;ServerA:</text>
                  <text x="164" y="340">POST</text>
                  <text x="304" y="340">/update/a.example/r/clubhouse</text>
                  <text x="476" y="340">CommitBundle</text>
                  <text x="36" y="356">ServerA:</text>
                  <text x="100" y="356">Verify</text>
                  <text x="148" y="356">that</text>
                  <text x="188" y="356">Adds</text>
                  <text x="224" y="356">are</text>
                  <text x="272" y="356">allowed</text>
                  <text x="316" y="356">by</text>
                  <text x="356" y="356">policy</text>
                  <text x="72" y="372">ServerA-&gt;ServerB:</text>
                  <text x="160" y="372">200</text>
                  <text x="188" y="372">OK</text>
                  <text x="72" y="388">ServerA-&gt;ServerC:</text>
                  <text x="164" y="388">POST</text>
                  <text x="304" y="388">/notify/a.example/r/clubhouse</text>
                  <text x="212" y="404">Intro{</text>
                  <text x="276" y="404">Welcome,</text>
                  <text x="364" y="404">RatchetTree?</text>
                  <text x="424" y="404">}</text>
                  <text x="36" y="420">ServerC:</text>
                  <text x="116" y="420">Recognizes</text>
                  <text x="180" y="420">that</text>
                  <text x="232" y="420">Welcome</text>
                  <text x="276" y="420">is</text>
                  <text x="316" y="420">adding</text>
                  <text x="368" y="420">Cathy</text>
                  <text x="404" y="420">to</text>
                  <text x="456" y="420">clubhouse</text>
                  <text x="76" y="436">ServerC-&gt;ClientC*:</text>
                  <text x="164" y="436">[[</text>
                  <text x="212" y="436">Welcome,</text>
                  <text x="300" y="436">RatchetTree?</text>
                  <text x="364" y="436">]]</text>
                  <text x="72" y="452">ServerA-&gt;ServerB:</text>
                  <text x="164" y="452">POST</text>
                  <text x="304" y="452">/notify/a.example/r/clubhouse</text>
                  <text x="452" y="452">Commit</text>
                  <text x="76" y="468">ServerB-&gt;ClientB*:</text>
                  <text x="164" y="468">[[</text>
                  <text x="204" y="468">Commit</text>
                  <text x="244" y="468">]]</text>
                  <text x="76" y="484">ServerA-&gt;ClientA*:</text>
                  <text x="164" y="484">[[</text>
                  <text x="204" y="484">Commit</text>
                  <text x="244" y="484">]]</text>
                </g>
              </svg><a href="#section-3.3-3.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-bob-adds-cathy-to-the-room-" class="selfRef">Bob Adds Cathy to the Room and Cathy's Clients to the MLS Group</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="cathy-sends-a-message">
<section id="section-3.4">
        <h3 id="name-cathy-sends-a-message">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-cathy-sends-a-message" class="section-name selfRef">Cathy Sends a Message</a>
        </h3>
<p id="section-3.4-1">Now that Alice, Bob, and Cathy are all in the room, Cathy wants to say hello to
everyone.  Cathy's client encapsulates the message in an MLS PrivateMessage and
sends it to ServerC, who forwards it to the hub ServerA on Cathy's behalf.
Assuming Cathy is allowed to speak in the room, ServerA will forward Cathy's
message to the other servers involved in the room, who distribute it to their
clients.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<span id="name-cathy-sends-a-message-to-th"></span><div id="fig-c-msg">
<figure id="figure-6">
          <div id="section-3.4-2.1">
            <div class="alignLeft art-svg artwork" id="section-3.4-2.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="448" width="736" viewBox="0 0 736 448" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,288" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,288" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,224" fill="none" stroke="black"></path>
                <path d="M 280,256 L 280,288" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,224" fill="none" stroke="black"></path>
                <path d="M 536,48 L 536,224" fill="none" stroke="black"></path>
                <path d="M 616,48 L 616,256" fill="none" stroke="black"></path>
                <path d="M 696,48 L 696,288" fill="none" stroke="black"></path>
                <path d="M 24,80 Q 26,76.8 28,80 Q 30,83.2 32,80 Q 34,76.8 36,80 Q 38,83.2 40,80 Q 42,76.8 44,80 Q 46,83.2 48,80 Q 50,76.8 52,80 Q 54,83.2 56,80 Q 58,76.8 60,80 Q 62,83.2 64,80 Q 66,76.8 68,80 Q 70,83.2 72,80 Q 74,76.8 76,80 Q 78,83.2 80,80 Q 82,76.8 84,80 Q 86,83.2 88,80 Q 90,76.8 92,80 Q 94,83.2 96,80 Q 98,76.8 100,80 Q 102,83.2 104,80 Q 106,76.8 108,80 Q 110,83.2 112,80 Q 114,76.8 116,80 Q 118,83.2 120,80 Q 122,76.8 124,80 Q 126,83.2 128,80 Q 130,76.8 132,80 Q 134,83.2 136,80 Q 138,76.8 140,80 Q 142,83.2 144,80" fill="none" stroke="black"></path>
                <path d="M 152,96 L 272,96" fill="none" stroke="black"></path>
                <path d="M 160,128 L 280,128" fill="none" stroke="black"></path>
                <path d="M 32,160 Q 34,156.8 36,160 Q 38,163.2 40,160 Q 42,156.8 44,160 Q 46,163.2 48,160 Q 50,156.8 52,160 Q 54,163.2 56,160 Q 58,156.8 60,160 Q 62,163.2 64,160 Q 66,156.8 68,160 Q 70,163.2 72,160 Q 74,156.8 76,160 Q 78,163.2 80,160 Q 82,156.8 84,160 Q 86,163.2 88,160 Q 90,156.8 92,160 Q 94,163.2 96,160 Q 98,156.8 100,160 Q 102,163.2 104,160 Q 106,156.8 108,160 Q 110,163.2 112,160 Q 114,156.8 116,160 Q 118,163.2 120,160 Q 122,156.8 124,160 Q 126,163.2 128,160 Q 130,156.8 132,160 Q 134,163.2 136,160 Q 138,156.8 140,160 Q 142,163.2 144,160 Q 146,156.8 148,160 Q 150,163.2 152,160" fill="none" stroke="black"></path>
                <path d="M 280,160 L 400,160" fill="none" stroke="black"></path>
                <path d="M 408,176 Q 410,172.8 412,176 Q 414,179.2 416,176 Q 418,172.8 420,176 Q 422,179.2 424,176 Q 426,172.8 428,176 Q 430,179.2 432,176 Q 434,172.8 436,176 Q 438,179.2 440,176 Q 442,172.8 444,176 Q 446,179.2 448,176 Q 450,172.8 452,176 Q 454,179.2 456,176 Q 458,172.8 460,176 Q 462,179.2 464,176 Q 466,172.8 468,176 Q 470,179.2 472,176 Q 474,172.8 476,176 Q 478,179.2 480,176 Q 482,172.8 484,176 Q 486,179.2 488,176 Q 490,172.8 492,176 Q 494,179.2 496,176 Q 498,172.8 500,176 Q 502,179.2 504,176 Q 506,172.8 508,176 Q 510,179.2 512,176 Q 514,172.8 516,176 Q 518,179.2 520,176 Q 522,172.8 524,176 Q 526,179.2 528,176" fill="none" stroke="black"></path>
                <path d="M 160,208 L 280,208" fill="none" stroke="black"></path>
                <path d="M 152,240 Q 154,236.8 156,240 Q 158,243.2 160,240 Q 162,236.8 164,240 Q 166,243.2 168,240 Q 170,236.8 172,240 Q 174,243.2 176,240 Q 178,236.8 180,240 Q 182,243.2 184,240 Q 186,236.8 188,240 Q 190,243.2 192,240 Q 194,236.8 196,240 Q 198,243.2 200,240 Q 202,236.8 204,240 Q 206,243.2 208,240 Q 210,236.8 212,240 Q 214,243.2 216,240 Q 218,236.8 220,240 Q 222,243.2 224,240 Q 226,236.8 228,240 Q 230,243.2 232,240 Q 234,236.8 236,240 Q 238,243.2 240,240 Q 242,236.8 244,240 Q 246,243.2 248,240 Q 250,236.8 252,240 Q 254,243.2 256,240 Q 258,236.8 260,240 Q 262,243.2 264,240 Q 266,236.8 268,240 Q 270,243.2 272,240 Q 274,236.8 276,240 Q 278,243.2 280,240 Q 282,236.8 284,240 Q 286,243.2 288,240 Q 290,236.8 292,240 Q 294,243.2 296,240 Q 298,236.8 300,240 Q 302,243.2 304,240 Q 306,236.8 308,240 Q 310,243.2 312,240 Q 314,236.8 316,240 Q 318,243.2 320,240 Q 322,236.8 324,240 Q 326,243.2 328,240 Q 330,236.8 332,240 Q 334,243.2 336,240 Q 338,236.8 340,240 Q 342,243.2 344,240 Q 346,236.8 348,240 Q 350,243.2 352,240 Q 354,236.8 356,240 Q 358,243.2 360,240 Q 362,236.8 364,240 Q 366,243.2 368,240 Q 370,236.8 372,240 Q 374,243.2 376,240 Q 378,236.8 380,240 Q 382,243.2 384,240 Q 386,236.8 388,240 Q 390,243.2 392,240 Q 394,236.8 396,240 Q 398,243.2 400,240 Q 402,236.8 404,240 Q 406,243.2 408,240 Q 410,236.8 412,240 Q 414,243.2 416,240 Q 418,236.8 420,240 Q 422,243.2 424,240 Q 426,236.8 428,240 Q 430,243.2 432,240 Q 434,236.8 436,240 Q 438,243.2 440,240 Q 442,236.8 444,240 Q 446,243.2 448,240 Q 450,236.8 452,240 Q 454,243.2 456,240 Q 458,236.8 460,240 Q 462,243.2 464,240 Q 466,236.8 468,240 Q 470,243.2 472,240 Q 474,236.8 476,240 Q 478,243.2 480,240 Q 482,236.8 484,240 Q 486,243.2 488,240 Q 490,236.8 492,240 Q 494,243.2 496,240 Q 498,236.8 500,240 Q 502,243.2 504,240 Q 506,236.8 508,240 Q 510,243.2 512,240 Q 514,236.8 516,240 Q 518,243.2 520,240 Q 522,236.8 524,240 Q 526,243.2 528,240 Q 530,236.8 532,240 Q 534,243.2 536,240 Q 538,236.8 540,240 Q 542,243.2 544,240 Q 546,236.8 548,240 Q 550,243.2 552,240 Q 554,236.8 556,240 Q 558,243.2 560,240 Q 562,236.8 564,240 Q 566,243.2 568,240 Q 570,236.8 572,240 Q 574,243.2 576,240 Q 578,236.8 580,240 Q 582,243.2 584,240 Q 586,236.8 588,240 Q 590,243.2 592,240 Q 594,236.8 596,240 Q 598,243.2 600,240 Q 602,236.8 604,240 Q 606,243.2 608,240" fill="none" stroke="black"></path>
                <path d="M 280,272 Q 282,268.8 284,272 Q 286,275.2 288,272 Q 290,268.8 292,272 Q 294,275.2 296,272 Q 298,268.8 300,272 Q 302,275.2 304,272 Q 306,268.8 308,272 Q 310,275.2 312,272 Q 314,268.8 316,272 Q 318,275.2 320,272 Q 322,268.8 324,272 Q 326,275.2 328,272 Q 330,268.8 332,272 Q 334,275.2 336,272 Q 338,268.8 340,272 Q 342,275.2 344,272 Q 346,268.8 348,272 Q 350,275.2 352,272 Q 354,268.8 356,272 Q 358,275.2 360,272 Q 362,268.8 364,272 Q 366,275.2 368,272 Q 370,268.8 372,272 Q 374,275.2 376,272 Q 378,268.8 380,272 Q 382,275.2 384,272 Q 386,268.8 388,272 Q 390,275.2 392,272 Q 394,268.8 396,272 Q 398,275.2 400,272 Q 402,268.8 404,272 Q 406,275.2 408,272 Q 410,268.8 412,272 Q 414,275.2 416,272 Q 418,268.8 420,272 Q 422,275.2 424,272 Q 426,268.8 428,272 Q 430,275.2 432,272 Q 434,268.8 436,272 Q 438,275.2 440,272 Q 442,268.8 444,272 Q 446,275.2 448,272 Q 450,268.8 452,272 Q 454,275.2 456,272 Q 458,268.8 460,272 Q 462,275.2 464,272 Q 466,268.8 468,272 Q 470,275.2 472,272 Q 474,268.8 476,272 Q 478,275.2 480,272 Q 482,268.8 484,272 Q 486,275.2 488,272 Q 490,268.8 492,272 Q 494,275.2 496,272 Q 498,268.8 500,272 Q 502,275.2 504,272 Q 506,268.8 508,272 Q 510,275.2 512,272 Q 514,268.8 516,272 Q 518,275.2 520,272 Q 522,268.8 524,272 Q 526,275.2 528,272 Q 530,268.8 532,272 Q 534,275.2 536,272 Q 538,268.8 540,272 Q 542,275.2 544,272 Q 546,268.8 548,272 Q 550,275.2 552,272 Q 554,268.8 556,272 Q 558,275.2 560,272 Q 562,268.8 564,272 Q 566,275.2 568,272 Q 570,268.8 572,272 Q 574,275.2 576,272 Q 578,268.8 580,272 Q 582,275.2 584,272 Q 586,268.8 588,272 Q 590,275.2 592,272 Q 594,268.8 596,272 Q 598,275.2 600,272 Q 602,268.8 604,272 Q 606,275.2 608,272 Q 610,268.8 612,272 Q 614,275.2 616,272 Q 618,268.8 620,272 Q 622,275.2 624,272 Q 626,268.8 628,272 Q 630,275.2 632,272 Q 634,268.8 636,272 Q 638,275.2 640,272 Q 642,268.8 644,272 Q 646,275.2 648,272 Q 650,268.8 652,272 Q 654,275.2 656,272 Q 658,268.8 660,272 Q 662,275.2 664,272 Q 666,268.8 668,272 Q 670,275.2 672,272 Q 674,268.8 676,272 Q 678,275.2 680,272 Q 682,268.8 684,272 Q 686,275.2 688,272" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="696,272 684,266.4 684,277.6" fill="black" transform="rotate(0,688,272)"></polygon>
                <polygon class="arrowhead" points="616,240 604,234.4 604,245.6" fill="black" transform="rotate(0,608,240)"></polygon>
                <polygon class="arrowhead" points="536,176 524,170.4 524,181.6" fill="black" transform="rotate(0,528,176)"></polygon>
                <polygon class="arrowhead" points="408,160 396,154.4 396,165.6" fill="black" transform="rotate(0,400,160)"></polygon>
                <polygon class="arrowhead" points="280,96 268,90.4 268,101.6" fill="black" transform="rotate(0,272,96)"></polygon>
                <polygon class="arrowhead" points="168,208 156,202.4 156,213.6" fill="black" transform="rotate(180,160,208)"></polygon>
                <polygon class="arrowhead" points="168,128 156,122.4 156,133.6" fill="black" transform="rotate(180,160,128)"></polygon>
                <polygon class="arrowhead" points="152,80 140,74.4 140,85.6" fill="black" transform="rotate(0,144,80)"></polygon>
                <polygon class="arrowhead" points="40,160 28,154.4 28,165.6" fill="black" transform="rotate(180,32,160)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientC1</text>
                  <text x="152" y="36">ServerC</text>
                  <text x="280" y="36">ServerA</text>
                  <text x="408" y="36">ServerB</text>
                  <text x="540" y="36">ClientB*</text>
                  <text x="620" y="36">ClientC*</text>
                  <text x="700" y="36">ClientA*</text>
                  <text x="64" y="68">Message</text>
                  <text x="192" y="84">/submit</text>
                  <text x="232" y="116">200</text>
                  <text x="260" y="116">OK</text>
                  <text x="108" y="148">Accepted</text>
                  <text x="320" y="148">/notify</text>
                  <text x="448" y="164">Message</text>
                  <text x="240" y="196">/notify</text>
                  <text x="192" y="228">Message</text>
                  <text x="320" y="260">Message</text>
                  <text x="408" y="260">|</text>
                  <text x="536" y="260">|</text>
                  <text x="408" y="292">|</text>
                  <text x="536" y="292">|</text>
                  <text x="616" y="292">|</text>
                  <text x="76" y="324">ClientC1-&gt;ServerC:</text>
                  <text x="164" y="324">[[</text>
                  <text x="284" y="324">MLSMessage(PrivateMessage)</text>
                  <text x="404" y="324">]]</text>
                  <text x="72" y="340">ServerC-&gt;ServerA:</text>
                  <text x="164" y="340">POST</text>
                  <text x="304" y="340">/submit/a.example/r/clubhouse</text>
                  <text x="532" y="340">MLSMessage(PrivateMessage)</text>
                  <text x="36" y="356">ServerA:</text>
                  <text x="108" y="356">Verifies</text>
                  <text x="164" y="356">that</text>
                  <text x="216" y="356">message</text>
                  <text x="260" y="356">is</text>
                  <text x="304" y="356">allowed</text>
                  <text x="72" y="372">ServerA-&gt;ServerC:</text>
                  <text x="164" y="372">POST</text>
                  <text x="304" y="372">/notify/a.example/r/clubhouse</text>
                  <text x="460" y="372">Message{</text>
                  <text x="604" y="372">MLSMessage(PrivateMessage)</text>
                  <text x="720" y="372">}</text>
                  <text x="72" y="388">ServerA-&gt;ServerB:</text>
                  <text x="164" y="388">POST</text>
                  <text x="304" y="388">/notify/a.example/r/clubhouse</text>
                  <text x="460" y="388">Message{</text>
                  <text x="604" y="388">MLSMessage(PrivateMessage)</text>
                  <text x="720" y="388">}</text>
                  <text x="76" y="404">ServerA-&gt;ClientA*:</text>
                  <text x="164" y="404">[[</text>
                  <text x="284" y="404">MLSMessage(PrivateMessage)</text>
                  <text x="404" y="404">]]</text>
                  <text x="76" y="420">ServerB-&gt;ClientB*:</text>
                  <text x="164" y="420">[[</text>
                  <text x="284" y="420">MLSMessage(PrivateMessage)</text>
                  <text x="404" y="420">]]</text>
                  <text x="76" y="436">ServerC-&gt;ClientC*:</text>
                  <text x="164" y="436">[[</text>
                  <text x="284" y="436">MLSMessage(PrivateMessage)</text>
                  <text x="404" y="436">]]</text>
                </g>
              </svg><a href="#section-3.4-2.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-6" class="selfRef">Figure 6</a>:
<a href="#name-cathy-sends-a-message-to-th" class="selfRef">Cathy Sends a Message to the Room</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="bob-leaves-the-room">
<section id="section-3.5">
        <h3 id="name-bob-leaves-the-room">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-bob-leaves-the-room" class="section-name selfRef">Bob Leaves the Room</a>
        </h3>
<p id="section-3.5-1">A user removing another user follows the same flow as adding the user.  The
user performing the removal creates an MLS commit covering Remove proposals for
all of the removed user's devices, and an AppSync proposal updating the room
state to remove the removed user from the room's participant list.<a href="#section-3.5-1" class="pilcrow">¶</a></p>
<p id="section-3.5-2">One's own user leaving is slightly more complicated than removing another user,
because the leaving user cannot remove all of their devices from the MLS group.
Instead, the leave happens in three steps:<a href="#section-3.5-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3.5-3">
<li id="section-3.5-3.1">
            <p id="section-3.5-3.1.1">The leaving client constructs MLS Remove proposals for all of the user's
devices (including the leaving client), and an AppSync proposal that removes
its user from the participant list.<a href="#section-3.5-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-3.5-3.2">
            <p id="section-3.5-3.2.1">The leaving client sends these proposals to the hub.  The hub caches the proposals.<a href="#section-3.5-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-3.5-3.3">
            <p id="section-3.5-3.3.1">The next time a client attempts to commit, the hub requires the client to
include the cached proposals.<a href="#section-3.5-3.3.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-3.5-4">The hub thus guarantees the leaving client that they will be removed as soon as
possible.<a href="#section-3.5-4" class="pilcrow">¶</a></p>
<span id="name-bob-leaves-the-room-2"></span><div id="fig-b-leave">
<figure id="figure-7">
          <div id="section-3.5-5.1">
            <div class="alignLeft art-svg artwork" id="section-3.5-5.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="704" width="608" viewBox="0 0 608 704" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,416" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,416" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,416" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,416" fill="none" stroke="black"></path>
                <path d="M 536,48 L 536,368" fill="none" stroke="black"></path>
                <path d="M 536,400 L 536,416" fill="none" stroke="black"></path>
                <path d="M 600,48 L 600,416" fill="none" stroke="black"></path>
                <path d="M 24,80 Q 26,76.8 28,80 Q 30,83.2 32,80 Q 34,76.8 36,80 Q 38,83.2 40,80 Q 42,76.8 44,80 Q 46,83.2 48,80 Q 50,76.8 52,80 Q 54,83.2 56,80 Q 58,76.8 60,80 Q 62,83.2 64,80 Q 66,76.8 68,80 Q 70,83.2 72,80 Q 74,76.8 76,80 Q 78,83.2 80,80 Q 82,76.8 84,80 Q 86,83.2 88,80 Q 90,76.8 92,80 Q 94,83.2 96,80 Q 98,76.8 100,80 Q 102,83.2 104,80 Q 106,76.8 108,80 Q 110,83.2 112,80 Q 114,76.8 116,80 Q 118,83.2 120,80 Q 122,76.8 124,80 Q 126,83.2 128,80 Q 130,76.8 132,80 Q 134,83.2 136,80 Q 138,76.8 140,80 Q 142,83.2 144,80" fill="none" stroke="black"></path>
                <path d="M 152,96 L 272,96" fill="none" stroke="black"></path>
                <path d="M 160,128 L 280,128" fill="none" stroke="black"></path>
                <path d="M 32,160 Q 34,156.8 36,160 Q 38,163.2 40,160 Q 42,156.8 44,160 Q 46,163.2 48,160 Q 50,156.8 52,160 Q 54,163.2 56,160 Q 58,156.8 60,160 Q 62,163.2 64,160 Q 66,156.8 68,160 Q 70,163.2 72,160 Q 74,156.8 76,160 Q 78,163.2 80,160 Q 82,156.8 84,160 Q 86,163.2 88,160 Q 90,156.8 92,160 Q 94,163.2 96,160 Q 98,156.8 100,160 Q 102,163.2 104,160 Q 106,156.8 108,160 Q 110,163.2 112,160 Q 114,156.8 116,160 Q 118,163.2 120,160 Q 122,156.8 124,160 Q 126,163.2 128,160 Q 130,156.8 132,160 Q 134,163.2 136,160 Q 138,156.8 140,160 Q 142,163.2 144,160 Q 146,156.8 148,160 Q 150,163.2 152,160" fill="none" stroke="black"></path>
                <path d="M 280,160 L 400,160" fill="none" stroke="black"></path>
                <path d="M 408,192 Q 410,188.8 412,192 Q 414,195.2 416,192 Q 418,188.8 420,192 Q 422,195.2 424,192 Q 426,188.8 428,192 Q 430,195.2 432,192 Q 434,188.8 436,192 Q 438,195.2 440,192 Q 442,188.8 444,192 Q 446,195.2 448,192 Q 450,188.8 452,192 Q 454,195.2 456,192 Q 458,188.8 460,192 Q 462,195.2 464,192 Q 466,188.8 468,192 Q 470,195.2 472,192 Q 474,188.8 476,192 Q 478,195.2 480,192 Q 482,188.8 484,192 Q 486,195.2 488,192 Q 490,188.8 492,192 Q 494,195.2 496,192 Q 498,188.8 500,192 Q 502,195.2 504,192 Q 506,188.8 508,192 Q 510,195.2 512,192 Q 514,188.8 516,192 Q 518,195.2 520,192 Q 522,188.8 524,192 Q 526,195.2 528,192" fill="none" stroke="black"></path>
                <path d="M 416,240 Q 418,236.8 420,240 Q 422,243.2 424,240 Q 426,236.8 428,240 Q 430,243.2 432,240 Q 434,236.8 436,240 Q 438,243.2 440,240 Q 442,236.8 444,240 Q 446,243.2 448,240 Q 450,236.8 452,240 Q 454,243.2 456,240 Q 458,236.8 460,240 Q 462,243.2 464,240 Q 466,236.8 468,240 Q 470,243.2 472,240 Q 474,236.8 476,240 Q 478,243.2 480,240 Q 482,236.8 484,240 Q 486,243.2 488,240 Q 490,236.8 492,240 Q 494,243.2 496,240 Q 498,236.8 500,240 Q 502,243.2 504,240 Q 506,236.8 508,240 Q 510,243.2 512,240 Q 514,236.8 516,240 Q 518,243.2 520,240 Q 522,236.8 524,240 Q 526,243.2 528,240 Q 530,236.8 532,240 Q 534,243.2 536,240" fill="none" stroke="black"></path>
                <path d="M 288,272 L 408,272" fill="none" stroke="black"></path>
                <path d="M 280,304 L 400,304" fill="none" stroke="black"></path>
                <path d="M 408,336 Q 410,332.8 412,336 Q 414,339.2 416,336 Q 418,332.8 420,336 Q 422,339.2 424,336 Q 426,332.8 428,336 Q 430,339.2 432,336 Q 434,332.8 436,336 Q 438,339.2 440,336 Q 442,332.8 444,336 Q 446,339.2 448,336 Q 450,332.8 452,336 Q 454,339.2 456,336 Q 458,332.8 460,336 Q 462,339.2 464,336 Q 466,332.8 468,336 Q 470,339.2 472,336 Q 474,332.8 476,336 Q 478,339.2 480,336 Q 482,332.8 484,336 Q 486,339.2 488,336 Q 490,332.8 492,336 Q 494,339.2 496,336 Q 498,332.8 500,336 Q 502,339.2 504,336 Q 506,332.8 508,336 Q 510,339.2 512,336 Q 514,332.8 516,336 Q 518,339.2 520,336 Q 522,332.8 524,336 Q 526,339.2 528,336" fill="none" stroke="black"></path>
                <path d="M 160,368 L 400,368" fill="none" stroke="black"></path>
                <path d="M 32,384 Q 34,380.8 36,384 Q 38,387.2 40,384 Q 42,380.8 44,384 Q 46,387.2 48,384 Q 50,380.8 52,384 Q 54,387.2 56,384 Q 58,380.8 60,384 Q 62,387.2 64,384 Q 66,380.8 68,384 Q 70,387.2 72,384 Q 74,380.8 76,384 Q 78,387.2 80,384 Q 82,380.8 84,384 Q 86,387.2 88,384 Q 90,380.8 92,384 Q 94,387.2 96,384 Q 98,380.8 100,384 Q 102,387.2 104,384 Q 106,380.8 108,384 Q 110,387.2 112,384 Q 114,380.8 116,384 Q 118,387.2 120,384 Q 122,380.8 124,384 Q 126,387.2 128,384 Q 130,380.8 132,384 Q 134,387.2 136,384 Q 138,380.8 140,384 Q 142,387.2 144,384 Q 146,380.8 148,384 Q 150,387.2 152,384" fill="none" stroke="black"></path>
                <path d="M 408,384 Q 410,380.8 412,384 Q 414,387.2 416,384 Q 418,380.8 420,384 Q 422,387.2 424,384 Q 426,380.8 428,384 Q 430,387.2 432,384 Q 434,380.8 436,384 Q 438,387.2 440,384 Q 442,380.8 444,384 Q 446,387.2 448,384 Q 450,380.8 452,384 Q 454,387.2 456,384 Q 458,380.8 460,384 Q 462,387.2 464,384 Q 466,380.8 468,384 Q 470,387.2 472,384 Q 474,380.8 476,384 Q 478,387.2 480,384 Q 482,380.8 484,384 Q 486,387.2 488,384 Q 490,380.8 492,384 Q 494,387.2 496,384 Q 498,380.8 500,384 Q 502,387.2 504,384 Q 506,380.8 508,384 Q 510,387.2 512,384 Q 514,380.8 516,384 Q 518,387.2 520,384 Q 522,380.8 524,384 Q 526,387.2 528,384 Q 530,380.8 532,384 Q 534,387.2 536,384 Q 538,380.8 540,384 Q 542,387.2 544,384 Q 546,380.8 548,384 Q 550,387.2 552,384 Q 554,380.8 556,384 Q 558,387.2 560,384 Q 562,380.8 564,384 Q 566,387.2 568,384 Q 570,380.8 572,384 Q 574,387.2 576,384 Q 578,380.8 580,384 Q 582,387.2 584,384 Q 586,380.8 588,384 Q 590,387.2 592,384" fill="none" stroke="black"></path>
                <path d="M 408,400 Q 410,396.8 412,400 Q 414,403.2 416,400 Q 418,396.8 420,400 Q 422,403.2 424,400 Q 426,396.8 428,400 Q 430,403.2 432,400 Q 434,396.8 436,400 Q 438,403.2 440,400 Q 442,396.8 444,400 Q 446,403.2 448,400 Q 450,396.8 452,400 Q 454,403.2 456,400 Q 458,396.8 460,400 Q 462,403.2 464,400 Q 466,396.8 468,400 Q 470,403.2 472,400 Q 474,396.8 476,400 Q 478,403.2 480,400 Q 482,396.8 484,400 Q 486,403.2 488,400 Q 490,396.8 492,400 Q 494,403.2 496,400 Q 498,396.8 500,400 Q 502,403.2 504,400 Q 506,396.8 508,400 Q 510,403.2 512,400 Q 514,396.8 516,400 Q 518,403.2 520,400 Q 522,396.8 524,400 Q 526,403.2 528,400" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="600,384 588,378.4 588,389.6" fill="black" transform="rotate(0,592,384)"></polygon>
                <polygon class="arrowhead" points="536,400 524,394.4 524,405.6" fill="black" transform="rotate(0,528,400)"></polygon>
                <polygon class="arrowhead" points="536,336 524,330.4 524,341.6" fill="black" transform="rotate(0,528,336)"></polygon>
                <polygon class="arrowhead" points="536,192 524,186.4 524,197.6" fill="black" transform="rotate(0,528,192)"></polygon>
                <polygon class="arrowhead" points="424,240 412,234.4 412,245.6" fill="black" transform="rotate(180,416,240)"></polygon>
                <polygon class="arrowhead" points="408,368 396,362.4 396,373.6" fill="black" transform="rotate(0,400,368)"></polygon>
                <polygon class="arrowhead" points="408,304 396,298.4 396,309.6" fill="black" transform="rotate(0,400,304)"></polygon>
                <polygon class="arrowhead" points="408,160 396,154.4 396,165.6" fill="black" transform="rotate(0,400,160)"></polygon>
                <polygon class="arrowhead" points="296,272 284,266.4 284,277.6" fill="black" transform="rotate(180,288,272)"></polygon>
                <polygon class="arrowhead" points="280,96 268,90.4 268,101.6" fill="black" transform="rotate(0,272,96)"></polygon>
                <polygon class="arrowhead" points="168,368 156,362.4 156,373.6" fill="black" transform="rotate(180,160,368)"></polygon>
                <polygon class="arrowhead" points="168,128 156,122.4 156,133.6" fill="black" transform="rotate(180,160,128)"></polygon>
                <polygon class="arrowhead" points="152,80 140,74.4 140,85.6" fill="black" transform="rotate(0,144,80)"></polygon>
                <polygon class="arrowhead" points="40,384 28,378.4 28,389.6" fill="black" transform="rotate(180,32,384)"></polygon>
                <polygon class="arrowhead" points="40,160 28,154.4 28,165.6" fill="black" transform="rotate(180,32,160)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientB1</text>
                  <text x="152" y="36">ServerB</text>
                  <text x="280" y="36">ServerA</text>
                  <text x="408" y="36">ServerC</text>
                  <text x="540" y="36">ClientC1</text>
                  <text x="596" y="36">C2</text>
                  <text x="72" y="68">Proposals</text>
                  <text x="192" y="84">/update</text>
                  <text x="232" y="116">200</text>
                  <text x="260" y="116">OK</text>
                  <text x="108" y="148">Accepted</text>
                  <text x="328" y="148">/notify</text>
                  <text x="456" y="180">Proposals</text>
                  <text x="472" y="228">Commit(Props)</text>
                  <text x="368" y="260">/update</text>
                  <text x="304" y="292">200</text>
                  <text x="332" y="292">OK</text>
                  <text x="452" y="324">Accepted</text>
                  <text x="240" y="356">/notify</text>
                  <text x="320" y="356">/notify</text>
                  <text x="116" y="372">Commit</text>
                  <text x="444" y="372">Commit</text>
                  <text x="40" y="452">ClientB1:</text>
                  <text x="112" y="452">Prepare</text>
                  <text x="180" y="452">Remove*,</text>
                  <text x="272" y="452">AppSync(-Bob)</text>
                  <text x="76" y="468">ClientB1-&gt;ServerB:</text>
                  <text x="164" y="468">[[</text>
                  <text x="212" y="468">Remove*,</text>
                  <text x="280" y="468">AppSync</text>
                  <text x="324" y="468">]]</text>
                  <text x="72" y="484">ServerB-&gt;ServerA:</text>
                  <text x="164" y="484">POST</text>
                  <text x="304" y="484">/update/a.example/r/clubhouse</text>
                  <text x="460" y="484">Remove*,</text>
                  <text x="528" y="484">AppSync</text>
                  <text x="36" y="500">ServerA:</text>
                  <text x="100" y="500">Verify</text>
                  <text x="148" y="500">that</text>
                  <text x="204" y="500">Removes,</text>
                  <text x="272" y="500">AppSync</text>
                  <text x="320" y="500">are</text>
                  <text x="368" y="500">allowed</text>
                  <text x="412" y="500">by</text>
                  <text x="456" y="500">policy;</text>
                  <text x="512" y="500">cache</text>
                  <text x="72" y="516">ServerA-&gt;ServerB:</text>
                  <text x="160" y="516">200</text>
                  <text x="188" y="516">OK</text>
                  <text x="72" y="532">ServerA-&gt;ServerC:</text>
                  <text x="164" y="532">POST</text>
                  <text x="304" y="532">/notify/a.example/r/clubhouse</text>
                  <text x="464" y="532">Proposals</text>
                  <text x="80" y="548">ServerC1-&gt;ClientC1:</text>
                  <text x="172" y="548">[[</text>
                  <text x="224" y="548">Proposals</text>
                  <text x="276" y="548">]]</text>
                  <text x="76" y="564">ClientC1-&gt;ServerC:</text>
                  <text x="164" y="564">[[</text>
                  <text x="236" y="564">Commit(Props),</text>
                  <text x="332" y="564">Welcome,</text>
                  <text x="416" y="564">GroupInfo?,</text>
                  <text x="516" y="564">RatchetTree?</text>
                  <text x="580" y="564">]]</text>
                  <text x="72" y="580">ServerC-&gt;ServerA:</text>
                  <text x="164" y="580">POST</text>
                  <text x="308" y="580">/update/a.example/r/clubhousee</text>
                  <text x="484" y="580">CommitBundle</text>
                  <text x="36" y="596">ServerA:</text>
                  <text x="96" y="596">Check</text>
                  <text x="152" y="596">whether</text>
                  <text x="212" y="596">Commit</text>
                  <text x="276" y="596">includes</text>
                  <text x="340" y="596">queued</text>
                  <text x="412" y="596">proposals;</text>
                  <text x="484" y="596">accept</text>
                  <text x="72" y="612">ServerA-&gt;ServerC:</text>
                  <text x="160" y="612">200</text>
                  <text x="188" y="612">OK</text>
                  <text x="72" y="628">ServerA-&gt;ServerB:</text>
                  <text x="164" y="628">POST</text>
                  <text x="304" y="628">/notify/a.example/r/clubhouse</text>
                  <text x="452" y="628">Commit</text>
                  <text x="72" y="644">ServerA-&gt;ServerC:</text>
                  <text x="164" y="644">POST</text>
                  <text x="304" y="644">/notify/a.example/r/clubhouse</text>
                  <text x="452" y="644">Commit</text>
                  <text x="76" y="660">ServerB-&gt;ClientB1:</text>
                  <text x="164" y="660">[[</text>
                  <text x="204" y="660">Commit</text>
                  <text x="244" y="660">]]</text>
                  <text x="76" y="676">ServerC-&gt;ClientC2:</text>
                  <text x="164" y="676">[[</text>
                  <text x="204" y="676">Commit</text>
                  <text x="244" y="676">]]</text>
                  <text x="76" y="692">ServerC-&gt;ClientC1:</text>
                  <text x="164" y="692">[[</text>
                  <text x="204" y="692">Commit</text>
                  <text x="244" y="692">]]</text>
                  <text x="272" y="692">(up</text>
                  <text x="300" y="692">to</text>
                  <text x="352" y="692">provider)</text>
                </g>
              </svg><a href="#section-3.5-5.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-7" class="selfRef">Figure 7</a>:
<a href="#name-bob-leaves-the-room-2" class="selfRef">Bob Leaves the Room</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="cathy-adds-a-new-device">
<section id="section-3.6">
        <h3 id="name-cathy-adds-a-new-device">
<a href="#section-3.6" class="section-number selfRef">3.6. </a><a href="#name-cathy-adds-a-new-device" class="section-name selfRef">Cathy adds a new device</a>
        </h3>
<p id="section-3.6-1">Many users have multiple clients often running on different devices
(for example a phone, a tablet, and a computer). When a user creates a new
client, that client needs to be able to join all the MLS groups associated
with the rooms in which the user is a participant.<a href="#section-3.6-1" class="pilcrow">¶</a></p>
<p id="section-3.6-2">In MLS in order to initiate joining a group the joining client needs to get the current GroupInfo
and <code>ratchet_tree</code>, and then send an External Commit to the hub. In MIMI,
the hub keeps or reconstructs a copy of the GroupInfo, assuming that other
clients may not be available to assist the client with joining.<a href="#section-3.6-2" class="pilcrow">¶</a></p>
<p id="section-3.6-3">For Cathy's new client (ClientC3) to join the MLS group and therefore fully participate
in the room with Alice, ClientC3 needs to fetch the MLS GroupInfo, and then
generate an External Commit adding ClientC3.<a href="#section-3.6-3" class="pilcrow">¶</a></p>
<p id="section-3.6-4">Cathy's new client sends the External Commit to the room's MLS group by sending
an /update to the room.<a href="#section-3.6-4" class="pilcrow">¶</a></p>
<span id="name-cathy-adds-a-new-client"></span><div id="fig-c3-new-client">
<figure id="figure-8">
          <div id="section-3.6-5.1">
            <div class="alignLeft art-svg artwork" id="section-3.6-5.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="736" width="736" viewBox="0 0 736 736" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 24,48 L 24,448" fill="none" stroke="black"></path>
                <path d="M 152,48 L 152,448" fill="none" stroke="black"></path>
                <path d="M 280,48 L 280,416" fill="none" stroke="black"></path>
                <path d="M 408,48 L 408,288" fill="none" stroke="black"></path>
                <path d="M 408,320 L 408,416" fill="none" stroke="black"></path>
                <path d="M 536,48 L 536,288" fill="none" stroke="black"></path>
                <path d="M 536,320 L 536,416" fill="none" stroke="black"></path>
                <path d="M 616,48 L 616,288" fill="none" stroke="black"></path>
                <path d="M 616,320 L 616,448" fill="none" stroke="black"></path>
                <path d="M 696,48 L 696,448" fill="none" stroke="black"></path>
                <path d="M 32,96 Q 34,92.8 36,96 Q 38,99.2 40,96 Q 42,92.8 44,96 Q 46,99.2 48,96 Q 50,92.8 52,96 Q 54,99.2 56,96 Q 58,92.8 60,96 Q 62,99.2 64,96 Q 66,92.8 68,96 Q 70,99.2 72,96 Q 74,92.8 76,96 Q 78,99.2 80,96 Q 82,92.8 84,96 Q 86,99.2 88,96 Q 90,92.8 92,96 Q 94,99.2 96,96 Q 98,92.8 100,96 Q 102,99.2 104,96 Q 106,92.8 108,96 Q 110,99.2 112,96 Q 114,92.8 116,96 Q 118,99.2 120,96 Q 122,92.8 124,96 Q 126,99.2 128,96 Q 130,92.8 132,96 Q 134,99.2 136,96 Q 138,92.8 140,96 Q 142,99.2 144,96" fill="none" stroke="black"></path>
                <path d="M 160,112 L 272,112" fill="none" stroke="black"></path>
                <path d="M 160,144 L 272,144" fill="none" stroke="black"></path>
                <path d="M 32,160 Q 34,156.8 36,160 Q 38,163.2 40,160 Q 42,156.8 44,160 Q 46,163.2 48,160 Q 50,156.8 52,160 Q 54,163.2 56,160 Q 58,156.8 60,160 Q 62,163.2 64,160 Q 66,156.8 68,160 Q 70,163.2 72,160 Q 74,156.8 76,160 Q 78,163.2 80,160 Q 82,156.8 84,160 Q 86,163.2 88,160 Q 90,156.8 92,160 Q 94,163.2 96,160 Q 98,156.8 100,160 Q 102,163.2 104,160 Q 106,156.8 108,160 Q 110,163.2 112,160 Q 114,156.8 116,160 Q 118,163.2 120,160 Q 122,156.8 124,160 Q 126,163.2 128,160 Q 130,156.8 132,160 Q 134,163.2 136,160 Q 138,156.8 140,160 Q 142,163.2 144,160" fill="none" stroke="black"></path>
                <path d="M 24,224 Q 26,220.8 28,224 Q 30,227.2 32,224 Q 34,220.8 36,224 Q 38,227.2 40,224 Q 42,220.8 44,224 Q 46,227.2 48,224 Q 50,220.8 52,224 Q 54,227.2 56,224 Q 58,220.8 60,224 Q 62,227.2 64,224 Q 66,220.8 68,224 Q 70,227.2 72,224 Q 74,220.8 76,224 Q 78,227.2 80,224 Q 82,220.8 84,224 Q 86,227.2 88,224 Q 90,220.8 92,224 Q 94,227.2 96,224 Q 98,220.8 100,224 Q 102,227.2 104,224 Q 106,220.8 108,224 Q 110,227.2 112,224 Q 114,220.8 116,224 Q 118,227.2 120,224 Q 122,220.8 124,224 Q 126,227.2 128,224 Q 130,220.8 132,224 Q 134,227.2 136,224 Q 138,220.8 140,224 Q 142,227.2 144,224" fill="none" stroke="black"></path>
                <path d="M 152,240 L 272,240" fill="none" stroke="black"></path>
                <path d="M 160,272 L 280,272" fill="none" stroke="black"></path>
                <path d="M 32,304 Q 34,300.8 36,304 Q 38,307.2 40,304 Q 42,300.8 44,304 Q 46,307.2 48,304 Q 50,300.8 52,304 Q 54,307.2 56,304 Q 58,300.8 60,304 Q 62,307.2 64,304 Q 66,300.8 68,304 Q 70,307.2 72,304 Q 74,300.8 76,304 Q 78,307.2 80,304 Q 82,300.8 84,304 Q 86,307.2 88,304 Q 90,300.8 92,304 Q 94,307.2 96,304 Q 98,300.8 100,304 Q 102,307.2 104,304 Q 106,300.8 108,304 Q 110,307.2 112,304 Q 114,300.8 116,304 Q 118,307.2 120,304 Q 122,300.8 124,304 Q 126,307.2 128,304 Q 130,300.8 132,304 Q 134,307.2 136,304 Q 138,300.8 140,304 Q 142,307.2 144,304" fill="none" stroke="black"></path>
                <path d="M 280,304 Q 282,300.8 284,304 Q 286,307.2 288,304 Q 290,300.8 292,304 Q 294,307.2 296,304 Q 298,300.8 300,304 Q 302,307.2 304,304 Q 306,300.8 308,304 Q 310,307.2 312,304 Q 314,300.8 316,304 Q 318,307.2 320,304 Q 322,300.8 324,304 Q 326,307.2 328,304 Q 330,300.8 332,304 Q 334,307.2 336,304 Q 338,300.8 340,304 Q 342,307.2 344,304 Q 346,300.8 348,304 Q 350,307.2 352,304 Q 354,300.8 356,304 Q 358,307.2 360,304 Q 362,300.8 364,304 Q 366,307.2 368,304 Q 370,300.8 372,304 Q 374,307.2 376,304 Q 378,300.8 380,304 Q 382,307.2 384,304 Q 386,300.8 388,304 Q 390,307.2 392,304 Q 394,300.8 396,304 Q 398,307.2 400,304 Q 402,300.8 404,304 Q 406,307.2 408,304 Q 410,300.8 412,304 Q 414,307.2 416,304 Q 418,300.8 420,304 Q 422,307.2 424,304 Q 426,300.8 428,304 Q 430,307.2 432,304 Q 434,300.8 436,304 Q 438,307.2 440,304 Q 442,300.8 444,304 Q 446,307.2 448,304 Q 450,300.8 452,304 Q 454,307.2 456,304 Q 458,300.8 460,304 Q 462,307.2 464,304 Q 466,300.8 468,304 Q 470,307.2 472,304 Q 474,300.8 476,304 Q 478,307.2 480,304 Q 482,300.8 484,304 Q 486,307.2 488,304 Q 490,300.8 492,304 Q 494,307.2 496,304 Q 498,300.8 500,304 Q 502,307.2 504,304 Q 506,300.8 508,304 Q 510,307.2 512,304 Q 514,300.8 516,304 Q 518,307.2 520,304 Q 522,300.8 524,304 Q 526,307.2 528,304 Q 530,300.8 532,304 Q 534,307.2 536,304 Q 538,300.8 540,304 Q 542,307.2 544,304 Q 546,300.8 548,304 Q 550,307.2 552,304 Q 554,300.8 556,304 Q 558,307.2 560,304 Q 562,300.8 564,304 Q 566,307.2 568,304 Q 570,300.8 572,304 Q 574,307.2 576,304 Q 578,300.8 580,304 Q 582,307.2 584,304 Q 586,300.8 588,304 Q 590,307.2 592,304 Q 594,300.8 596,304 Q 598,307.2 600,304 Q 602,300.8 604,304 Q 606,307.2 608,304 Q 610,300.8 612,304 Q 614,307.2 616,304 Q 618,300.8 620,304 Q 622,307.2 624,304 Q 626,300.8 628,304 Q 630,307.2 632,304 Q 634,300.8 636,304 Q 638,307.2 640,304 Q 642,300.8 644,304 Q 646,307.2 648,304 Q 650,300.8 652,304 Q 654,307.2 656,304 Q 658,300.8 660,304 Q 662,307.2 664,304 Q 666,300.8 668,304 Q 670,307.2 672,304 Q 674,300.8 676,304 Q 678,307.2 680,304 Q 682,300.8 684,304 Q 686,307.2 688,304" fill="none" stroke="black"></path>
                <path d="M 280,352 L 400,352" fill="none" stroke="black"></path>
                <path d="M 408,368 Q 410,364.8 412,368 Q 414,371.2 416,368 Q 418,364.8 420,368 Q 422,371.2 424,368 Q 426,364.8 428,368 Q 430,371.2 432,368 Q 434,364.8 436,368 Q 438,371.2 440,368 Q 442,364.8 444,368 Q 446,371.2 448,368 Q 450,364.8 452,368 Q 454,371.2 456,368 Q 458,364.8 460,368 Q 462,371.2 464,368 Q 466,364.8 468,368 Q 470,371.2 472,368 Q 474,364.8 476,368 Q 478,371.2 480,368 Q 482,364.8 484,368 Q 486,371.2 488,368 Q 490,364.8 492,368 Q 494,371.2 496,368 Q 498,364.8 500,368 Q 502,371.2 504,368 Q 506,364.8 508,368 Q 510,371.2 512,368 Q 514,364.8 516,368 Q 518,371.2 520,368 Q 522,364.8 524,368 Q 526,371.2 528,368" fill="none" stroke="black"></path>
                <path d="M 160,400 L 280,400" fill="none" stroke="black"></path>
                <path d="M 152,432 Q 154,428.8 156,432 Q 158,435.2 160,432 Q 162,428.8 164,432 Q 166,435.2 168,432 Q 170,428.8 172,432 Q 174,435.2 176,432 Q 178,428.8 180,432 Q 182,435.2 184,432 Q 186,428.8 188,432 Q 190,435.2 192,432 Q 194,428.8 196,432 Q 198,435.2 200,432 Q 202,428.8 204,432 Q 206,435.2 208,432 Q 210,428.8 212,432 Q 214,435.2 216,432 Q 218,428.8 220,432 Q 222,435.2 224,432 Q 226,428.8 228,432 Q 230,435.2 232,432 Q 234,428.8 236,432 Q 238,435.2 240,432 Q 242,428.8 244,432 Q 246,435.2 248,432 Q 250,428.8 252,432 Q 254,435.2 256,432 Q 258,428.8 260,432 Q 262,435.2 264,432 Q 266,428.8 268,432 Q 270,435.2 272,432 Q 274,428.8 276,432 Q 278,435.2 280,432 Q 282,428.8 284,432 Q 286,435.2 288,432 Q 290,428.8 292,432 Q 294,435.2 296,432 Q 298,428.8 300,432 Q 302,435.2 304,432 Q 306,428.8 308,432 Q 310,435.2 312,432 Q 314,428.8 316,432 Q 318,435.2 320,432 Q 322,428.8 324,432 Q 326,435.2 328,432 Q 330,428.8 332,432 Q 334,435.2 336,432 Q 338,428.8 340,432 Q 342,435.2 344,432 Q 346,428.8 348,432 Q 350,435.2 352,432 Q 354,428.8 356,432 Q 358,435.2 360,432 Q 362,428.8 364,432 Q 366,435.2 368,432 Q 370,428.8 372,432 Q 374,435.2 376,432 Q 378,428.8 380,432 Q 382,435.2 384,432 Q 386,428.8 388,432 Q 390,435.2 392,432 Q 394,428.8 396,432 Q 398,435.2 400,432 Q 402,428.8 404,432 Q 406,435.2 408,432 Q 410,428.8 412,432 Q 414,435.2 416,432 Q 418,428.8 420,432 Q 422,435.2 424,432 Q 426,428.8 428,432 Q 430,435.2 432,432 Q 434,428.8 436,432 Q 438,435.2 440,432 Q 442,428.8 444,432 Q 446,435.2 448,432 Q 450,428.8 452,432 Q 454,435.2 456,432 Q 458,428.8 460,432 Q 462,435.2 464,432 Q 466,428.8 468,432 Q 470,435.2 472,432 Q 474,428.8 476,432 Q 478,435.2 480,432 Q 482,428.8 484,432 Q 486,435.2 488,432 Q 490,428.8 492,432 Q 494,435.2 496,432 Q 498,428.8 500,432 Q 502,435.2 504,432 Q 506,428.8 508,432 Q 510,435.2 512,432 Q 514,428.8 516,432 Q 518,435.2 520,432 Q 522,428.8 524,432 Q 526,435.2 528,432 Q 530,428.8 532,432 Q 534,435.2 536,432 Q 538,428.8 540,432 Q 542,435.2 544,432 Q 546,428.8 548,432 Q 550,435.2 552,432 Q 554,428.8 556,432 Q 558,435.2 560,432 Q 562,428.8 564,432 Q 566,435.2 568,432 Q 570,428.8 572,432 Q 574,435.2 576,432 Q 578,428.8 580,432 Q 582,435.2 584,432 Q 586,428.8 588,432 Q 590,435.2 592,432 Q 594,428.8 596,432 Q 598,435.2 600,432 Q 602,428.8 604,432 Q 606,435.2 608,432" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="696,304 684,298.4 684,309.6" fill="black" transform="rotate(0,688,304)"></polygon>
                <polygon class="arrowhead" points="616,432 604,426.4 604,437.6" fill="black" transform="rotate(0,608,432)"></polygon>
                <polygon class="arrowhead" points="536,368 524,362.4 524,373.6" fill="black" transform="rotate(0,528,368)"></polygon>
                <polygon class="arrowhead" points="408,352 396,346.4 396,357.6" fill="black" transform="rotate(0,400,352)"></polygon>
                <polygon class="arrowhead" points="280,240 268,234.4 268,245.6" fill="black" transform="rotate(0,272,240)"></polygon>
                <polygon class="arrowhead" points="280,112 268,106.4 268,117.6" fill="black" transform="rotate(0,272,112)"></polygon>
                <polygon class="arrowhead" points="168,400 156,394.4 156,405.6" fill="black" transform="rotate(180,160,400)"></polygon>
                <polygon class="arrowhead" points="168,272 156,266.4 156,277.6" fill="black" transform="rotate(180,160,272)"></polygon>
                <polygon class="arrowhead" points="168,144 156,138.4 156,149.6" fill="black" transform="rotate(180,160,144)"></polygon>
                <polygon class="arrowhead" points="152,224 140,218.4 140,229.6" fill="black" transform="rotate(0,144,224)"></polygon>
                <polygon class="arrowhead" points="152,96 140,90.4 140,101.6" fill="black" transform="rotate(0,144,96)"></polygon>
                <polygon class="arrowhead" points="40,304 28,298.4 28,309.6" fill="black" transform="rotate(180,32,304)"></polygon>
                <polygon class="arrowhead" points="40,160 28,154.4 28,165.6" fill="black" transform="rotate(180,32,160)"></polygon>
                <g class="text">
                  <text x="36" y="36">ClientC3</text>
                  <text x="152" y="36">ServerC</text>
                  <text x="280" y="36">ServerA</text>
                  <text x="408" y="36">ServerB</text>
                  <text x="540" y="36">ClientB*</text>
                  <text x="620" y="36">ClientC*</text>
                  <text x="700" y="36">ClientA*</text>
                  <text x="56" y="68">Fetch</text>
                  <text x="72" y="84">GroupInfo</text>
                  <text x="204" y="100">/groupInfo</text>
                  <text x="72" y="132">GroupInfo</text>
                  <text x="120" y="132">+</text>
                  <text x="232" y="132">200</text>
                  <text x="260" y="132">OK</text>
                  <text x="52" y="148">tree</text>
                  <text x="68" y="196">External</text>
                  <text x="64" y="212">Commit,</text>
                  <text x="116" y="212">etc.</text>
                  <text x="192" y="228">/update</text>
                  <text x="232" y="260">200</text>
                  <text x="260" y="260">OK</text>
                  <text x="108" y="292">Accepted</text>
                  <text x="316" y="292">Commit</text>
                  <text x="320" y="340">/notify</text>
                  <text x="444" y="356">Commit</text>
                  <text x="240" y="388">/notify</text>
                  <text x="188" y="420">Commit</text>
                  <text x="280" y="452">|</text>
                  <text x="408" y="452">|</text>
                  <text x="536" y="452">|</text>
                  <text x="76" y="484">ClientC3-&gt;ServerC:</text>
                  <text x="164" y="484">[[</text>
                  <text x="208" y="484">request</text>
                  <text x="272" y="484">current</text>
                  <text x="344" y="484">GroupInfo</text>
                  <text x="396" y="484">]]</text>
                  <text x="72" y="500">ServerC-&gt;ServerA:</text>
                  <text x="164" y="500">POST</text>
                  <text x="308" y="500">/groupInfo/a.example/clubhouse</text>
                  <text x="36" y="516">ServerA:</text>
                  <text x="100" y="516">Verify</text>
                  <text x="148" y="516">that</text>
                  <text x="204" y="516">ClientC3</text>
                  <text x="256" y="516">has</text>
                  <text x="328" y="516">authorization</text>
                  <text x="396" y="516">to</text>
                  <text x="428" y="516">join</text>
                  <text x="464" y="516">the</text>
                  <text x="500" y="516">room</text>
                  <text x="72" y="532">ServerA-&gt;ServerC:</text>
                  <text x="160" y="532">200</text>
                  <text x="188" y="532">OK</text>
                  <text x="212" y="532">w/</text>
                  <text x="256" y="532">current</text>
                  <text x="328" y="532">GroupInfo</text>
                  <text x="384" y="532">and</text>
                  <text x="432" y="532">ratchet</text>
                  <text x="484" y="532">tree</text>
                  <text x="76" y="548">ServerC-&gt;ClientC3:</text>
                  <text x="164" y="548">[[</text>
                  <text x="220" y="548">GroupInfo,</text>
                  <text x="284" y="548">tree</text>
                  <text x="316" y="548">]]</text>
                  <text x="40" y="564">ClientC3:</text>
                  <text x="112" y="564">Prepare</text>
                  <text x="180" y="564">External</text>
                  <text x="244" y="564">Commit</text>
                  <text x="292" y="564">Add*</text>
                  <text x="76" y="580">ClientC3-&gt;ServerC:</text>
                  <text x="164" y="580">[[</text>
                  <text x="208" y="580">Commit,</text>
                  <text x="288" y="580">GroupInfo?,</text>
                  <text x="388" y="580">RatchetTree?</text>
                  <text x="452" y="580">]]</text>
                  <text x="72" y="596">ServerC-&gt;ServerA:</text>
                  <text x="164" y="596">POST</text>
                  <text x="296" y="596">/update/a.example/clubhouse</text>
                  <text x="460" y="596">CommitBundle</text>
                  <text x="36" y="612">ServerA:</text>
                  <text x="100" y="612">Verify</text>
                  <text x="148" y="612">that</text>
                  <text x="196" y="612">Commit</text>
                  <text x="236" y="612">is</text>
                  <text x="272" y="612">valid</text>
                  <text x="312" y="612">and</text>
                  <text x="364" y="612">ClientC3</text>
                  <text x="412" y="612">is</text>
                  <text x="468" y="612">authorized</text>
                  <text x="72" y="628">ServerA-&gt;ServerC:</text>
                  <text x="160" y="628">200</text>
                  <text x="188" y="628">OK</text>
                  <text x="76" y="644">ServerC-&gt;ClientC3:</text>
                  <text x="164" y="644">[[</text>
                  <text x="212" y="644">External</text>
                  <text x="276" y="644">Commit</text>
                  <text x="320" y="644">was</text>
                  <text x="372" y="644">accepted</text>
                  <text x="420" y="644">]]</text>
                  <text x="76" y="660">ServerA-&gt;ClientA*:</text>
                  <text x="164" y="660">[[</text>
                  <text x="204" y="660">Commit</text>
                  <text x="244" y="660">]]</text>
                  <text x="72" y="676">ServerA-&gt;ServerB:</text>
                  <text x="164" y="676">POST</text>
                  <text x="296" y="676">/notify/a.example/clubhouse</text>
                  <text x="436" y="676">Commit</text>
                  <text x="76" y="692">ServerB-&gt;ClientB*:</text>
                  <text x="164" y="692">[[</text>
                  <text x="204" y="692">Commit</text>
                  <text x="244" y="692">]]</text>
                  <text x="72" y="708">ServerA-&gt;ServerC:</text>
                  <text x="164" y="708">POST</text>
                  <text x="296" y="708">/notify/a.example/clubhouse</text>
                  <text x="436" y="708">Commit</text>
                  <text x="76" y="724">ServerC-&gt;ClientC*:</text>
                  <text x="164" y="724">[[</text>
                  <text x="204" y="724">Commit</text>
                  <text x="244" y="724">]]</text>
                </g>
              </svg><a href="#section-3.6-5.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-8" class="selfRef">Figure 8</a>:
<a href="#name-cathy-adds-a-new-client" class="selfRef">Cathy Adds a new Client</a>
          </figcaption></figure>
</div>
</section>
</div>
</section>
</div>
<div id="services-required-at-each-layer">
<section id="section-4">
      <h2 id="name-services-required-at-each-l">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-services-required-at-each-l" class="section-name selfRef">Services required at each layer</a>
      </h2>
<div id="transport-layer">
<section id="section-4.1">
        <h3 id="name-transport-layer">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-transport-layer" class="section-name selfRef">Transport layer</a>
        </h3>
<p id="section-4.1-1">MIMI servers communicate using HTTPS.  The HTTP request <span class="bcp14">MUST</span> identify the
source and target providers for the request, in the following way:<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1-2.1">
            <p id="section-4.1-2.1.1">The target provider is indicated using a Host header <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>.  If the
provider is using a non-standard port, then the port component of the Host
header is ignored.<a href="#section-4.1-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.1-2.2">
            <p id="section-4.1-2.2.1">The source provider is indicated using a From header <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>.  The
<code>mailbox</code> production in the From header <span class="bcp14">MUST</span> use the <code>addr-spec</code> variant, and
the <code>local-part</code> of the address <span class="bcp14">MUST</span> contain the fixed string <code>mimi</code>.  Thus,
the content of the From header will be <code>mimi@a.example</code>, where <code>a.example</code> is
the domain name of the source provider.<a href="#section-4.1-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.1-3.1">
            <p id="section-4.1-3.1.1"><strong>NOTE</strong>: The use of the From header field here is not really well-aligned with its
  intended use.  The WG should consider whether this is correct, or whether a new
  header field would be better.  Perhaps something like "From-Host" to match Host?<a href="#section-4.1-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-4.1-4">The TLS connection underlying the HTTPS connection <span class="bcp14">MUST</span> be mutually
authenticated.  The certificates presented in the TLS handshake <span class="bcp14">MUST</span>
authenticate the source and target provider domains, according to <span>[<a href="#RFC6125" class="cite xref">RFC6125</a>]</span>.<a href="#section-4.1-4" class="pilcrow">¶</a></p>
<p id="section-4.1-5">The bodies of HTTP requests and responses are defined by the individual
endpoints defined in <a href="#application-layer" class="auto internal xref">Section 4.3</a>.<a href="#section-4.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="end-to-end-security-layer">
<section id="section-4.2">
        <h3 id="name-end-to-end-security-layer">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-end-to-end-security-layer" class="section-name selfRef">End-to-End Security Layer</a>
        </h3>
<p id="section-4.2-1">Every MIMI room has an MLS group associated to it, which provides end-to-end
security guarantees.  The clients participating in the room manage the MLS-level
membership by sending Commit messages covering Add and Remove proposals.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<p id="section-4.2-2">Every application message sent within a room is authenticated and confidentiality-protected
by virtue of being encapsulated in an MLS PrivateMessage object.<a href="#section-4.2-2" class="pilcrow">¶</a></p>
<p id="section-4.2-3">MIMI uses the MLS application state synchronization mechanism
(<span>[<a href="#I-D.barnes-mls-appsync" class="cite xref">I-D.barnes-mls-appsync</a>]</span>) to ensure that the clients involved
in a MIMI room agree on the state of the room.  Each MIMI message that changes
the state of the room is encapsulated in an AppSync proposal and transmitted
inside an MLS PublicMessage object.<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<p id="section-4.2-4">The PublicMessage encapsulation provides sender authentication, including the
ability for actors outside the group (e.g., servers involved in the room) to
originate AppSync proposals.  Encoding room state changes in MLS proposals
ensures that a client will not process a commit that confirms a state change
before processing the state change itself.<a href="#section-4.2-4" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-4.2-5.1">
            <p id="section-4.2-5.1.1"><strong>TODO</strong>: A little more needs to be said here about how MLS is used.  For
example: What types of credential are required / allowed?  If servers are going
to be allowed to introduce room changes, how are their keys provisioned as
external signers? Need to maintain the membership and the list of queued proposals.<a href="#section-4.2-5.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="application-layer">
<section id="section-4.3">
        <h3 id="name-application-layer">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-application-layer" class="section-name selfRef">Application Layer</a>
        </h3>
<p id="section-4.3-1">Servers in MIMI provide a few functions that enable messaging applications.
All servers act as publication points for key material used to add their users
to rooms. The hub server for a room tracks the state of the room, and controls
how the room's state evolves, e.g., by ensuring that changes are compliant with
the room's policy. Non-hub servers facilitate interactions between their clients
and the hub server.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.3-2">In this section, we describe the state that servers keep. The following top
level section describes the HTTP endpoints exposed to enable these functions.<a href="#section-4.3-2" class="pilcrow">¶</a></p>
<div id="server-state">
<section id="section-4.3.1">
          <h4 id="name-server-state">
<a href="#section-4.3.1" class="section-number selfRef">4.3.1. </a><a href="#name-server-state" class="section-name selfRef">Server State</a>
          </h4>
<p id="section-4.3.1-1">Every MIMI server is a publication point for users' key material, via the
<code>keyMaterial</code> endpoint discussed in <a href="#fetch-key-material" class="auto internal xref">Section 5.2</a>.  To support this
endpoint, the server stores a set of KeyPackages, where each KeyPackage belongs
to a specific user and device.<a href="#section-4.3.1-1" class="pilcrow">¶</a></p>
<p id="section-4.3.1-2">Each KeyPackage includes a list of its MLS client's capabilities (MLS
protocol versions, cipher suites, extensions, proposal types, and credential
types). When claiming KeyPackages, the requester includes the list of
<code>RequiredCapabilites</code> to ensure the new joiner is compatible with and
capable of participating in the corresponding room.<a href="#section-4.3.1-2" class="pilcrow">¶</a></p>
<p id="section-4.3.1-3">The hub server for the room stores the state of the room, comprising:<a href="#section-4.3.1-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.3.1-4.1">
              <p id="section-4.3.1-4.1.1">The <em>base policy</em> of the room, which does not depend on the specific
participants in the room. For example, this includes the room <em>roles</em>
and their permissions (defined in <span>[<a href="#I-D.ietf-mimi-room-policy" class="cite xref">I-D.ietf-mimi-room-policy</a>]</span> and
<em>preauthorization</em> policy).<a href="#section-4.3.1-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.3.1-4.2">
              <p id="section-4.3.1-4.2.1">The <em>participant list</em>: a list of the users who are participants of the
room, and each user's role in the room (defined in <a href="#participant-list" class="auto internal xref">Section 7.5</a>).<a href="#section-4.3.1-4.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.3.1-4.3">
              <p id="section-4.3.1-4.3.1">Room metadata, such as the room name, description, and image (defined in
<a href="#room-metadata" class="auto internal xref">Section 7.6</a>).<a href="#section-4.3.1-4.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.3.1-5">When a client requests key material via the hub, the hub records the
KeyPackageRef values for the returned KeyPackages, and the identity of the
provider from which they were received.  This information is then used to route
Welcome message to the proper provider.<a href="#section-4.3.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="participant-list-changes">
<section id="section-4.3.2">
          <h4 id="name-participant-list-changes">
<a href="#section-4.3.2" class="section-number selfRef">4.3.2. </a><a href="#name-participant-list-changes" class="section-name selfRef">Participant List Changes</a>
          </h4>
<p id="section-4.3.2-1">The participant list can be changed by adding or removing users, or changing
a user's role.  These changes are described as a list of adds, removes, and
role changes, as described in <a href="#participant-list" class="auto internal xref">Section 7.5</a>.<a href="#section-4.3.2-1" class="pilcrow">¶</a></p>
<span id="name-changing-the-state-of-the-r"></span><div id="fig-room-state-change">
<figure id="figure-9">
            <div class="alignLeft art-ascii-art art-text artwork" id="section-4.3.2-2.1">
<pre>
Add: ["mimi://d.example/u/diana", role: 4 (admin)],
     ["mimi://e.example/u/eric", role: 3 (moderator)],
Remove: ["mimi://b.example/u/bob"],
SetRole: [["mimi://c.example/u/cathy", role: 1 (banned)]]
</pre>
</div>
<figcaption><a href="#figure-9" class="selfRef">Figure 9</a>:
<a href="#name-changing-the-state-of-the-r" class="selfRef">Changing the state of the room</a>
            </figcaption></figure>
</div>
<p id="section-4.3.2-3">To put these changes into effect, a client or server encodes them in an
AppDataUpdate <span>[<a href="#I-D.ietf-mls-extensions" class="cite xref">I-D.ietf-mls-extensions</a>]</span> proposal, signs the proposal as a
PublicMessage, and submits them to the <code>update</code> endpoint on the hub.<a href="#section-4.3.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="mimi-endpoints-and-framing">
<section id="section-5">
      <h2 id="name-mimi-endpoints-and-framing">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-mimi-endpoints-and-framing" class="section-name selfRef">MIMI Endpoints and Framing</a>
      </h2>
<p id="section-5-1">This section describes the specific endpoints necessary to provide the
functionality in the example flow. The framing for each endpoint includes a
protocol so that different variations of the end-to-end encryption can be used.<a href="#section-5-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5-2.1">
          <p id="section-5-2.1.1"><strong>TODO</strong>: Determine the what needs to be included in the protocol. MIMI
  version, e2e protocol version, etc.<a href="#section-5-2.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-5-3">The syntax of the MIMI protocol messages are described using the TLS
presentation language format (<span><a href="https://rfc-editor.org/rfc/rfc8446#section-3" class="relref">Section 3</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>).<a href="#section-5-3" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5-4">
<pre>
enum {
    reserved(0),
    mls10(1),
    (255)
} Protocol;
</pre><a href="#section-5-4" class="pilcrow">¶</a>
</div>
<div id="directory">
<section id="section-5.1">
        <h3 id="name-directory">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-directory" class="section-name selfRef">Directory</a>
        </h3>
<p id="section-5.1-1">Like the ACME protocol (See <span><a href="https://rfc-editor.org/rfc/rfc8555#section-7.1.1" class="relref">Section 7.1.1</a> of [<a href="#RFC8555" class="cite xref">RFC8555</a>]</span>), the MIMI protocol uses a directory document
to convey the HTTPS URLs used to reach certain endpoints (as opposed to hard
coding the endpoints).<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1-2">The directory URL is discovered using the <code>mimi-protocol-directory</code> well-known
URI. The response is a JSON document with URIs for each type of endpoint.<a href="#section-5.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.1-3">
<pre>
GET /.well-known/mimi-protocol-directory
</pre><a href="#section-5.1-3" class="pilcrow">¶</a>
</div>
<div class="alignLeft art-text artwork" id="section-5.1-4">
<pre>
{
  "keyMaterial":
     "https://mimi.example.com/v1/keyMaterial/{targetUser}",
  "update": "https://mimi.example.com/v1/update{roomId}",
  "notify": "https://mimi.example.com/v1/notify/{roomId}",
  "submitMessage":
     "https://mimi.example.com/v1/submitMessage/{roomId}",
  "groupInfo":
     "https://mimi.example.com/v1/groupInfo/{roomId}",
  "requestConsent":
     "https://mimi.example.com/v1/requestConsent/{targetUser}",
  "updateConsent":
     "https://mimi.example.com/v1/updateConsent/{requesterUser}",
  "identifierQuery":
     "https://mimi.example.com/v1/identifierQuery/{domain}",
  "reportAbuse":
     "https://mimi.example.com/v1/reportAbuse/{roomId}"
}
</pre><a href="#section-5.1-4" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="fetch-key-material">
<section id="section-5.2">
        <h3 id="name-fetch-key-material">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-fetch-key-material" class="section-name selfRef">Fetch Key Material</a>
        </h3>
<p id="section-5.2-1">This action attempts to claim initial keying material for all the clients
of a single user at a specific provider. The keying material is designed
for use in a single room and may not be reused. It uses the HTTP POST method.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.2-2">
<pre>
POST /keyMaterial/{targetUser}
</pre><a href="#section-5.2-2" class="pilcrow">¶</a>
</div>
<p id="section-5.2-3">The target user's URI is listed in the request path. KeyPackages
requested using this primitive <span class="bcp14">MUST</span> be sent via the hub provider of whatever
room they will be used in. (If this is not the case, the hub provider will be
unable to forward a Welcome message to the target provider).<a href="#section-5.2-3" class="pilcrow">¶</a></p>
<p id="section-5.2-4">The path includes the target user. The request body includes the protocol
(currently just MLS 1.0), and the requesting user. When the request is being
made in the context of adding the target user to a room, the request <span class="bcp14">MUST</span> include
the room ID for which the KeyPackage is intended, as the target may have only
granted consent for a specific room.<a href="#section-5.2-4" class="pilcrow">¶</a></p>
<p id="section-5.2-5">For MLS, the request includes a non-empty list of acceptable MLS ciphersuites,
and an MLS <code>RequiredCapabilities</code> object (which contains credential types,
non-default proposal types, and extensions) required by the requesting provider
(these lists can be an empty).<a href="#section-5.2-5" class="pilcrow">¶</a></p>
<p id="section-5.2-6">The request body has the following form.<a href="#section-5.2-6" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.2-7">
<pre>
struct {
    opaque uri&lt;V&gt;;
} IdentifierUri;

struct {
    Protocol protocol;
    IdentifierUri requestingUser;
    IdentifierUri targetUser;
    IdentifierUri roomId;
    select (protocol) {
        case mls10:
            CipherSuite acceptableCiphersuites&lt;V&gt;;
            RequiredCapabilities requiredCapabilities;
    };
} KeyMaterialRequest;
</pre><a href="#section-5.2-7" class="pilcrow">¶</a>
</div>
<p id="section-5.2-8">The response contains a user status code that indicates keying material was
returned for all the user's clients (<code>success</code>), that keying material was
returned for some of their clients (<code>partialSuccess</code>), or a specific user code
indicating failure. If the user code is success or partialSuccess, each client
is enumerated in the response. Then for each client with a <em>client</em> success
code, the structure includes initial keying material (a KeyPackage for MLS 1.0).
If the client's code is <code>nothingCompatible</code>, the client's capabilities are
optionally included (The client's capabilities could be omitted for privacy
reasons.)<a href="#section-5.2-8" class="pilcrow">¶</a></p>
<p id="section-5.2-9">If the <em>user</em> code is <code>noCompatibleMaterial</code>, the provider <span class="bcp14">MAY</span> populate the
<code>clients</code> list. For any other user code, the provider <span class="bcp14">MUST NOT</span> populate the
<code>clients</code> list.<a href="#section-5.2-9" class="pilcrow">¶</a></p>
<p id="section-5.2-10">Keying material provided from one response <span class="bcp14">MUST NOT</span> be provided in any other
response.
The target provider <span class="bcp14">MUST NOT</span> provide expired keying material (ex: an MLS
KeyPackage containing a LeafNode with a <code>notAfter</code> time past the current date
and time).<a href="#section-5.2-10" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.2-11">
<pre>
enum {
    success(0);
    partialSuccess(1);
    incompatibleProtocol(2);
    noCompatibleMaterial(3);
    userUnknown(4);
    noConsent(5);
    noConsentForThisRoom(6);
    userDeleted(7);
    (255)
} KeyMaterialUserCode;

enum {
    success(0);
    keyMaterialExhausted(1),
    nothingCompatible(2),
    (255)
} KeyMaterialClientCode;


struct {
    KeyMaterialClientCode clientStatus;
    IdentifierUri clientUri;
    select (protocol) {
        case mls10:
            select (clientStatus) {
                case success:
                    KeyPackage keyPackage;
                case nothingCompatible:
                    optional&lt;Capabilities&gt; clientCapabilities;
            };
    };
} ClientKeyMaterial;

struct {
    Protocol protocol;
    KeyMaterialUserCode userStatus;
    IdentifierUri userUri;
    ClientKeyMaterial clients&lt;V&gt;;
} KeyMaterialResponse;
</pre><a href="#section-5.2-11" class="pilcrow">¶</a>
</div>
<p id="section-5.2-12">The semantics of the <code>KeyMaterialUserCode</code> are as follows:<a href="#section-5.2-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-13.1">
            <p id="section-5.2-13.1.1"><code>success</code> indicates that key material was provided for every client of the
target user.<a href="#section-5.2-13.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-13.2">
            <p id="section-5.2-13.2.1"><code>partialSuccess</code> indicates that key material was provided for at least one
client of the target user.<a href="#section-5.2-13.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-13.3">
            <p id="section-5.2-13.3.1"><code>incompatibleProtocol</code> indicates that either one of providers supports the
protocol requested, or none of the clients of the target user support the
protocol requested.<a href="#section-5.2-13.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-13.4">
            <p id="section-5.2-13.4.1"><code>noCompatibleMaterial</code> indicates that none of the clients was able to
supply key material compatible with the <code>requiredCapabilities</code> field in the
request.<a href="#section-5.2-13.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-13.5">
            <p id="section-5.2-13.5.1"><code>userUnknown</code> indicates that the target user is not known to the target
provider.<a href="#section-5.2-13.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-13.6">
            <p id="section-5.2-13.6.1"><code>noConsent</code> indicates that the requester does not have consent to fetch
key material for the target user. The target provider can use this response
as a catch all and in place of other status codes such as <code>userUnknown</code> if
desired to preserve the privacy of its users.<a href="#section-5.2-13.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-13.7">
            <p id="section-5.2-13.7.1"><code>noConsentForThisRoom</code> indicates that the target user might have allowed
a request for another room, but does not for this room. If the provider
does not wish to make this distinction, it can return <code>noConsent</code> instead.<a href="#section-5.2-13.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-13.8">
            <p id="section-5.2-13.8.1"><code>userDeleted</code> indicates that the target provider wishes the requester to
know that the target user was previously a valid user of the system and has
been deleted. A target provider can of course use <code>userUnknown</code> if the
provider does wish to keep or specify this distinction.<a href="#section-5.2-13.8.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.2-14">The semantics of the <code>KeyMaterialClientCode</code> are as follows:<a href="#section-5.2-14" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-15.1">
            <p id="section-5.2-15.1.1"><code>success</code> indicates that key material was provided for the specified
client.<a href="#section-5.2-15.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-15.2">
            <p id="section-5.2-15.2.1"><code>keyMaterialExhausted</code> indicates that there was no keying material
available for the specified client.<a href="#section-5.2-15.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-15.3">
            <p id="section-5.2-15.3.1"><code>nothingCompatible</code> indicates that the specified clients had no key
material compatible with the <code>requiredCapabilities</code> field in the request.<a href="#section-5.2-15.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.2-16">At minimum, as each MLS KeyPackage is returned to a requesting provider (on
behalf of a requesting IM client), the target provider needs to associate its
<code>KeyPackageRef</code> with the target client and the hub provider needs to associate
its <code>KeyPackageRef</code> with the target provider. This ensures that Welcome messages
can be correctly routed to the target provider and client. These associations
can be deleted after a Welcome message is forwarded or after the KeyPackage
<code>leaf_node.lifetime.not_after</code> time has passed.<a href="#section-5.2-16" class="pilcrow">¶</a></p>
</section>
</div>
<div id="update-room-state">
<section id="section-5.3">
        <h3 id="name-update-room-state">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-update-room-state" class="section-name selfRef">Update Room State</a>
        </h3>
<p id="section-5.3-1">Adds, removes, and policy changes to the room are all forms of updating the
room state. They are accomplished using the update transaction which is used to
update the room base policy, participation list, or its underlying MLS group.
It uses the HTTP POST method.<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.3-2">
<pre>
POST /update/{roomId}
</pre><a href="#section-5.3-2" class="pilcrow">¶</a>
</div>
<p id="section-5.3-3">Any change to the participant list or room policy (including
authorization policy) is communicated via an <code>AppSync</code> proposal type
with the <code>applicationId</code> of <code>mimiParticipantList</code> or <code>mimiRoomPolicy</code>
respectively. When adding a user, the proposal containing the participant list
change <span class="bcp14">MUST</span> be committed either before or simultaneously with the corresponding
MLS operation.<a href="#section-5.3-3" class="pilcrow">¶</a></p>
<p id="section-5.3-4">Removing an active user from a participant list or banning an active participant
likewise also happen simultaneously with any MLS changes made to the commit removing
the participant.<a href="#section-5.3-4" class="pilcrow">¶</a></p>
<p id="section-5.3-5">A hub provider which observes that an active participant has been removed or
banned from the room, <span class="bcp14">MUST</span> prevent any of its clients from sending or
receiving any additional application messages in the corresponding MLS group;
<span class="bcp14">MUST</span> prevent any of those clients from sending Commit messages in that group;
and <span class="bcp14">MUST</span> prevent it from sending any proposals except for <code>Remove</code> and
<code>SelfRemove</code> <span>[<a href="#I-D.ietf-mls-extensions" class="cite xref">I-D.ietf-mls-extensions</a>]</span> proposals for its users in that group.<a href="#section-5.3-5" class="pilcrow">¶</a></p>
<p id="section-5.3-6">The update request body is described below, using the
<code>RatchetTreeOption</code> and <code>PartialGroupInfo</code> structs defined in
<span>[<a href="#I-D.mahy-mls-ratchet-tree-options" class="cite xref">I-D.mahy-mls-ratchet-tree-options</a>]</span>:<a href="#section-5.3-6" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.3-7">
<pre>
struct {
  /* A Proposal or Commit which is either a PublicMessage; */
  /* or a SemiPrivateMessage                               */
  MLSMessage proposalOrCommit;
  select (proposalOrCommit.content.content_type) {
    case commit:
      /* Both the Welcome and GroupInfo omit the ratchet_tree */
      optional&lt;Welcome&gt; welcome;
      GroupInfoOption groupInfoOption;
      RatchetTreeOption ratchetTreeOption;
    case proposal:
      /* a list of additional proposals, each represented */
      /* as either PublicMessage or SemiPrivateMessage    */
      MLSMessage moreProposals&lt;V&gt;;
} HandshakeBundle;

enum {
  reserved(0),
  full(1),
  partial(2),
  (255)
} GroupInfoRepresentation;

struct {
   GroupInfoRepresentation representation;
   select (representation) {
     case full:
       GroupInfo groupInfo;
     case partial:
       PartialGroupInfo partialGroupInfo;
   }
} GroupInfoOption;

struct {
  select (room.protocol) {
    case mls10:
      HandshakeBundle bundle;
  };
} UpdateRequest;
</pre><a href="#section-5.3-7" class="pilcrow">¶</a>
</div>
<p id="section-5.3-8">The semantics of <code>GroupInfoRepresentation</code> are as follows:<a href="#section-5.3-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-9.1">
            <p id="section-5.3-9.1.1"><code>full</code> means that the entire GroupInfo will be included.<a href="#section-5.3-9.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.3-9.2">
            <p id="section-5.3-9.2.1"><code>partial</code> means that a <code>PartialGroupInfo </code> struct will be shared and
 that the Distribution Service is expected to reconstruct the GroupInfo
 as described in <span>[<a href="#I-D.mahy-mls-ratchet-tree-options" class="cite xref">I-D.mahy-mls-ratchet-tree-options</a>]</span>.<a href="#section-5.3-9.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.3-10">For example, in the first use case described in the Protocol Overview, Alice creates a Commit
containing an AppSync proposal adding Bob (<code>mimi://b.example/b/bob</code>), and Add proposals for all
Bob's MLS clients.  Alice includes the Welcome message which will be sent for
Bob, a GroupInfo object for the hub provider, and complete <code>ratchet_tree</code>
extension.<a href="#section-5.3-10" class="pilcrow">¶</a></p>
<p id="section-5.3-11">A handshake message could be sent by the client as an MLS
<code>PublicMessage</code> (which is visible to all providers), or as an MLS
<code>SemiPrivateMessage</code> <span>[<a href="#I-D.mahy-mls-semiprivatemessage" class="cite xref">I-D.mahy-mls-semiprivatemessage</a>]</span> encrypted
for the members and the hub provider as the sole <code>external_receiver</code>.
(The contents and sender of a <code>SemiPrivateMessage</code> would not be visible to
other providers). The use of <code>SemiPrivateMessage</code> allows the Hub to
accomplish its policy enforcement responsibilities without the other
providers being aware of the membership of non-local users.<a href="#section-5.3-11" class="pilcrow">¶</a></p>
<p id="section-5.3-12">The response body is described below:<a href="#section-5.3-12" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.3-13">
<pre>
enum {
  success(0),
  wrongEpoch(1),
  notAllowed(2),
  invalidProposal(3),
  (255)
} UpdateResponseCode;

struct {
  UpdateResponseCode responseCode;
  string errorDescription;
  select (responseCode) {
    case success:
      /* the hub acceptance time (in milliseconds from the UNIX epoch) */
      uint64 acceptedTimestamp;
    case wrongEpoch:
      /* current MLS epoch for the MLS group */
      uint64 currentEpoch;
    case invalidProposal:
      ProposalRef invalidProposals&lt;V&gt;;
  };
} UpdateRoomResponse
</pre><a href="#section-5.3-13" class="pilcrow">¶</a>
</div>
<p id="section-5.3-14">The semantics of the <code>UpdatedResponseCode</code> values are as follows:<a href="#section-5.3-14" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.3-15.1">
            <p id="section-5.3-15.1.1"><code>success</code> indicates the <code>UpdateRequest</code> was accepted and will be distributed.<a href="#section-5.3-15.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.3-15.2">
            <p id="section-5.3-15.2.1"><code>wrongEpoch</code> indicates that the hub provider is using a different epoch. The
<code>currentEpoch</code> is provided in the response.<a href="#section-5.3-15.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.3-15.3">
            <p id="section-5.3-15.3.1"><code>notAllowed</code> indicates that some type of policy or authorization prevented the
hub provider from accepting the <code>UpdateRequest</code>.<a href="#section-5.3-15.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.3-15.4">
            <p id="section-5.3-15.4.1"><code>invalidProposal</code> indicates that at least one proposal is invalid. A list of
invalidProposals is provided in the response.<a href="#section-5.3-15.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="submit-a-message">
<section id="section-5.4">
        <h3 id="name-submit-a-message">
<a href="#section-5.4" class="section-number selfRef">5.4. </a><a href="#name-submit-a-message" class="section-name selfRef">Submit a Message</a>
        </h3>
<p id="section-5.4-1">End-to-end encrypted (application) messages are submitted to the hub for
authorization and eventual fanout using an HTTP POST request.<a href="#section-5.4-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.4-2">
<pre>
POST /submitMessage/{roomId}
</pre><a href="#section-5.4-2" class="pilcrow">¶</a>
</div>
<p id="section-5.4-3">The request body is as follows:<a href="#section-5.4-3" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.4-4">
<pre>
struct {
  Protocol protocol;
  select(protocol) {
    case mls10:
      /* PrivateMessage containing an application message */
      MLSMessage appMessage;
      IdentifierURI sendingUri;
  };
} SubmitMessageRequest;
</pre><a href="#section-5.4-4" class="pilcrow">¶</a>
</div>
<p id="section-5.4-5">If the protocol is MLS 1.0, the request body (<code>appMessage</code>) is an MLSMessage
with a WireFormat of PrivateMessage, and a <code>content_type</code> of <code>application</code>.
The <code>sendingUri</code> is a valid URI of the sender and is an active participant
in the room (a user URI in the participant list of the room).<a href="#section-5.4-5" class="pilcrow">¶</a></p>
<p id="section-5.4-6">The response indicates if the message was accepted by the hub provider. If a
<code>frankingTag</code> was included in the <code>FrankAAD</code> extension in the PrivateMessage
Additional Authenticated Data (AAD) in the request, the server attempts to
frank the message and includes the <code>serverFrank</code> in a successful response
(see the next subsection).<a href="#section-5.4-6" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.4-7">
<pre>
enum {
  accepted(0),
  notAllowed(1),
  epochTooOld(2),
  (255)
} SubmitResponseCode;

struct {
  Protocol protocol;
  select(protocol) {
    case mls10:
      SubmitResponseCode statusCode;
      select (statusCode) {
        case success:
          /* the hub acceptance time
             (in milliseconds from the UNIX epoch) */
          uint64 acceptedTimestamp;
          optional struct {
            uint8[32] serverFrank;
            uint8[32] franking_integrity_check;
          };
        case epochTooOld:
          /* current MLS epoch for the MLS group */
          uint64 currentEpoch;
      };
  };
} SubmitMessageResponse;
</pre><a href="#section-5.4-7" class="pilcrow">¶</a>
</div>
<p id="section-5.4-8">The semantics of the <code>SubmitResponseCode</code> values are as follows:<a href="#section-5.4-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.4-9.1">
            <p id="section-5.4-9.1.1"><code>success</code> indicates the <code>SubmitMessageRequest</code> was accepted and will be distributed.<a href="#section-5.4-9.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.4-9.2">
            <p id="section-5.4-9.2.1"><code>notAllowed</code> indicates that some type of policy or authorization prevented the
hub provider from accepting the <code>UpdateRequest</code>. This could include
nonsensical inputs such as an MLS epoch more recent than the hub's.<a href="#section-5.4-9.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.4-9.3">
            <p id="section-5.4-9.3.1"><code>epochTooOld</code> indicates that the hub provider is using a new MLS epoch
for the group. The <code>currentEpoch</code> is provided in the response.<a href="#section-5.4-9.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.4-10.1">
            <p id="section-5.4-10.1.1"><strong>ISSUE:</strong> Do we want to offer a distinction between regular application
messages and ephemeral applications messages (for example "is typing"
notifications), which do not need to be queued at the target provider.<a href="#section-5.4-10.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<div id="message-franking">
<section id="section-5.4.1">
          <h4 id="name-message-franking">
<a href="#section-5.4.1" class="section-number selfRef">5.4.1. </a><a href="#name-message-franking" class="section-name selfRef">Message Franking</a>
          </h4>
<p id="section-5.4.1-1">Franking is the placing of a cryptographic "stamp" on a message. In the
MIMI context, the Hub is able to mark that it received a message without
learning the message content. A receiver that decrypts the message can use
a valid frank to prove it was received by the Hub and that the content was
sent by a specific sender. Outsiders (including follower providers) never
learn the content of the message, nor the sender.<a href="#section-5.4.1-1" class="pilcrow">¶</a></p>
<p id="section-5.4.1-2">Franking was popularized by Facebook and described in their whitepaper
<span>[<a href="#SecretConversations" class="cite xref">SecretConversations</a>]</span> about their end-to-end encryption system. This
franking mechanism is largely motivated by that solution with two
significant changes as discussed in the final paragraph of this section.<a href="#section-5.4.1-2" class="pilcrow">¶</a></p>
<div id="client-creation-and-sending">
<section id="section-5.4.1.1">
            <h5 id="name-client-creation-and-sending">
<a href="#section-5.4.1.1" class="section-number selfRef">5.4.1.1. </a><a href="#name-client-creation-and-sending" class="section-name selfRef">Client creation and sending</a>
            </h5>
<p id="section-5.4.1.1-1">When generating an application message with the MIMI content format
<span>[<a href="#I-D.ietf-mimi-content" class="cite xref">I-D.ietf-mimi-content</a>]</span>, the sender generates a per-message cryptographically
random 256-bit salt. (An example mechanism to safely generate the salt is
discussed in Section 8.2 of <span>[<a href="#I-D.ietf-mimi-content" class="cite xref">I-D.ietf-mimi-content</a>]</span>.)<a href="#section-5.4.1.1-1" class="pilcrow">¶</a></p>
<p id="section-5.4.1.1-2">Next the sender attaches to the message any fields the sender wishes to commit
that are not otherwise represented in the content. For a MIMI content object,
the sender creates a CBOR "FrankingAssertion" map containing the room URI and
the sender's user URI. It adds this FrankingAssertion to the extensions map at
the top level of the MIMI content using the integer key TBD1.<a href="#section-5.4.1.1-2" class="pilcrow">¶</a></p>
<div class="lang-cbor-diag sourcecode" id="section-5.4.1.1-3">
<pre>
/ FrankingAssertion map /
{
  / RoomURI        / 1: "mimi://hub.example/r/Rl33FWLCYWOwxHrYnpWDQg",
  / SenderUserURI  / 2: "mimi://b.example/u/alice"
}
</pre><a href="#section-5.4.1.1-3" class="pilcrow">¶</a>
</div>
<p id="section-5.4.1.1-4">Note that this assertion does not vouch for the validity of these values,
it just means that the sender is claiming it sent the values in the content,
and cannot later deny to a receiver that it sent them.<a href="#section-5.4.1.1-4" class="pilcrow">¶</a></p>
<p id="section-5.4.1.1-5">Then the client calculates the <code>franking_tag</code>, as the HMAC SHA256 of the
<code>application_data</code> (which includes the FrankingAssertion extension), using the
<code>salt</code> in the MIMI content format:<a href="#section-5.4.1.1-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.4.1.1-6">
<pre>
franking_tag = HMAC_SHA256( salt, application_data)
</pre><a href="#section-5.4.1.1-6" class="pilcrow">¶</a>
</div>
<p id="section-5.4.1.1-7">The client includes the <code>franking_tag</code> in the Additional Authenticated Data
of the MLS PrivateMessage using the Safe Extension <code>FrankAAD</code>. The client
uses the MIMI submitMessage to send its message, and also asserts a sender
identity to the Hub, which could be a valid pseudonym, and needs to match
the sender URI value embedded in the message. If the message is accepted,
the response includes the accepted timestamp and the serverFrank (generated
by the server).<a href="#section-5.4.1.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="hub-processing">
<section id="section-5.4.1.2">
            <h5 id="name-hub-processing">
<a href="#section-5.4.1.2" class="section-number selfRef">5.4.1.2. </a><a href="#name-hub-processing" class="section-name selfRef">Hub processing</a>
            </h5>
<p id="section-5.4.1.2-1">The Hub relies on a per-epoch secret shared among the members of the group
and itself to provider integrity over the message metadata the Hub uses
(serverURI, roomURI) and adds (acceptedTimestamp, serverFrank) while franking.
It derives the <code>franking_integrity_secret</code>, using the label
"franking_integrity", from the <code>ap_exporter_secret</code> in the Associated Party Key
Schedule <span>[<a href="#I-D.kohbrok-mls-associated-parties" class="cite xref">I-D.kohbrok-mls-associated-parties</a>]</span>.<a href="#section-5.4.1.2-1" class="pilcrow">¶</a></p>
<span id="name-the-extended-associated-par"></span><div id="extended-ap-key-schedule">
<figure id="figure-10">
              <div id="section-5.4.1.2-2.1">
                <div class="alignLeft art-svg artwork" id="section-5.4.1.2-2.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="400" width="480" viewBox="0 0 480 400" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                    <path d="M 56,32 L 56,80" fill="none" stroke="black"></path>
                    <path d="M 56,112 L 56,208" fill="none" stroke="black"></path>
                    <path d="M 56,240 L 56,352" fill="none" stroke="black"></path>
                    <path d="M 360,176 L 360,288" fill="none" stroke="black"></path>
                    <path d="M 56,144 L 224,144" fill="none" stroke="black"></path>
                    <polygon class="arrowhead" points="368,288 356,282.4 356,293.6" fill="black" transform="rotate(90,360,288)"></polygon>
                    <polygon class="arrowhead" points="232,144 220,138.4 220,149.6" fill="black" transform="rotate(0,224,144)"></polygon>
                    <polygon class="arrowhead" points="64,352 52,346.4 52,357.6" fill="black" transform="rotate(90,56,352)"></polygon>
                    <polygon class="arrowhead" points="64,208 52,202.4 52,213.6" fill="black" transform="rotate(90,56,208)"></polygon>
                    <polygon class="arrowhead" points="64,80 52,74.4 52,85.6" fill="black" transform="rotate(90,56,80)"></polygon>
                    <g class="text">
                      <text x="48" y="36">.</text>
                      <text x="64" y="36">.</text>
                      <text x="64" y="100">ap_epoch_secret</text>
                      <text x="296" y="148">DeriveSecret(.,</text>
                      <text x="420" y="148">"ap_exporter")</text>
                      <text x="312" y="164">=</text>
                      <text x="396" y="164">ap_exporter_secret</text>
                      <text x="64" y="228">DeriveSecret(.,</text>
                      <text x="160" y="228">"init")</text>
                      <text x="200" y="308">DeriveSecret(.,</text>
                      <text x="352" y="308">"franking_integrity")</text>
                      <text x="216" y="324">=</text>
                      <text x="328" y="324">franking_integrity_secret</text>
                      <text x="64" y="372">init_secret_[n]</text>
                    </g>
                  </svg><a href="#section-5.4.1.2-2.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-10" class="selfRef">Figure 10</a>:
<a href="#name-the-extended-associated-par" class="selfRef">The Extended Associated Party Key Schedule</a>
              </figcaption></figure>
</div>
<p id="section-5.4.1.2-3">When the Hub receives an acceptable application message with the <code>FrankAAD</code>
AAD extension and a valid sender identity, it calculates a server frank for
the message as follows:<a href="#section-5.4.1.2-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.4.1.2-4">
<pre>
context = senderURI || roomURI || acceptedTimestamp
serverFrank = HMAC_SHA256(HUBkey, franking_tag || context )
franking_integrity_check = HMAC_SHA256(franking_integrity_secret,
  serverFrank || context)
</pre><a href="#section-5.4.1.2-4" class="pilcrow">¶</a>
</div>
<p id="section-5.4.1.2-5"><code>HUBkey</code> is a secret symmetric key used on the Hub which the Hub can use to verify its own tags.<a href="#section-5.4.1.2-5" class="pilcrow">¶</a></p>
<p id="section-5.4.1.2-6">The <code>franking_integrity_check</code> is used by receivers to verify that the
values added by the Hub (the <code>serverFrank</code>, and <code>acceptedTimestamp</code>) were not
modified by a follower provider, and that the <code>senderURI</code> and <code>roomURI</code> match
those provided by the sending client.
The specific construction used is discussed in the Security Considerations
in <a href="#franking" class="auto internal xref">Section 9.1</a>.<a href="#section-5.4.1.2-6" class="pilcrow">¶</a></p>
<p id="section-5.4.1.2-7">The Hub fans out the encrypted message (which includes the <code>franking_tag</code>),
the <code>serverFrank</code>, the <code>acceptedTimestamp</code>, the room URI, and the
<code>franking_integrity_check</code>. Note that the <code>senderURI</code> is encrypted in the
application message, so the sender can remain anonymous with respect to follower
providers.<a href="#section-5.4.1.2-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="receiver-verification-of-frank">
<section id="section-5.4.1.3">
            <h5 id="name-receiver-verification-of-fr">
<a href="#section-5.4.1.3" class="section-number selfRef">5.4.1.3. </a><a href="#name-receiver-verification-of-fr" class="section-name selfRef">Receiver verification of frank</a>
            </h5>
<p id="section-5.4.1.3-1">When a client receives and decrypts an otherwise valid application message
from a hub provider, the client looks for the existence of a frank
(consisting of the <code>franking_tag</code> in the AAD, the <code>serverFrank</code> and the
<code>franking_integrity_check</code>). If those fields are available, the client derives the
<code>franking_integrity_secret</code> from the <code>ap_exporter_secret</code> in the Associated
Party Key Schedule <span>[<a href="#I-D.kohbrok-mls-associated-parties" class="cite xref">I-D.kohbrok-mls-associated-parties</a>]</span>.<a href="#section-5.4.1.3-1" class="pilcrow">¶</a></p>
<p id="section-5.4.1.3-2">Next it verifies the integrity of the <code>serverFrank</code>, <code>acceptedTimestamp</code>,
<code>senderURI</code>, and <code>roomURI</code> by calculating its own <code>franking_integrity_check</code>
from these values with the <code>franking_integrity_secret</code> and comparing it to the
provided <code>franking_integrity_check</code>.<a href="#section-5.4.1.3-2" class="pilcrow">¶</a></p>
<p id="section-5.4.1.3-3">Finally it verifies the construction of the <code>franking_tag</code> from the content
of the message (including the embedded <code>salt</code>),
that the sender's identity in its credential in its MLS LeafNode matches
the sender's user identity asserted in the FrankingAssertion map inside the MIMI
Content, and that the RoomURI inside the MIMI Content matches the room ID in
the received message.<a href="#section-5.4.1.3-3" class="pilcrow">¶</a></p>
<p id="section-5.4.1.3-4">The receiver needs to store the frank and context with the decoded message
so it can be used later.<a href="#section-5.4.1.3-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="comparison-with-the-facebook-franking-scheme">
<section id="section-5.4.1.4">
            <h5 id="name-comparison-with-the-faceboo">
<a href="#section-5.4.1.4" class="section-number selfRef">5.4.1.4. </a><a href="#name-comparison-with-the-faceboo" class="section-name selfRef">Comparison with the Facebook franking scheme</a>
            </h5>
<p id="section-5.4.1.4-1">Unlike in the Facebook franking scheme <span>[<a href="#SecretConversations" class="cite xref">SecretConversations</a>]</span>, the MIMI
use case involves traffic which can transit multiple federated providers,
any of which may be compromised or malicious. The MIMI franking scheme
described here differs in the following ways.<a href="#section-5.4.1.4-1" class="pilcrow">¶</a></p>
<p id="section-5.4.1.4-2">The sender
includes its <code>franking_tag</code> as Additional Authenticated Data (AAD) inside the end-to-end encrypted message. This insures that the <code>franking_tag</code> is not tampered with by the sender's provider.
According to <span>[<a href="#Grubbs2017" class="cite xref">Grubbs2017</a>]</span>,
"... [Facebook's] franking scheme does not bind [the franking tag] to [the
ciphertext] by including [the franking tag] in the associated data during
encryption".<a href="#section-5.4.1.4-2" class="pilcrow">¶</a></p>
<p id="section-5.4.1.4-3">In MLS, the Hub cannot view the sender identity in an application message,
so the sender sends its identity to the Hub. The hub never sends the
identity of the sender to receivers, since this would be observed by
follower providers. However, the receiver needs to verify that the sender
identity provided by the sender's provider to the Hub matches the identity
the receiver sees after it decrypts the message. Using a key shared between
members and the Hub (the <code>franking_integrity_secret</code>) the Hub sends an HMAC
of its context (sender identity, room id, and timestamp) and the serverFrank
with this key. The second change provides two functions. Itallows receivers to
validate the sender URI in the hub's context, without revealing the sender URI
to follower providers. It also prevents a follower provider from "mauling" the
serverFrank, or breaking the context comparison (by modifying the
<code>acceptedTimestamp</code>). Each receiver uses this to verify that the timestamp and
franking parameters added by the Hub were not modified.<a href="#section-5.4.1.4-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="fanout-messages-and-room-events">
<section id="section-5.5">
        <h3 id="name-fanout-messages-and-room-ev">
<a href="#section-5.5" class="section-number selfRef">5.5. </a><a href="#name-fanout-messages-and-room-ev" class="section-name selfRef">Fanout Messages and Room Events</a>
        </h3>
<p id="section-5.5-1">If the hub provider accepts an application or handshake message (proposal or
commit) message, it forwards that message to all other providers with active
participants in the room and all local clients which are active members.
This is described as fanning the message out. One can think of fanning a
message out as presenting an ordered list of MLS-protected events to the next
"hop" toward the receiving client.<a href="#section-5.5-1" class="pilcrow">¶</a></p>
<p id="section-5.5-2">An MLS Welcome message is sent to the providers and local users associated with
the <code>KeyPackageRef</code> values in the <code>secrets</code> array of the Welcome. In the case
of a Welcome message, a <code>RatchetTreeOption</code>
(see Section 3 of <span>[<a href="#I-D.mahy-mls-ratchet-tree-options" class="cite xref">I-D.mahy-mls-ratchet-tree-options</a>]</span>) is also included
in the FanoutMessage.<a href="#section-5.5-2" class="pilcrow">¶</a></p>
<p id="section-5.5-3">The hub provider also fans out any messages which originate from itself (ex: MLS
External Proposals).<a href="#section-5.5-3" class="pilcrow">¶</a></p>
<p id="section-5.5-4">The hub can include multiple concatenated <code>FanoutMessage</code> objects relevant to
the same room. This endpoint uses the HTTP POST method.<a href="#section-5.5-4" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5-5">
<pre>
POST /notify/{roomId}
</pre><a href="#section-5.5-5" class="pilcrow">¶</a>
</div>
<div class="lang-tls sourcecode" id="section-5.5-6">
<pre>
struct {
  uint8[32] serverFrank;
  uint8[32] franking_integrity_check;
} Frank;

struct {
  /* the hub acceptance time (in milliseconds from the UNIX epoch) */
  uint64 timestamp;
  select (protocol) {
    case mls10:
      /* A PrivateMessage containing an application message,
         a PublicMessage containing a proposal or commit,
         or a Welcome message.                               */
      MLSMessage message;
      select (message.wire_format) {
        case application:
           optional Frank frank;
        case welcome:
           RatchetTreeOption ratchetTreeOption;
        case proposal:
           /* a list of additional proposals, each represented */
           /* as either PublicMessage or SemiPrivateMessage    */
           MLSMessage moreProposals&lt;V&gt;;
        case commit:
           struct {};
      };
  };
} FanoutMessage;
</pre><a href="#section-5.5-6" class="pilcrow">¶</a>
</div>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.5-7.1">
            <p id="section-5.5-7.1.1"><strong>NOTE:</strong> Correctly fanning out Welcome messages relies on the hub and target
providers storing the <code>KeyPackageRef</code> of claimed KeyPackages.<a href="#section-5.5-7.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.5-8">A client which receives a <code>success</code> to either an <code>UpdateRoomResponse</code> or a
<code>SubmitMessageResponse</code> can view this as a commitment from the hub provider that
the message will eventually be distributed to the group. The hub is not
expected to forward the client's own message to the client or its provider.
However, the client and its provider need to be prepared to receive the
client's (effectively duplicate) message. This situation can occur during
failover in high availability recovery scenarios.<a href="#section-5.5-8" class="pilcrow">¶</a></p>
<p id="section-5.5-9">Clients that are being removed <span class="bcp14">SHOULD</span> receive the corresponding
Commit message, so they can recognize that they have been removed and clean up
their internal state. A removed client might not receive a commit if it was
removed as a malicious or abusive client, or if it was obviously deleted.<a href="#section-5.5-9" class="pilcrow">¶</a></p>
<p id="section-5.5-10">The <code>moreProposals</code> list in a <code>FanoutMessage</code> <span class="bcp14">MUST</span> be the same as the
corresponding <code>moreProposals</code> list in the <code>HandshakeBundle</code> of an
<code>UpdateRequest</code>.<a href="#section-5.5-10" class="pilcrow">¶</a></p>
<p id="section-5.5-11">The response to a FanoutMessage contains no body. The HTTP response code
indicates if the messages in the request were accepted (201 response code), or
if there was an error. The hub need not wait for a response before sending the
next fanout message.<a href="#section-5.5-11" class="pilcrow">¶</a></p>
<p id="section-5.5-12">If the hub server does not contain an HTTP 201 response code, then it <span class="bcp14">SHOULD</span>
retry the request, respecting any guidance provided by the server in HTTP header
fields such as Retry-After.  If a follower server receives a duplicate request
to the <code>/notify</code> endpoint, in the sense of a request from the same hub server
with the same request body as a previous <code>/notify</code> request, then the follower
server <span class="bcp14">MUST</span> return a 201 Accepted response.  In such cases, the follower server
<span class="bcp14">SHOULD</span> process only the first request; subsequent duplicate requests <span class="bcp14">SHOULD</span> be
ignored (despite the success response).<a href="#section-5.5-12" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.5-13.1">
            <p id="section-5.5-13.1.1"><strong>NOTE:</strong> These deduplication provisions require follower servers to track
which request bodies they have received from which hub servers.  Since the
matching here is byte-exact, it can be done by keeping a rolling list of
hashes of recent messages.<a href="#section-5.5-13.1.1" class="pilcrow">¶</a></p>
<p id="section-5.5-13.1.2">This byte-exact replay criterion might not be the right deduplication
strategy.  There might be situations where it is valid for the same hub server
to send the same payload multiple times, e.g., due to accidental collisions.<a href="#section-5.5-13.1.2" class="pilcrow">¶</a></p>
<p id="section-5.5-13.1.3">If this is a concern, then an explicit transaction ID could be introduced.
The follower server would still have to keep a list of recently seen
transaction IDs, but deduplication could be done irrespective of the content
of request bodies.<a href="#section-5.5-13.1.3" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="claim-group-key-information">
<section id="section-5.6">
        <h3 id="name-claim-group-key-information">
<a href="#section-5.6" class="section-number selfRef">5.6. </a><a href="#name-claim-group-key-information" class="section-name selfRef">Claim group key information</a>
        </h3>
<p id="section-5.6-1">When a client joins an MLS group without an existing member adding the
client to the MLS group, that is called an external join. This is useful
a) when a new client of an existing user needs to join the groups of all the
user's rooms. It can also be used b) when a client did not have key packages
available but their user is already in the participation list for the
corresponding room, c) when joining an open room, or d) when joining using
an external authentication joining code. In MIMI, external joins are
accomplished by fetching the MLS GroupInfo for a room's MLS group, and then
sending an external commit incorporating the GroupInfo.<a href="#section-5.6-1" class="pilcrow">¶</a></p>
<p id="section-5.6-2">The GroupInfoRequest uses the HTTP POST method.<a href="#section-5.6-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.6-3">
<pre>
POST /groupInfo/{roomId}
</pre><a href="#section-5.6-3" class="pilcrow">¶</a>
</div>
<p id="section-5.6-4">The request provides an MLS credential proving the requesting client's real or
pseudonymous identity. This user identity is used by the hub to correlate this
request with the subsequent external commit. The credential may constitute
sufficient permission to authorize providing the GroupInfo and later joining
the group. Alternatively, the request can include an optional opaque joining
code, which the requester could use to prove permission to fetch the GroupInfo,
even if it is not yet a participant.<a href="#section-5.6-4" class="pilcrow">¶</a></p>
<p id="section-5.6-5">The request also
provides a signature public key
corresponding to the requester's credential. It also specifies a CipherSuite
which merely needs to be one ciphersuite in common with the hub. It is
needed only to specify the algorithms used to sign the
GroupInfoRequest and GroupInfoResponse.<a href="#section-5.6-5" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.6-6">
<pre>
struct {
  Protocol protocol;
  select (protocol) {
    case mls10:
      CipherSuite cipher_suite;
      SignaturePublicKey requestingSignatureKey;
      Credential requestingCredential;
      HPKEPublicKey groupInfoPublicKey;
      optional opaque joiningCode&lt;V&gt;;
  };
} GroupInfoRequestTBS;

struct {
  Protocol protocol;
  select (protocol) {
    case mls10:
      CipherSuite cipher_suite;
      SignaturePublicKey requestingSignatureKey;
      Credential requestingCredential;
      HPKEPublicKey groupInfoPublicKey;
      opaque joiningCode&lt;V&gt;;
      /* SignWithLabel(requestingSignatureKey,          */
      /*    "GroupInfoRequestTBS", GroupInfoRequestTBS) */
      opaque signature&lt;V&gt;;
  };
} GroupInfoRequest;
</pre><a href="#section-5.6-6" class="pilcrow">¶</a>
</div>
<p id="section-5.6-7">If successful, the response body contains the GroupInfo and a way
to get the ratchet_tree, both encrypted with the <code>groupInfoPublcKey</code>
passed in the request.<a href="#section-5.6-7" class="pilcrow">¶</a></p>
<div class="breakable lang-tls sourcecode" id="section-5.6-8">
<pre>
enum {
  reserved(0),
  success(1),
  notAuthorized(2),
  noSuchRoom(3),
  (255)
} GroupInfoCode;

struct {
  GroupInfo groupInfo;   /* without embedded ratchet_tree */
  RatchetTreeOption ratchetTreeOption;
} GroupInfoRatchetTreeTBE;

GroupInfoRatchetTreeTBE group_info_ratchet_tree_tbe;

encrypted_groupinfo_and_tree = EncryptWithLabel(
  groupInfoPublicKey,
  "GroupInfo and ratchet_tree encryption",
  room_id,                         /* context */
  group_info_ratchet_tree_tbe)

struct {
  Protocol version;
  opaque room_id&lt;V&gt;;
  GroupInfoCode status;
  select (protocol) {
    case mls10:
      CipherSuite cipher_suite;
      ExternalSender hub_sender;
      HPKECiphertext encrypted_groupinfo_and_tree;
  };
} GroupInfoResponseTBS;

struct {
  Protocol version;
  opaque room_id&lt;V&gt;;
  GroupInfoCode status;
  select (status) {
    case success:
      select (protocol) {
        case mls10:
          CipherSuite cipher_suite;
          ExternalSender hub_sender;
          HPKECiphertext encrypted_groupinfo_and_tree;
          /* SignWithLabel(hub_sender, "GroupInfoResponseTBS", */
          /*                GroupInfoResponseTBS) */
          opaque signature&lt;V&gt;;
      };
  default: struct{};
  };
} GroupInfoResponse;
</pre><a href="#section-5.6-8" class="pilcrow">¶</a>
</div>
<p id="section-5.6-9">The semantics of the <code>GroupInfoCode</code> are as follows:<a href="#section-5.6-9" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.6-10.1">
            <p id="section-5.6-10.1.1"><code>success</code> indicates that GroupInfo and ratchet tree was provided as
requested.<a href="#section-5.6-10.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.6-10.2">
            <p id="section-5.6-10.2.1"><code>notAuthorized</code> indicates that the requester was not authorized to access
the GroupInfo.<a href="#section-5.6-10.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.6-10.3">
            <p id="section-5.6-10.3.1"><code>noSuchRoom</code> indicates that the requested room does not exist. If the hub
does not want to reveal if a room ID does not exist it can use
<code>notAuthorized</code> instead.<a href="#section-5.6-10.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.6-11.1">
            <p id="section-5.6-11.1.1"><strong>TODO</strong>: Consider adding additional failure codes/semantics for joining
codes (ex: code expired, already used, invalid)<a href="#section-5.6-11.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.6-12"><strong>ISSUE</strong>: What security properties are needed to protect a
GroupInfo object in the MIMI context are still under discussion. It is
possible that the requester only needs to prove possession of their private
key. The GroupInfo in another context might be sufficiently sensitive that
it should be encrypted from the end client to the hub provider (unreadable
by the local provider).<a href="#section-5.6-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="convey-explicit-consent">
<section id="section-5.7">
        <h3 id="name-convey-explicit-consent">
<a href="#section-5.7" class="section-number selfRef">5.7. </a><a href="#name-convey-explicit-consent" class="section-name selfRef">Convey explicit consent</a>
        </h3>
<p id="section-5.7-1">As discussed in <a href="#consent" class="auto internal xref">Section 8</a>, there are many ways that a provider could
implicitly determine consent. This section describes a mechanism by which providers can explicitly request consent from a user of another provider,
cancel such a request, convey that consent was granted, or convey that
consent was revoked or preemptively denied.<a href="#section-5.7-1" class="pilcrow">¶</a></p>
<p id="section-5.7-2">Since they are not necessarily in the context of a room, consent requests
are sent directly from the provider of the user requesting consent, to the
provider of the target user. (There is no concept of a hub outside of the
context of a room.)<a href="#section-5.7-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.7-3">
<pre>
POST /requestConsent/{targetDomain}
POST /updateConsent/{requesterDomain}
</pre><a href="#section-5.7-3" class="pilcrow">¶</a>
</div>
<p id="section-5.7-4">A <code>requestConsent</code> request is used by one provider to request explicit
consent from a target user at another provider to fetch the target's
KeyPackages (which is a prerequisite for adding the target to a group); or
to cancel that request.
The request body is a <code>ConsentEntry</code>, with a <code>consentOperation</code> of <code>request</code>
or <code>cancel</code> respectively. It includes the URI of requesting user in the
<code>requesterUri</code> and the target user URI in the <code>targetUri</code>. If consent is only
requested for a single room, the requester includes the <code>roomId</code>. The
combination of the <code>requesterUri</code>, <code>targetUri</code>, and optional <code>roomId</code>
represents the <code>ConsentScope</code>. A <code>cancel</code> <span class="bcp14">MUST</span> use the same <code>ConsentScope</code>
as a previous <code>request</code>.<a href="#section-5.7-4" class="pilcrow">¶</a></p>
<p id="section-5.7-5">For a <code>requestContent</code>, the <code>targetUri</code> needs to be in one of the domains of
the receiving provider, and the <code>requesterUri</code> needs to be in one of the
domains of the sending provider.<a href="#section-5.7-5" class="pilcrow">¶</a></p>
<p id="section-5.7-6">The response to a <code>requestConsent</code> request is usually a 201 Accepted
(indicating the <code>requestConsent</code> was received), optionally a 404 Not Found
(indicating the <code>targetUri</code> is unknown), or a 500-class response. The
201 response code merely indicates that the request was received. A provider
that does not wish to reveal if a user is not found can respond with a 201
Accepted. Likewise in response to a <code>cancel</code> which has no <code>request</code> matching the
<code>ConsentScope</code>, a 201 Accepted is sent and no further action is taken.<a href="#section-5.7-6" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.7-7">
<pre>
enum {
  cancel(0),
  request(1),
  grant(2),
  revoke(3),
  (255)
} ConsentOperation;

struct {
  ConsentOperation consentOperation;
  IdentifierUri requesterUri;
  IdentifierUri targetUri;
  optional&lt;RoomId&gt; roomId;
  select (consentOperation) {
      case grant:
          KeyPackage clientKeyPackages&lt;V&gt;;
  };
} ConsentEntry;

struct {
  IdentifierUri requesterUri;
  IdentifierUri targetUri;
  optional&lt;RoomId&gt; roomId;
} ConsentScope;
</pre><a href="#section-5.7-7" class="pilcrow">¶</a>
</div>
<p id="section-5.7-8">An <code>updateConsent</code> request is used by one provider to provide explicit
notice from a target user at one provider that consent for a specific
"requester" was granted, revoked, or preemptively denied. In this context,
the requester is the party that will later request KeyPackages for the target. The request body is
a <code>ConsentEntry</code>, with a <code>consentOperation</code> of <code>grant</code> (for a grant), or
<code>revoke</code> for revocation or denial. Like a request, it includes the URI of the
"requesting user" in the <code>requesterUri</code> and the target user URI in the
<code>targetUri</code>. If consent is only granted or denied for a single room, the request includes the optional <code>roomId</code>.<a href="#section-5.7-8" class="pilcrow">¶</a></p>
<p id="section-5.7-9">A <code>grant</code> or <code>revoke</code> does not need to be in response to an explicit request, nor does the <code>ConsentScope</code> need to match a previous <code>request</code> for the same <code>targetUri</code> and <code>requesterUri</code> pair.<a href="#section-5.7-9" class="pilcrow">¶</a></p>
<p id="section-5.7-10">For example, in some systems there is a notion of a bilateral connection
request. The party that initiates the connection request (for example Alice)
would send a <code>requestConsent</code> for the target (ex: Bob), and send an
unsolicited <code>updateConsent</code> with Bob as the "requestor" and itself (Alice)
as the target.<a href="#section-5.7-10" class="pilcrow">¶</a></p>
<p id="section-5.7-11">In a <code>grant</code>, the sender includes a list of <code>clientKeyPackages</code> for the
target user, which can be empty. For the case of a bilateral connection,
a grant of consent with a matching <code>ConsentScope</code> often results in an
immediate Add to a group. If the list is non-empty this reduces the
number of messages which need to be sent.<a href="#section-5.7-11" class="pilcrow">¶</a></p>
<p id="section-5.7-12">For <code>updateConsent</code> the <code>requesterUri</code> needs to be in one of the domains of
the receiving provider, and the <code>targetUri</code> needs to be in one of the
domains of the sending provider.<a href="#section-5.7-12" class="pilcrow">¶</a></p>
<p id="section-5.7-13">The response to an <code>updateConsent</code> is usually a 201 Accepted (indicating
the <code>updateConsent</code> was received), optionally a 404 Not Found (indicating the
<code>requesterUri</code> is unknown), or a 500-class response. The response code
merely indicates that the request was received. A provider that does not
wish to reveal if a user is not found can respond with a 201 Accepted.<a href="#section-5.7-13" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.7-14.1">
            <p id="section-5.7-14.1.1"><strong>NOTE</strong>: Revoking consent for a user might be privacy sensitive. If this
is the case the target provider does not need to send a <code>revoke</code> to inform
the requester provider.<a href="#section-5.7-14.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="find-internal-address">
<section id="section-5.8">
        <h3 id="name-find-internal-address">
<a href="#section-5.8" class="section-number selfRef">5.8. </a><a href="#name-find-internal-address" class="section-name selfRef">Find internal address</a>
        </h3>
<p id="section-5.8-1">The identifier query is to find the internal URI for a specific user on a
specific provider. It is only sent from the local provider to the target
provider (it does not transit a hub).<a href="#section-5.8-1" class="pilcrow">¶</a></p>
<p id="section-5.8-2">Note that this POST request is
idempotent and safe in the sense defined by <span><a href="https://rfc-editor.org/rfc/rfc9110#section-9.2.2" class="relref">Section 9.2.2</a> of [<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>.<a href="#section-5.8-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.8-3">
<pre>
POST /identifierQuery/{domain}
</pre><a href="#section-5.8-3" class="pilcrow">¶</a>
</div>
<p id="section-5.8-4">Consider three users Xavier, Yolanda, and Zach all with accounts on provider
XYZ. Xavier is a sales person and wants to be contactable easily by
potential clients on the XYZ provider. He configures his profile on XYZ so
that searching for his first or last name or handle will find his profile
and allow Alice to send him a consent request (it is out of scope how
Alice verifies she has found the intended Xavier and not a different
Xavier or an impostor).
Yolanda has her XYZ handle on her business cards and the email signature
she uses with clients. She configures her profile so that a query for her
exact handle will find her profile and allow Alice to send her a consent
request. Zach does not wish to be queryable at all. He has configured his
account so even an exact handle search returns no results. He could still
send a join link out-of-band to Alice for her to join a room of Zach's
choosing.<a href="#section-5.8-4" class="pilcrow">¶</a></p>
<p id="section-5.8-5">The request body is described as below. Each request can contain multiple
query elements, which all have to match for the request to match (AND
semantics). For example matching both the OpenID Connect (OIDC) <span>[<a href="#OidcCore" class="cite xref">OidcCore</a>]</span>
          <code>given_name</code> and <code>family_name</code>, or matching the OIDC <code>given_name</code> and the
organization (from the vCard <span>[<a href="#RFC6350" class="cite xref">RFC6350</a>]</span> ORG property).<a href="#section-5.8-5" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.8-6">
<pre>
enum {
  reserved(0),
  handle(1),
  nick(2),
  email(3),
  phone(4),
  partialName(5),
  wholeProfile(6),
  oidcStdClaim(7),
  vcardField(8),
  (255)
} SearchIdentifierType;

struct {
  SearchIdentifierType searchType;
  select(type) {
    case oidcStdClaim:
      opaque claimName&lt;V&gt;;
    case vcardField:
      opaque propertyName&lt;V&gt;;
  };
  opaque searchValue&lt;V&gt;;  /* a UTF8 string */
} QueryElement;

struct {
  QueryElement query_elements&lt;V&gt;;
} IdentifierRequest;
</pre><a href="#section-5.8-6" class="pilcrow">¶</a>
</div>
<p id="section-5.8-7">The semantics of the <code>SearchIdentifierType</code> values are as follows. <code>handle</code>
means that the entire handle URI matches exactly (for example: <code>im:alice.smith@a.example</code>). <code>nick</code> means that the nickname or handle
user part matches exactly (for example: <code>alice.smith</code>). The same account or
human user may have multiple values which all match the <code>nick</code> field. <code>email</code>
means the <code>addr-spec</code> production from <span>[<a href="#RFC5322" class="cite xref">RFC5322</a>]</span> matches the query string
exactly, for example (<code>asmith@a.example</code>). <code>phone</code> means the international
format of a telephone number with the "+" prefix matches exactly (for example:
<code>+12125551212</code>).<a href="#section-5.8-7" class="pilcrow">¶</a></p>
<p id="section-5.8-8"><code>partialName</code> means that the query string matches a case-insensitive substring
of any field which contains the name of a (usually human) user. For example,
<code>mat</code> would match first (given) or middle names Matt, Matthew, Mathias, or
Mathieu and last (family) names of Mather and Matali. <code>wholeProfile</code> means that
the query string matches a substring of any searchable field in
a user's profile.<a href="#section-5.8-8" class="pilcrow">¶</a></p>
<p id="section-5.8-9"><code>oidcStdClaim</code> means that the query string exactly matches the specified
UserInfo Standard Claim (defined in Section 5.1 of <span>[<a href="#OidcCore" class="cite xref">OidcCore</a>]</span>).
<code>vcardField</code> means that the query string exactly matches the specified vCard
property listed in the vCard Properties IANA registry.<a href="#section-5.8-9" class="pilcrow">¶</a></p>
<p id="section-5.8-10">As noted above, searches only return results for a user when the fields searched
are searchable according the user's and provider's search policies.<a href="#section-5.8-10" class="pilcrow">¶</a></p>
<p id="section-5.8-11">The response body is described as an <code>IdentifierResponse</code>. It can contain
multiple matches depending on the type of query and the policy of the target
provider.<a href="#section-5.8-11" class="pilcrow">¶</a></p>
<p id="section-5.8-12">The response contains a code indicating the status of the query. <code>success</code>
means that at least one result matched the query. <code>notFound</code> means that
while the request was acceptable, no results matched the query.
<code>ambiguous</code> means that a field (ex: handle) or combination of fields
(ex: first and last name) need to match exactly for the provider to return
any responses. <code>forbidden</code> means that use of this endpoint is not allowed
by the provider or that an unspecified field or combination of fields is
not allowed in an identifier query. <code>unsupportedField</code> means that the
provider does not support queries on one of the fields queried.<a href="#section-5.8-12" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.8-13">
<pre>
enum {
  success(0),
  notFound(1),
  ambiguous(2),
  forbidden(3),
  unsupportedField(4),
  (255)
} IdentifierQueryCode;

enum {
  reserved(0),
  oidcStdClaim(7),
  vcardField(8),
  (255)
} FieldSource;

struct {
  FieldSource fieldSource;
  string fieldName;
  opaque fieldValue&lt;V&gt;;
} ProfileField;

struct {
  IdentifierUri stableUri;
  ProfileField fields&lt;V&gt;;
} UserProfile;

struct {
  IdentifierQueryCode responseCode;
  IdentifierUri uri&lt;V&gt;;
  UserProfile foundProfiles&lt;V&gt;;
} IdentifierResponse;
</pre><a href="#section-5.8-13" class="pilcrow">¶</a>
</div>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.8-14.1">
            <p id="section-5.8-14.1.1"><strong>TODO</strong>: The format of specific identifiers is discussed in
<span>[<a href="#I-D.mahy-mimi-identity" class="cite xref">I-D.mahy-mimi-identity</a>]</span>. Any specific conventions which are needed
should be merged into this document.<a href="#section-5.8-14.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="report-abuse">
<section id="section-5.9">
        <h3 id="name-report-abuse">
<a href="#section-5.9" class="section-number selfRef">5.9. </a><a href="#name-report-abuse" class="section-name selfRef">Report abuse</a>
        </h3>
<p id="section-5.9-1">Abuse reports are only sent to the hub provider. They are sent as an HTTP
POST request.<a href="#section-5.9-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.9-2">
<pre>
POST /reportAbuse/{roomId}
</pre><a href="#section-5.9-2" class="pilcrow">¶</a>
</div>
<p id="section-5.9-3">The <code>reportingUser</code> optionally contains the identity of the user sending the
<code>abuseReport</code>, while the <code>allegedAbuserUri</code> contains the URI of the alleged
sender of abusive messages. The <code>reasonCode</code> is reserved to identify the type of
abuse, and the <code>note</code> is a UTF8 human-readable string, which can be empty.<a href="#section-5.9-3" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-5.9-4.1">
            <p id="section-5.9-4.1.1"><strong>TODO</strong>: Find a standard taxonomy of reason codes to reference for
the <code>AbuseType</code>. The IANA Messaging Abuse Report Format parameters are
insufficient.<a href="#section-5.9-4.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-5.9-5">Finally, abuse reports can optionally contain a handful of allegedly
<code>AbusiveMessage</code>s, each of which contains an allegedly abusive message, its franks, and its timestamp.<a href="#section-5.9-5" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-5.9-6">
<pre>
struct {
  /* the MIMI Content message containing */
  /* alleged abusive content */
  opaque mimi_content&lt;V&gt;;
  Frank frank;
  uint64 acceptedTimestamp;
} AbusiveMessage;

enum {
  reserved(0),
  (255)
} AbuseType;

struct {
  IdentifierUri reportingUser;
  IdentifierUri allegedAbuserUri;
  AbuseType reasonCode;
  opaque note&lt;V&gt;;
  AbusiveMessage messages&lt;V&gt;;
} AbuseReport;
</pre><a href="#section-5.9-6" class="pilcrow">¶</a>
</div>
<p id="section-5.9-7">There is no response body. The response code only indicates if the abuse report was accepted, not if any specific automated or human action was taken.<a href="#section-5.9-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="minimal-metadata-rooms">
<section id="section-6">
      <h2 id="name-minimal-metadata-rooms">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-minimal-metadata-rooms" class="section-name selfRef">Minimal metadata rooms</a>
      </h2>
<p id="section-6-1">The room state is visible to the hub and with it the room's participant list,
giving the hub access to a significant amount of user metadata.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">To limit the amount of metadata the hub has access to, rooms can be created as
<em>minimal metadata rooms</em> (MMR). In an MMR the participant list and the
credentials in the room's underlying MLS group consist only of pseudonyms. The
real identifiers are stored alongside the pseudonyms encrypted under a key known
only to room participants, but not the hub.<a href="#section-6-2" class="pilcrow">¶</a></p>
<p id="section-6-3">MMRs requires some additional key management, which leads to restrictions in how
the MMR can be joined and which users each participant can add to the room.<a href="#section-6-3" class="pilcrow">¶</a></p>
<div id="credential-encryption">
<section id="section-6.1">
        <h3 id="name-credential-encryption">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-credential-encryption" class="section-name selfRef">Credential encryption</a>
        </h3>
<p id="section-6.1-1">Identifiers of participants and their clients occur in two locations in a room's
state: the participant list and the credentials of the room's underlying MLS
group. In an MMR, the real identifiers of clients and users are replaced by
pseudonyms in the shape of random UUIDs qualified with the domain of the user's
provider.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<p id="section-6.1-2">In MMRs, all leaves of the underlying group <span class="bcp14">MUST</span> contain PseudonymousCredentials.<a href="#section-6.1-2" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-6.1-3">
<pre>
struct {
  IdentifierUri client_pseudonym;
  IdentifierUri user_pseudonym;
  opaque signature_public_key;
  opaque identity_link_ciphertext&lt;V&gt;;
} PseudonymousCredential
</pre><a href="#section-6.1-3" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-6.1-4.1">
            <p id="section-6.1-4.1.1"><code>user_pseudonym</code>: The pseudonym of the client's user in this group<a href="#section-6.1-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.1-4.2">
            <p id="section-6.1-4.2.1"><code>client_pseudonym</code>: The pseudonym of the client identified by this credential<a href="#section-6.1-4.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.1-4.3">
            <p id="section-6.1-4.3.1"><code>signature_public_key</code>: The signature public key used to authenticate MLS
messages<a href="#section-6.1-4.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.1-4.4">
            <p id="section-6.1-4.4.1"><code>identity_link_ciphertext</code>: A ciphertext containing a credential with the
clients real identifier<a href="#section-6.1-4.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.1-5">In any given room, the <code>user_pseudonym</code> of a client <span class="bcp14">MUST</span> be the same across all
clients of a user and it <span class="bcp14">MUST</span> be the same as the user's entry in the participant
list.<a href="#section-6.1-5" class="pilcrow">¶</a></p>
<div class="lang-tls sourcecode" id="section-6.1-6">
<pre>
struct {
  IdentifierUri client_pseudonym;
  IdentifierUri user_pseudonym;
  opaque signature_public_key;
} PseudonymousCredentialTBS

struct {
  /* SignWithLabel(., "PseudonymousCredentialTBS",
    PseudonymousCredentialTBS) */
  opaque pseudonymous_credential_signature&lt;V&gt;;
  Credential client_credential;
} IdentityLinkTBE
</pre><a href="#section-6.1-6" class="pilcrow">¶</a>
</div>
<p id="section-6.1-7">The <code>identity_link_ciphertext</code> is created by encrypting the IdentityLinkTBE.
The IdentityLinkTBE contains the client's real credential, and a signature over the
PseudonymousCredentialTBS signed with the client credential's <code>signature_public_key</code>.<a href="#section-6.1-7" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-6.1-8.1">
            <p id="section-6.1-8.1.1"><strong>TODO</strong>: Specify a key management scheme that ideally
- is efficient
- allows the basic MIMI flows
- ensures that all participants can learn the identities of all other
  participants at all times
- provides FS and PCS w.r.t. metadata hiding<a href="#section-6.1-8.1.1" class="pilcrow">¶</a></p>
<p id="section-6.1-8.1.2">There are several options that represent different trade-offs, but are not yet
fully specified. They will be added at a later date.<a href="#section-6.1-8.1.2" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="relation-between-mimi-state-and-cryptographic-state">
<section id="section-7">
      <h2 id="name-relation-between-mimi-state">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-relation-between-mimi-state" class="section-name selfRef">Relation between MIMI state and cryptographic state</a>
      </h2>
<div id="room-state">
<section id="section-7.1">
        <h3 id="name-room-state">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-room-state" class="section-name selfRef">Room state</a>
        </h3>
<p id="section-7.1-1">The state of a room consists of its room ID, its base policy, its
participant list (including the role and participation state of each
participant), and the associated end-to-end protocol state (its MLS group
state) that anchors the room state cryptographically.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1-2">While all parties involved in a room agree on the room's state during a
specific epoch, the Hub is the arbiter that decides if a state change is valid,
consistent with the room's then-current policy. All state-changing events are
sent to the Hub and checked for their validity and policy conformance, before
they are forwarded to any follower servers or local clients.<a href="#section-7.1-2" class="pilcrow">¶</a></p>
<p id="section-7.1-3">As soon as the Hub accepts an event that changes the room state, its effect is
applied to the room state and future events are validated in the context of that
new state.<a href="#section-7.1-3" class="pilcrow">¶</a></p>
<p id="section-7.1-4">The room state is thus changed based on events, even if the MLS proposal
implementing the event was not yet committed by a client. Note that this only
applies to events changing the room state.<a href="#section-7.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="cryptographic-room-representation">
<section id="section-7.2">
        <h3 id="name-cryptographic-room-represen">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-cryptographic-room-represen" class="section-name selfRef">Cryptographic room representation</a>
        </h3>
<p id="section-7.2-1">Each room is represented cryptographically by an MLS group. The Hub that
manages the room also manages the list of group members, i.e. the
list of clients belonging to users currently in the room. Application state
that is stored in the MLS GroupContext is stored as application components
in the <code>app_data_dictionary</code> extension, as described in <span><a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-extensions-06#section-4.6" class="relref">Section 4.6</a> of [<a href="#I-D.ietf-mls-extensions" class="cite xref">I-D.ietf-mls-extensions</a>]</span>.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="proposal-commit-paradigm">
<section id="section-7.3">
        <h3 id="name-proposal-commit-paradigm">
<a href="#section-7.3" class="section-number selfRef">7.3. </a><a href="#name-proposal-commit-paradigm" class="section-name selfRef">Proposal-commit paradigm</a>
        </h3>
<p id="section-7.3-1">The MLS protocol follows a proposal-commit paradigm. Any
party involved in a room (follower server, Hub or clients) can send proposals
(e.g. to add/remove/update clients of a user or to re-initialize the group with
different parameters). However, only clients can send commits, which contain all
valid previously sent proposals and apply them to the MLS group state.<a href="#section-7.3-1" class="pilcrow">¶</a></p>
<p id="section-7.3-2">The MIMI usage of MLS ensures that the Hub, all follower servers and the clients
of all active participants agree on the group state, which includes the client
list and the key material used for message encryption (although the latter is
only available to clients). Since the group state also includes a copy of the
room state at the time of the most recent commit, it is also covered by the
agreement.<a href="#section-7.3-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authenticating-proposals">
<section id="section-7.4">
        <h3 id="name-authenticating-proposals">
<a href="#section-7.4" class="section-number selfRef">7.4. </a><a href="#name-authenticating-proposals" class="section-name selfRef">Authenticating proposals</a>
        </h3>
<p id="section-7.4-1">MLS requires that MLS proposals from the Hub and
from follower servers (external senders in MLS terminology) be authenticated
using key material contained in the <code>external_senders</code> extension of the MLS
group. Each MLS group associated with a MIMI room <span class="bcp14">MUST</span> therefore contain an
<code>external_senders</code> extension. That extension <span class="bcp14">MUST</span> contain at least the
Certificate of the Hub.<a href="#section-7.4-1" class="pilcrow">¶</a></p>
<p id="section-7.4-2">When a user from a follower server becomes a participant in the room, the
Certificate of the follower server <span class="bcp14">MAY</span> be added to the extension. When the last
participant belonging to a follower server leaves the room, the certificate of
that user <span class="bcp14">MUST</span> be removed from the list. Changes to the <code>external_senders</code>
extension only take effect when the MLS proposal containing the event is
committed by a MIMI commit.<a href="#section-7.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="participant-list">
<section id="section-7.5">
        <h3 id="name-participant-list">
<a href="#section-7.5" class="section-number selfRef">7.5. </a><a href="#name-participant-list" class="section-name selfRef">Participant List</a>
        </h3>
<p id="section-7.5-1">The participant list is a list of "users" in a room. Within a room, each user
is assigned exactly one <em>role</em> (expressed with a <code>role_index</code> and described
in <span>[<a href="#I-D.ietf-mimi-room-policy" class="cite xref">I-D.ietf-mimi-room-policy</a>]</span> at any given time (specifically within any MLS
epoch). In a room that has multiple MLS clients per "user", the identifier for
each user in <code>participants.user</code> is the same across all that user's clients in
the room. Note that each user has a single role at any point in time, and
therefore all clients of the same user also have the same role.<a href="#section-7.5-1" class="pilcrow">¶</a></p>
<p id="section-7.5-2">The participant list may include inactive participants, which currently do not
have any clients in the corresponding MLS group, for example if their clients
do not have available KeyPackages or if all of their clients are temporarily
"kicked" out of the group. The participant list can also contain participants
that are explicitly banned, by assigning them a suitable role which does not
have any capabilities.<a href="#section-7.5-2" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-7.5-3">
<pre>
struct {
  opaque user&lt;V&gt;;
  uint32 role_index;
} UserRolePair;

struct {
  UserRolePair participants&lt;V&gt;;
} ParticipantListData;
</pre><a href="#section-7.5-3" class="pilcrow">¶</a>
</div>
<p id="section-7.5-4">ParticipantListData is the format of the <code>data</code> field inside the ComponentData
struct for the Participant list Metadata component in the <code>app_data_dictionary</code>
GroupContext extension.<a href="#section-7.5-4" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-7.5-5">
<pre>
struct {
  uint32 user_index;
  uint32 role_index;
} UserindexRolePair;

struct {
  UserindexRolePair changedRoleParticipants&lt;V&gt;
  uint32 removedIndices&lt;V&gt;;
  UserRolePair addedParticipants&lt;V&gt;;
} ParticipantListUpdate;
</pre><a href="#section-7.5-5" class="pilcrow">¶</a>
</div>
<p id="section-7.5-6">ParticipantListUpdate is the contents of an AppDataUpdate Proposal with the
component ID for the participant list. The index of the <code>participants</code> vector
in the current <code>ParticipantListData</code> struct is referenced as the <code>user_index</code>
when making changes. First the <code>changedRoleParticipants</code> list contains
<code>UserindexRolePair</code>s with the index of a user who changed roles and their new
role. Next is the <code>removedIndices</code> list which has a list of users to remove
completely from the participant list. Finally there is a list of
<code>addedParticipants</code> (which contains a user and role) that is appended to the
end of the <code>ParticipantListData</code>.<a href="#section-7.5-6" class="pilcrow">¶</a></p>
<p id="section-7.5-7">Each of these actions (modifying a user's role, removing a user, and adding a
user) is authorized separately according to the rules specified in
<span>[<a href="#I-D.ietf-mimi-room-policy" class="cite xref">I-D.ietf-mimi-room-policy</a>]</span>. If all the changes are authorized, the
<code>ParticipantListData</code> is modified accordingly.<a href="#section-7.5-7" class="pilcrow">¶</a></p>
<p id="section-7.5-8">A single commit is not valid if it contain any combination of Participant list
updates that operate on (add, remove, or change the role of) the same user in
the participant list more than once.<a href="#section-7.5-8" class="pilcrow">¶</a></p>
</section>
</div>
<div id="room-metadata">
<section id="section-7.6">
        <h3 id="name-room-metadata">
<a href="#section-7.6" class="section-number selfRef">7.6. </a><a href="#name-room-metadata" class="section-name selfRef">Room Metadata</a>
        </h3>
<p id="section-7.6-1">The Room Metadata component contains data about a room which might be displayed
as human-readable information for the room, such as the name of the room and a
URL pointing to its room image/avatar.<a href="#section-7.6-1" class="pilcrow">¶</a></p>
<p id="section-7.6-2">It can contain a list of <code>room_descriptions</code>, each of which can have a specific
<code>language_tag</code> and <code>media_type</code> along with the <code>description_content</code>. An empty
<code>media_type</code> implies <code>text/plain;charset=utf-8</code>.<a href="#section-7.6-2" class="pilcrow">¶</a></p>
<p id="section-7.6-3">RoomMetaData is the format of the <code>data</code> field inside the ComponentData struct
for the Room Metadata component in the <code>app_data_dictionary</code> GroupContext
extension.<a href="#section-7.6-3" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-7.6-4">
<pre>
/* a valid URI (ex: MIMI URI) */
struct {
  opaque uri&lt;V&gt;;
} Uri;

/* a sequence of valid UTF8 without nulls */
struct {
  opaque string&lt;V&gt;;
} UTF8String;

struct {
  /* an empty media_type is equivalent to text/plain;charset=utf-8 */
  opaque media_type&lt;V&gt;;
  opaque language_tag&lt;V&gt;;
  opaque description_content&lt;V&gt;;
} RichDescription;

struct {
  Uri room_uri;
  UTF8String room_name;
  RichDescription room_descriptions&lt;V&gt;;
  /* an https URI resolving to an avatar image */
  Uri room_avatar;
  UTF8String room_subject;
  UTF8String room_mood;
} RoomMetaData;

RoomMetaData RoomMetaUpdate;
</pre><a href="#section-7.6-4" class="pilcrow">¶</a>
</div>
<p id="section-7.6-5">RoomMetaUpdate (which has the same format as RoomMetaData) is the format of the
<code>update</code> field inside the AppDataUpdate struct in an AppDataUpdate Proposal for
the Room Metadata component.
If the contents of the <code>update</code> field are valid and if the proposer is
authorized to generate such an update, the value of the <code>update</code> field
completely replaces the value of the <code>data</code> field.<a href="#section-7.6-5" class="pilcrow">¶</a></p>
<p id="section-7.6-6">Only a single Room metadata update is valid per commit.<a href="#section-7.6-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="consent">
<section id="section-8">
      <h2 id="name-consent">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-consent" class="section-name selfRef">Consent</a>
      </h2>
<p id="section-8-1">Most instant messaging systems have some notion of how a user consents to be
added to a room, and how they manipulate this consent.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">In the connection-oriented model, once two users are connected, either user
can add the other to any number of rooms. In other systems (often with many
large and/or public rooms), a user needs to consent individually to be added
to a room.<a href="#section-8-2" class="pilcrow">¶</a></p>
<p id="section-8-3">The MIMI consent mechanism supports both models and allows them to coexist.
It allows a user to request consent, grant consent, revoke consent, and
cancel a request for consent. Each of these consent operations can indicate
a specific room, or indicate any room.<a href="#section-8-3" class="pilcrow">¶</a></p>
<p id="section-8-4">A connection grant or revoke does not need to specify a room if a connection
request did, or vice versa. A connection grant or revoke does not even need
to follow a connection request.<a href="#section-8-4" class="pilcrow">¶</a></p>
<p id="section-8-5">For example, Alice could ask for consent to add Bob to a specific room. Bob
could send a connection grant for Alice to add him to any room, or a
connection revoke preventing Alice from adding him to any room. Similarly,
Alice might have sent a connection request to add Bob for any room (as a
connection request), which Bob ignored or did not see. Later, Bob wants to
join a specific room administered by Alice. Bob sends a connection grant for
the specific room for Alice and sends a Knock request to Alice asking to be
added. Finally, Cathy could send a connection grant for Bob (even if Bob did
not initiate a connection request to Cathy), and Alice could recognize Cathy
on the system and send a connection revoke for her preemptively.<a href="#section-8-5" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-8-6.1">
          <p id="section-8-6.1.1"><strong>NOTE</strong>: Many providers use additional factors to apply default consent
within their service such as a user belonging to a specific workgroup or
employer, participating in a related room (ex: WhatsApp "communities"), or
presence of a user in the other user's contact list. MIMI does not need to
provide a way to replicate or describe these supplemental mechanisms,
since they are strongly linked to specific provider policies.<a href="#section-8-6.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-8-7">Consent requests have sensitive privacy implications. The sender of a
consent request should receive an acknowledgement that the request was
received by the provider of the target user. For privacy reasons, the
requestor should not know if the target user received or viewed the request.
The original requestor will obviously find out if the target grants consent,
but a consent revocation/rejection is typically not communicated to the
revoked/rejected user (again for privacy reasons).<a href="#section-8-7" class="pilcrow">¶</a></p>
<p id="section-8-8">Consent operations are only sent directly between the acting provider
(sending the request, grant, revoke, or cancel) and the target provider (the
object of the consent). In other words, the two providers must have a direct
peering relationship.<a href="#section-8-8" class="pilcrow">¶</a></p>
<p id="section-8-9">In our example, Alice requests consent from Bob for any room. Later, Bob
sends a grants consent to Alice to add him to any room. At the same time as
sending the consent request, Alice grants consent to Bob to add her to any
room.<a href="#section-8-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-9">
      <h2 id="name-security-considerations">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-9-1.1">
          <p id="section-9-1.1.1"><strong>TODO</strong>: Add MIMI threat model, and great expand this section.<a href="#section-9-1.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-9-2">The MIMI protocol incorporates several layers of security.<a href="#section-9-2" class="pilcrow">¶</a></p>
<p id="section-9-3">Individual protocol actions are protected against network attackers with
mutually-authenticated TLS, where the TLS certificates authenticate the
identities that the protocol actors assert at the application layer.<a href="#section-9-3" class="pilcrow">¶</a></p>
<p id="section-9-4">Messages and room state changes are protected end-to-end using MLS.  The
protection is "end-to-end" in the sense that messages sent within the group are
confidentiality-protected against all servers involved in the delivery of those
messages, and in the sense that the authenticity of room state changes is
verified by the end clients involved in the room.  The usage of MLS ensures that
the servers facilitating the exchange cannot read messages in the room or
falsify room state changes, even though they can read the room state change
messages.<a href="#section-9-4" class="pilcrow">¶</a></p>
<p id="section-9-5">Each room has an authorization policy that dictates which protocol actors can
perform which actions in the room.  This policy is enforced by the hub server
for the room.  The actors for whom the policy is being evaluated authenticate
their identities to the hub server using the MLS PublicMessage signed object
format, together with the identity credentials presented in MLS.  This design
means that the hub is trusted to correctly enforce the room's policy, but this
cost is offset by the simplicity of not having multiple policy enforcement points.<a href="#section-9-5" class="pilcrow">¶</a></p>
<div id="franking">
<section id="section-9.1">
        <h3 id="name-franking">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-franking" class="section-name selfRef">Franking</a>
        </h3>
<p id="section-9.1-1">TBD.<a href="#section-9.1-1" class="pilcrow">¶</a></p>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-9.1-2.1">
            <p id="section-9.1-2.1.1"><strong>TODO</strong>: Present the franking mechanism to CFRG for review.<a href="#section-9.1-2.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-10">
      <h2 id="name-iana-considerations">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-10-1.1">
          <p id="section-10-1.1.1"><strong>TODO</strong>: Add registration of MIMI content format extension, and a SafeAAD
component.<a href="#section-10-1.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="sec-combined-references">
<section id="section-11">
      <h2 id="name-references">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-11.1">
        <h3 id="name-normative-references">
<a href="#section-11.1" class="section-number selfRef">11.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="I-D.barnes-mimi-arch">[I-D.barnes-mimi-arch]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refTitle">"An Architecture for More Instant Messaging Interoperability (MIMI)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-barnes-mimi-arch-03</span>, <time datetime="2024-03-04" class="refDate">4 March 2024</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-03">https://datatracker.ietf.org/doc/html/draft-barnes-mimi-arch-03</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.barnes-mls-appsync">[I-D.barnes-mls-appsync]</dt>
        <dd>
<span class="refAuthor">Joël</span>, <span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Mahy, R.</span>, and <span class="refAuthor">M. Mularczyk</span>, <span class="refTitle">"A Safe Application Interface to Messaging Layer Security"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-barnes-mls-appsync-01</span>, <time datetime="2024-12-12" class="refDate">12 December 2024</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-barnes-mls-appsync-01">https://datatracker.ietf.org/doc/html/draft-barnes-mls-appsync-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-mimi-content">[I-D.ietf-mimi-content]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"More Instant Messaging Interoperability (MIMI) message content"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mimi-content-06</span>, <time datetime="2025-02-28" class="refDate">28 February 2025</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mimi-content-06">https://datatracker.ietf.org/doc/html/draft-ietf-mimi-content-06</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-mimi-room-policy">[I-D.ietf-mimi-room-policy]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"Room Policy for the More Instant Messaging Interoperability (MIMI) Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mimi-room-policy-01</span>, <time datetime="2025-03-02" class="refDate">2 March 2025</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mimi-room-policy-01">https://datatracker.ietf.org/doc/html/draft-ietf-mimi-room-policy-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-mls-extensions">[I-D.ietf-mls-extensions]</dt>
        <dd>
<span class="refAuthor">Robert, R.</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Extensions"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-mls-extensions-06</span>, <time datetime="2025-02-19" class="refDate">19 February 2025</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-extensions-06">https://datatracker.ietf.org/doc/html/draft-ietf-mls-extensions-06</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.kohbrok-mls-associated-parties">[I-D.kohbrok-mls-associated-parties]</dt>
        <dd>
<span class="refAuthor">Kohbrok, K.</span> and <span class="refAuthor">R. Robert</span>, <span class="refTitle">"MLS Associated parties"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-kohbrok-mls-associated-parties-00</span>, <time datetime="2024-10-21" class="refDate">21 October 2024</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-kohbrok-mls-associated-parties-00">https://datatracker.ietf.org/doc/html/draft-kohbrok-mls-associated-parties-00</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mahy-mls-ratchet-tree-options">[I-D.mahy-mls-ratchet-tree-options]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"Ways to convey the Ratchet Tree in Messaging Layer Security"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mahy-mls-ratchet-tree-options-01</span>, <time datetime="2024-10-20" class="refDate">20 October 2024</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-mahy-mls-ratchet-tree-options-01">https://datatracker.ietf.org/doc/html/draft-mahy-mls-ratchet-tree-options-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mahy-mls-semiprivatemessage">[I-D.mahy-mls-semiprivatemessage]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"Semi-Private Messages in the Messaging Layer Security (MLS) Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mahy-mls-semiprivatemessage-04</span>, <time datetime="2024-10-20" class="refDate">20 October 2024</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-mahy-mls-semiprivatemessage-04">https://datatracker.ietf.org/doc/html/draft-mahy-mls-semiprivatemessage-04</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="OidcCore">[OidcCore]</dt>
        <dd>
<span class="refAuthor">Sakimura, N.</span>, <span class="refAuthor">Bradley, J.</span>, <span class="refAuthor">Jones, M. B.</span>, <span class="refAuthor">Medeiros, B. de.</span>, and <span class="refAuthor">C. Mortimore</span>, <span class="refTitle">"OpenID Connect Core 1.0 incorporating errata set 2"</span>, <time datetime="2023-12-15" class="refDate">15 December 2023</time>, <span>&lt;<a href="https://openid.net/specs/openid-connect-core-1_0.html">https://openid.net/specs/openid-connect-core-1_0.html</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3986">[RFC3986]</dt>
        <dd>
<span class="refAuthor">Berners-Lee, T.</span>, <span class="refAuthor">Fielding, R.</span>, and <span class="refAuthor">L. Masinter</span>, <span class="refTitle">"Uniform Resource Identifier (URI): Generic Syntax"</span>, <span class="seriesInfo">STD 66</span>, <span class="seriesInfo">RFC 3986</span>, <span class="seriesInfo">DOI 10.17487/RFC3986</span>, <time datetime="2005-01" class="refDate">January 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc3986">https://www.rfc-editor.org/rfc/rfc3986</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5322">[RFC5322]</dt>
        <dd>
<span class="refAuthor">Resnick, P., Ed.</span>, <span class="refTitle">"Internet Message Format"</span>, <span class="seriesInfo">RFC 5322</span>, <span class="seriesInfo">DOI 10.17487/RFC5322</span>, <time datetime="2008-10" class="refDate">October 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5322">https://www.rfc-editor.org/rfc/rfc5322</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6125">[RFC6125]</dt>
        <dd>
<span class="refAuthor">Saint-Andre, P.</span> and <span class="refAuthor">J. Hodges</span>, <span class="refTitle">"Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 6125</span>, <span class="seriesInfo">DOI 10.17487/RFC6125</span>, <time datetime="2011-03" class="refDate">March 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6125">https://www.rfc-editor.org/rfc/rfc6125</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC6350">[RFC6350]</dt>
        <dd>
<span class="refAuthor">Perreault, S.</span>, <span class="refTitle">"vCard Format Specification"</span>, <span class="seriesInfo">RFC 6350</span>, <span class="seriesInfo">DOI 10.17487/RFC6350</span>, <time datetime="2011-08" class="refDate">August 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6350">https://www.rfc-editor.org/rfc/rfc6350</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7231">[RFC7231]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span> and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content"</span>, <span class="seriesInfo">RFC 7231</span>, <span class="seriesInfo">DOI 10.17487/RFC7231</span>, <time datetime="2014-06" class="refDate">June 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7231">https://www.rfc-editor.org/rfc/rfc7231</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9110">[RFC9110]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span>, <span class="refAuthor">Nottingham, M., Ed.</span>, and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"HTTP Semantics"</span>, <span class="seriesInfo">STD 97</span>, <span class="seriesInfo">RFC 9110</span>, <span class="seriesInfo">DOI 10.17487/RFC9110</span>, <time datetime="2022-06" class="refDate">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9110">https://www.rfc-editor.org/rfc/rfc9110</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9420">[RFC9420]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Beurdouche, B.</span>, <span class="refAuthor">Robert, R.</span>, <span class="refAuthor">Millican, J.</span>, <span class="refAuthor">Omara, E.</span>, and <span class="refAuthor">K. Cohn-Gordon</span>, <span class="refTitle">"The Messaging Layer Security (MLS) Protocol"</span>, <span class="seriesInfo">RFC 9420</span>, <span class="seriesInfo">DOI 10.17487/RFC9420</span>, <time datetime="2023-07" class="refDate">July 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9420">https://www.rfc-editor.org/rfc/rfc9420</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-11.2">
        <h3 id="name-informative-references">
<a href="#section-11.2" class="section-number selfRef">11.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="Grubbs2017">[Grubbs2017]</dt>
        <dd>
<span class="refAuthor">Grubbs, P.</span>, <span class="refAuthor">Lu, J.</span>, and <span class="refAuthor">T. Ristenpart</span>, <span class="refTitle">"Message Franking via Committing Authenticated Encryption"</span>, <time datetime="2017" class="refDate">2017</time>, <span>&lt;<a href="https://eprint.iacr.org/2017/664.pdf">https://eprint.iacr.org/2017/664.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mahy-mimi-identity">[I-D.mahy-mimi-identity]</dt>
        <dd>
<span class="refAuthor">Mahy, R.</span>, <span class="refTitle">"More Instant Messaging Interoperability (MIMI) Identity Concepts"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mahy-mimi-identity-02</span>, <time datetime="2023-07-10" class="refDate">10 July 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-mahy-mimi-identity-02">https://datatracker.ietf.org/doc/html/draft-mahy-mimi-identity-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="InvisibleSalamanders">[InvisibleSalamanders]</dt>
        <dd>
<span class="refAuthor">Dodis, Y.</span>, <span class="refAuthor">Grubbs, P.</span>, <span class="refAuthor">Ristenpart, T.</span>, and <span class="refAuthor">J. Woodage</span>, <span class="refTitle">"Fast Message Franking: From Invisible Salamanders to Encryptment"</span>, <time datetime="2018" class="refDate">2018</time>, <span>&lt;<a href="https://link.springer.com/content/pdf/10.1007/978-3-319-96884-1_6.pdf">https://link.springer.com/content/pdf/10.1007/978-3-319-96884-1_6.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8555">[RFC8555]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Hoffman-Andrews, J.</span>, <span class="refAuthor">McCarney, D.</span>, and <span class="refAuthor">J. Kasten</span>, <span class="refTitle">"Automatic Certificate Management Environment (ACME)"</span>, <span class="seriesInfo">RFC 8555</span>, <span class="seriesInfo">DOI 10.17487/RFC8555</span>, <time datetime="2019-03" class="refDate">March 2019</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8555">https://www.rfc-editor.org/rfc/rfc8555</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SecretConversations">[SecretConversations]</dt>
      <dd>
<span class="refAuthor">Facebook</span>, <span class="refTitle">"Messenger Secret Conversations: Technical Whitepaper, Version 2.0"</span>, <time datetime="2017-05-18" class="refDate">18 May 2017</time>, <span>&lt;<a href="https://about.fb.com/wp-content/uploads/2016/07/messenger-secret-conversations-technical-whitepaper.pdf">https://about.fb.com/wp-content/uploads/2016/07/messenger-secret-conversations-technical-whitepaper.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="acknowledgments">
<section id="appendix-A">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="appendix-A-1">Thanks to Paul Grubs, Jon Millican, and Julia Len for their reviews of the
franking mechanism and suggested changes.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Richard L. Barnes</span></div>
<div dir="auto" class="left"><span class="org">Cisco</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rlb@ipv.sx" class="email">rlb@ipv.sx</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Matthew Hodgson</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:matthew@matrix.org" class="email">matthew@matrix.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Konrad Kohbrok</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:konrad.kohbrok@datashrine.de" class="email">konrad.kohbrok@datashrine.de</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Rohan Mahy</span></div>
<div dir="auto" class="left"><span class="org">Rohan Mahy Consulting Services</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:rohan.ietf@gmail.com" class="email">rohan.ietf@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Travis Ralston</span></div>
<div dir="auto" class="left"><span class="org">The Matrix.org Foundation C.I.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:travisr@matrix.org" class="email">travisr@matrix.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@raphaelrobert.com" class="email">ietf@raphaelrobert.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
